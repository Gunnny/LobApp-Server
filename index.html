<!DOCTYPE html>
<html lang="de">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOB APP</title>

    <link href="https://fonts.googleapis.com/css2?family=Varela+Round:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --bg: #0d0d0d;
            --surface: #1a1a1a;
            --surface-light: #2a2a2a;
            --primary: #ff4d6d;
            /* Leuchtendes Rot/Pink */
            --primary-glow: rgba(255, 77, 109, 0.4);
            --accent: #f72585;
            /* Dunkleres Magenta */
            --text: #ffffff;
            --text-muted: #888888;
            --danger: #ff7675;
            --transition-speed: 0.2s;
        }

        /* --- WICHTIG: BEHEBUNG DES SCROLL-PROBLEMS --- */
        html,
        body {
            height: 100%;
            /* Wichtig für korrekte Höhe */
            font-family: 'Varela Round', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            /* Erlaube Scrollen auf Body-Ebene */
            -webkit-tap-highlight-color: transparent;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='1.5' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes subtlePulse {
            0% {
                box-shadow: 0 0 10px var(--primary-glow);
            }

            50% {
                box-shadow: 0 0 25px var(--primary-glow);
            }

            100% {
                box-shadow: 0 0 10px var(--primary-glow);
            }
        }

        /* --- UTILS & CORE STRUCTURE --- */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        header {
            padding: 15px 20px;
            background: rgba(26, 26, 26, 0.85);
            backdrop-filter: blur(12px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            z-index: 10;
            position: sticky;
            top: 0;
        }

        main {
            flex: 1;
            padding: 20px;
            padding-bottom: 80px;
            /* Reduced from 90px for better spacing */
        }

        /* Entferne overflow-y: auto hier */

        /* --- LOGIN --- */
        #login-view {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at top, #2a2a2a 0%, var(--bg) 100%);
            padding: 20px;
        }

        .user-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 400px;
        }

        .user-card {
            background: var(--surface);
            border: 1px solid #333;
            border-radius: 20px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .user-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 4px 20px var(--primary-glow);
        }

        .user-card:active {
            transform: scale(0.96);
            background: #252525;
        }

        .login-mascot {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 10px;
            animation: fadeIn 1s ease-out;
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            background-size: cover;
            background-position: center;
            border: 3px solid var(--surface-light);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }

        /* --- LEADERBOARD --- */
        .leaderboard-item {
            display: flex;
            align-items: center;
            background: var(--surface);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .leaderboard-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .leaderboard-item.rank-1 {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(26, 26, 26, 1) 100%);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.1);
        }

        .leaderboard-item.rank-2 {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.1) 0%, rgba(26, 26, 26, 1) 100%);
            border: 1px solid rgba(192, 192, 192, 0.3);
        }

        .leaderboard-item.rank-3 {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.1) 0%, rgba(26, 26, 26, 1) 100%);
            border: 1px solid rgba(205, 127, 50, 0.3);
        }

        .rank-badge {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            border-radius: 50%;
            margin-right: 15px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
        }

        .rank-1 .rank-badge {
            background: gold;
            color: #000;
            box-shadow: 0 0 10px gold;
        }

        .rank-2 .rank-badge {
            background: silver;
            color: #000;
            box-shadow: 0 0 10px silver;
        }

        .rank-3 .rank-badge {
            background: #cd7f32;
            color: #000;
            box-shadow: 0 0 10px #cd7f32;
        }

        .leaderboard-score {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
            background: rgba(255, 77, 109, 0.1);
            padding: 5px 12px;
            border-radius: 20px;
        }

        /* --- GOAL DISPLAY --- */
        .goal-display-card {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        /* --- DASHBOARD & ANIMATIONS --- */
        .hero-card {
            background: linear-gradient(135deg, var(--primary), #ff7799);
            border-radius: 24px;
            padding: 25px;
            color: white;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px var(--primary-glow);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero-count {
            font-size: 3.5rem;
            font-weight: 800;
            line-height: 1;
            margin: 10px 0;
            animation: subtlePulse 3s infinite alternate;
            border-radius: 5px;
        }

        .section-header {
            margin: 30px 0 15px 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* --- LOB BUTTONS (mit Animation) --- */
        .lob-grid {
            display: grid;
            gap: 15px;
        }

        .lob-target-btn {
            background: var(--surface);
            border: 1px solid #333;
            border-radius: 16px;
            padding: 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all var(--transition-speed);
        }

        .lob-target-btn:hover {
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(247, 37, 133, 0.3);
        }

        .lob-target-btn:active {
            background: #252525;
            transform: scale(0.98);
        }

        .btn-action {
            color: var(--primary);
            font-size: 0.8rem;
            font-weight: bold;
        }

        /* --- NAVIGATION BAR --- */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-around;
            padding: 10px 0 25px 0;
            z-index: 50;
        }

        .nav-item {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.75rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            width: 70px;
            cursor: pointer;
            transition: color var(--transition-speed);
            position: relative;
        }

        .nav-item i {
            font-size: 1.4rem;
            transition: transform var(--transition-speed);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item:active i {
            transform: scale(0.9);
        }

        .notification-badge {
            position: absolute;
            top: 0px;
            right: 10px;
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            border: 2px solid var(--surface);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 77, 109, 0.4);
            }

            70% {
                box-shadow: 0 0 0 8px rgba(255, 77, 109, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 77, 109, 0);
            }
        }

        /* --- INPUTS & FORMS --- */
        .settings-card {
            background: var(--surface);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        input,
        select {
            width: 100%;
            padding: 14px;
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            color: white;
            margin-bottom: 10px;
            box-sizing: border-box;
            transition: border-color var(--transition-speed);
            -webkit-appearance: none;
            /* iOS/Safari */
            appearance: none;
        }

        input:focus,
        select:focus {
            border-color: var(--primary);
            outline: none;
        }

        .btn-main {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: background var(--transition-speed), transform 0.1s;
        }

        .btn-main:hover {
            background: #e04460;
        }

        .btn-main:active {
            transform: scale(0.99);
        }

        /* --- ADMIN LOGS --- */
        .log-entry {
            font-size: 0.8rem;
            padding: 12px 0;
            border-bottom: 1px solid #333;
            line-height: 1.4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-content {
            flex-grow: 1;
        }

        .admin-filter-bar button {
            background: #252525;
            color: #ccc;
            border: 1px solid #444;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 0.8rem;
            transition: background 0.2s;
        }

        .admin-filter-bar button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* --- SHOP / REWARDS (NEU: RASTER) --- */
        /* Hinzugefügte Styles für das Ausgrauen und den Fehlbetrag */
        .shop-item-card.disabled {
            opacity: 0.5;
            /* Halbtransparent/Ausgegraut */
            cursor: not-allowed;
            /* pointer-events: none;  <-- REMOVED to allow goal setting */
            box-shadow: none;
            /* Entfernt den Schatten, um Inaktivität zu betonen */
        }

        /* Entferne den Hover-Effekt im Disabled-Zustand */
        .shop-item-card.disabled:hover {
            border-color: #333;
            transform: none;
        }

        /* Text für fehlende Lobs (wird nur in JS hinzugefügt, wenn disabled) */
        .shop-missing-info {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--danger);
            /* Farbe für Fehlbetrag */
            margin-top: 5px;
        }

        /* Ziel-Prämie auf Startseite */
        .goal-card {
            background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
            border: 2px solid var(--accent);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(247, 37, 133, 0.3);
        }

        .goal-icon {
            font-size: 3rem;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .progress-bar-container {
            background: #0d0d0d;
            border-radius: 10px;
            height: 12px;
            width: 100%;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--accent), var(--primary));
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        /* Badge Display */
        .badge-item {
            display: inline-block;
            margin: 10px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 2px solid;
            position: relative;
            cursor: help;
            transition: all 0.2s;
        }

        .badge-item:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .badge-item.unlocked {
            border-color: var(--accent);
        }

        .badge-item.locked {
            border-color: #444;
            opacity: 0.5;
            filter: grayscale(100%);
        }

        .badge-icon {
            font-size: 2.5rem;
            margin-bottom: 8px;
        }

        .badge-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .badge-tooltip {
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
        }

        .badge-item:hover .badge-tooltip {
            opacity: 1;
        }

        .badge-progress-container {
            background: #0d0d0d;
            border-radius: 8px;
            height: 8px;
            width: 100%;
            overflow: hidden;
            margin-top: 8px;
        }

        .badge-progress-bar {
            height: 100%;
            border-radius: 8px;
            transition: width 0.3s ease;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .shop-item-card {
            background: var(--surface);
            border: 1px solid #333;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .shop-item-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 4px 20px var(--primary-glow);
        }

        .shop-item-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        .shop-icon {
            font-size: 3rem;
            color: var(--accent);
            margin-bottom: 10px;
        }

        .shop-cost {
            font-weight: 700;
            color: gold;
            font-size: 1.1rem;
            margin-top: 5px;
        }

        /* Style für die spezifischen Kontostände (Home/Shop) */
        .score-display-small {
            background: #222;
            padding: 12px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            font-size: 0.95rem;
            border-left: 4px solid var(--accent);
        }

        .score-display-small.thomas {
            border-left-color: #00bcd4;
        }

        .score-display-small.emil {
            border-left-color: #ff9900;
        }

        .score-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        /* Admin Log Delete Button */
        .btn-delete-log {
            background: var(--danger);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.8rem;
        }

        .admin-super-user {
            background: linear-gradient(135deg, #111, #333);
            border-left: 5px solid #00bcd4;
        }

        /* --- CASINO --- */
        .account-select-card {
            opacity: 1;
            border: 1px solid #555;
            transform: scale(1);
            transition: all 0.2s;
        }

        .account-select-card:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 15px rgba(255, 77, 109, 0.2);
            border-color: var(--primary);
        }

        .account-select-card.active {
            opacity: 1;
            border-color: var(--primary);
            transform: scale(1);
            box-shadow: 0 0 15px rgba(255, 77, 109, 0.3);
            background: rgba(255, 77, 109, 0.1);
        }

        .casino-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .game-card {
            background: var(--surface);
            border: 1px solid #333;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-speed);
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .game-card:hover {
            border-color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(247, 37, 133, 0.2);
        }

        .game-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .game-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .game-title {
            font-weight: 700;
            font-size: 1rem;
        }

        /* Blackjack Table */
        .blackjack-table {
            background: #0f380f;
            border-radius: 20px;
            padding: 20px;
            border: 5px solid #2e1a0f;
            text-align: center;
            position: relative;
            min-height: 400px;
        }

        .card-hand {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            min-height: 100px;
        }

        .playing-card {
            width: 60px;
            height: 90px;
            background: white;
            border-radius: 5px;
            color: black;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .playing-card.red {
            color: red;
        }

        .playing-card.black {
            color: black;
        }

        .playing-card-back {
            background: repeating-linear-gradient(45deg,
                    #606dbc,
                    #606dbc 10px,
                    #465298 10px,
                    #465298 20px);
            border: 2px solid white;
        }

        /* --- CASINO STYLES --- */
        /* Coin Flip 3D */
        .coin-container {
            perspective: 1000px;
            width: 120px;
            height: 120px;
            margin: 20px auto;
            cursor: pointer;
        }

        .coin {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .coin-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5), 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 5px solid rgba(255, 255, 255, 0.2);
        }

        .coin-front {
            background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b);
            color: #fff;
            text-shadow: 0 2px 2px rgba(0, 0, 0, 0.5);
        }

        .coin-back {
            background: radial-gradient(circle at 30% 30%, #c0c0c0, #808080);
            color: #fff;
            transform: rotateY(180deg);
            text-shadow: 0 2px 2px rgba(0, 0, 0, 0.5);
        }

        /* Roulette Board */
        .roulette-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            max-width: 350px;
            margin: 20px auto;
            background: #0a3d0a;
            padding: 10px;
            border-radius: 8px;
            border: 4px solid #5d4037;
        }

        .roulette-cell {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            font-size: 0.9rem;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .roulette-cell:active {
            transform: scale(0.95);
        }

        .roulette-cell.red {
            background-color: #d32f2f;
        }

        .roulette-cell.black {
            background-color: #212121;
        }

        .roulette-cell.green {
            background-color: #388e3c;
        }

        .roulette-cell.zero {
            grid-column: span 3;
        }

        .roulette-chip {
            position: absolute;
            width: 20px;
            height: 20px;
            background: gold;
            border-radius: 50%;
            border: 2px dashed #b8860b;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            color: black;
            font-weight: bold;
            pointer-events: none;
        }

        /* Slots 5-Reel */
        .slots-container {
            background: #2c0b36;
            padding: 15px;
            border-radius: 10px;
            border: 4px solid gold;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .slots-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            background: #111;
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .slot-cell {
            background: white;
            height: 60px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .slot-cell.blur {
            filter: blur(3px);
            transform: scaleY(1.1);
        }

        .payline-control {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        /* Sports Betting */
        .sports-container {
            padding: 10px;
        }

        .match-card {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #aaa;
        }

        .match-teams {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .team-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .team-info.away {
            justify-content: flex-end;
            text-align: right;
        }

        .team-logo {
            width: 30px;
            height: 30px;
            object-fit: contain;
        }

        .match-odds {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 5px;
        }

        .odd-btn {
            background: #333;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background 0.2s;
        }

        .odd-btn:hover {
            background: #444;
        }

        .odd-btn.selected {
            background: var(--primary);
            border-color: var(--primary);
        }

        .odd-val {
            color: gold;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .odd-label {
            font-size: 0.7rem;
            color: #ccc;
        }
    </style>

    <script>
        // =======================================================
        // GLOBALE KONFIGURATION UND UTILITY-FUNKTIONEN
        // =======================================================

        // WICHTIG: Die Basis-URL für das Backend.
        // Diese Logik stellt sicher, dass es sowohl lokal als auch live funktioniert.
        const isLocalhost = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
        // Wenn localhost, verwenden wir den vollen Port. Andernfalls verwenden wir eine relative URL ('/'), 
        // die automatisch auf die Domain der Online-App zeigt.
        const API_BASE_URL = isLocalhost ? 'http://localhost:3000' : '';

        // Timeout-Konfiguration
        const FETCH_TIMEOUT_MS = 10000;

        // Variable, um den aktuell eingeloggten Benutzer zu speichern
        let loggedInUser = null;

        // ... (Der Rest Ihrer 6000 Zeilen JavaScript-Code folgt hier) ...
    </script>

</head>

<body>

    <div id="login-view">
        <div class="login-mascot"><i class="fas fa-hiking"></i></div>
        <h2 style="margin-bottom: 40px; font-weight: 800; letter-spacing: -1px;">WILLKOMMEN</h2>
        <div id="login-grid" class="user-grid">
        </div>
        <div style="margin-top: 50px; opacity: 0.5; cursor:pointer;" onclick="adminLogin()">
            <i class="fas fa-fingerprint"></i>
        </div>
    </div>

    <div id="app-view" class="hidden" style="min-height: 100vh;">
        <header>
            <div class="header-title">Hallo <span id="header-username">User</span></div>
            <div>
                <span id="status-badge" class="status-badge">Offline</span>
                <button onclick="logout()"
                    style="background:none; border:none; color:var(--danger); margin-left:10px; font-size:1.1rem; cursor:pointer;"><i
                        class="fas fa-power-off"></i></button>
            </div>
        </header>

        <main>

            <div id="tab-admin" class="fade-in hidden">
                <div class="section-header">Admin Einstellungen</div>

                <div class="settings-card">
                    <h4 style="margin-top:0;"><i class="fas fa-key"></i> Passwort ändern</h4>
                    <input type="password" id="admin-pass" placeholder="Neues Admin-Passwort">
                    <button class="btn-main" style="background: #444;" onclick="saveAdminPass()">Passwort
                        speichern</button>
                </div>

                <div class="section-header">Admin Logs</div>
                <div id="admin-log-list"></div>
            </div>

            <div id="tab-user-admin" class="fade-in hidden">
                <div class="section-header">Benutzerverwaltung</div>
                <div id="admin-user-management"></div>
            </div>

            <div id="tab-badge-admin" class="fade-in hidden">
                <div class="section-header">Badge-Verwaltung</div>
                <div class="settings-card">
                    <h4 style="margin-top:0;">Neues Badge erstellen</h4>
                    <input type="text" id="badge-name" placeholder="Badge Name">
                    <input type="number" id="badge-threshold" placeholder="Benötigte Lobs">
                    <input type="text" id="badge-icon" placeholder="Icon (z.B. fa-star) ODER leer lassen für Bild">
                    <input type="text" id="badge-image" placeholder="Bild-URL (optional, statt Icon)">
                    <input type="color" id="badge-color" value="#4CAF50" style="height: 50px;">
                    <input type="text" id="badge-desc" placeholder="Beschreibung">
                    <button class="btn-main" onclick="addBadge()">Badge erstellen</button>
                </div>
                <div id="badge-list" style="margin-top:20px;"></div>
            </div>

            <div id="tab-log-admin" class="fade-in hidden">
                <div class="section-header">System Protokoll & Lob-Rückzug</div>
                <div class="admin-filter-bar">
                    <button id="filter-all" class="active" onclick="setLogFilter('ALL')">Alle</button>
                    <button id="filter-lob" onclick="setLogFilter('LOB')">Lobs</button>
                    <button id="filter-reward" onclick="setLogFilter('REWARD')">Prämien</button>
                    <button id="filter-admin" onclick="setLogFilter('ADMIN')">Admin</button>
                    <button id="filter-casino" onclick="setLogFilter('CASINO')">Casino</button>
                </div>
                <div id="log-list" style="max-height: 400px; overflow-y: auto;"></div>
            </div>

            <!-- NEU: Shop-Verwaltung Tab für Admin (statt User-Shop) -->
            <div id="tab-shop-admin" class="fade-in hidden">
                <div class="section-header">Prämien-Verwaltung</div>
                <div class="settings-card">
                    <h4 style="margin-top:0;">Neue Prämie erstellen</h4>
                    <input type="text" id="reward-name" placeholder="Prämien-Name">
                    <input type="number" id="reward-cost" placeholder="Kosten (Lobs)">
                    <input type="text" id="reward-icon" placeholder="Icon (z.B. fa-star)">
                    <input type="text" id="reward-desc" placeholder="Beschreibung">
                    <button class="btn-main" onclick="addRewardWithIcon()">Prämie erstellen</button>
                </div>
                <div id="admin-reward-list" style="margin-top:15px;"></div>
            </div>

            <div id="tab-shop" class="fade-in hidden">
                <div class="section-header">Deine Separaten Lob-Konten</div>
                <div class="score-container" id="shop-separate-scores">
                </div>

                <div class="section-header" style="margin-top: 40px;">Verfügbare Prämien</div>
                <div id="shop-reward-list" class="shop-grid">
                </div>
                <div style="text-align:center; margin-top:30px; color:var(--text-muted); font-size:0.9rem;">
                    *Jede Prämie muss vollständig von **einem** Konto bezahlt werden.
                </div>
            </div>

            <div id="tab-profile" class="fade-in hidden">
                <div class="section-header">Dein Profil</div>
                <div class="settings-card" style="text-align: center;">
                    <div id="profile-avatar-preview" class="avatar"></div>

                    <input type="file" id="inp-avatar-file" accept="image/*" style="display:none;"
                        onchange="handleFileUpload(this)">
                    <button class="btn-main" onclick="document.getElementById('inp-avatar-file').click()"
                        style="background: #444; margin-bottom: 10px;"><i class="fas fa-upload"></i> Bild aus
                        Galerie
                        wählen</button>
                    <hr style="border: 1px solid #333; margin: 20px 0;">
                    <input type="text" id="inp-avatar-url" placeholder="Oder Bild-URL einfügen">
                    <button class="btn-main" onclick="saveAvatarFromURL()">URL speichern</button>

                    <div id="profile-badge-display" style="margin-top:20px; font-size:2rem; color:white;"></div>
                </div>

                <div class="settings-card">
                    <h4 style="margin-top:0;">Sicherheit</h4>
                    <input type="password" id="inp-pass" placeholder="Neues Passwort">
                    <button class="btn-main" style="background: #444;" onclick="savePass()">Passwort
                        speichern</button>
                </div>
            </div>


            <div id="tab-leaderboard" class="fade-in hidden">
                <div class="section-header">Rangliste</div>
                <div id="leaderboard-list"></div>
            </div>

            <div id="tab-home" class="fade-in">
                <div class="hero-card">
                    <div class="hero-label">Dein Gesamtscore (Für Rangliste)</div>
                    <div class="hero-count" id="score-display">0</div>
                    <div><i class="fas fa-star" style="color: gold;"></i> Gesamter Lob-Stand</div>
                    <div id="badge-display" style="margin-top:20px; font-size:2rem; color:white;"></div>
                    <div style="position: absolute; top: 15px; right: 15px; opacity: 0.7; cursor: pointer;"
                        onclick="nav('activity')">
                        <i class="fas fa-history" style="font-size: 1.2rem;"></i>
                    </div>
                </div>

                <div class="section-header" style="margin-top: 5px;">Deine Separaten Lob-Konten</div>
                <div class="score-container" id="home-separate-scores">
                </div>

                <!-- NEU: Ziel-Prämie Anzeige -->
                <!-- NEU: Ziel-Prämie Anzeige -->
                <div id="goal-display" class="hidden">
                </div>

                <div id="reward-tracking-box" class="reward-progress hidden">
                    <div style="font-weight:600; color:#fff;">Nächste Prämie (Bester Score): <span id="next-reward-name"
                            style="color:var(--accent);"></span></div>
                    <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:5px;">Noch <span
                            id="reward-needed"></span> Lobs bis <span id="reward-cost"></span></div>
                    <div class="progress-bar-container">
                        <div id="reward-progress-bar" class="progress-bar" style="width: 0%;"></div>
                    </div>
                </div>

                <div class="section-header">Lob verteilen</div>
                <div id="lob-list" class="lob-grid">
                </div>
            </div>

            <div id="tab-activity" class="fade-in hidden">
                <div class="section-header">Dein Lob-Verlauf</div>
                <div id="activity-log">
                </div>
            </div>

            <div id="tab-casino" class="fade-in hidden">

                <div id="casino-account-selection">
                    <div class="section-header" style="margin-top:0;">Wähle dein Einsatz-Konto</div>
                    <div id="casino-accounts-list" class="shop-grid"
                        style="margin-top:10px; margin-bottom:30px; grid-template-columns: 1fr 1fr;">
                        <!-- Wird per JS gefüllt -->
                    </div>
                </div>

                <div id="casino-main-menu" class="hidden">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <button onclick="backToAccountSelection()"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:0.9rem;">
                            <i class="fas fa-arrow-left"></i> Konto ändern
                        </button>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div id="casino-balance-display" style="text-align:right;">
                                <!-- Wird per JS gefüllt -->
                            </div>
                            <button onclick="openExchangeMenu()"
                                style="background:var(--surface-light); border:1px solid #444; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>
                    </div>

                    <div class="section-header">Casino Spiele</div>
                    <div class="casino-grid">
                        <!-- Blackjack -->
                        <div class="game-card" onclick="openBlackjack()">
                            <div class="game-icon"><i class="fas fa-dice"></i></div>
                            <div class="game-title">Blackjack</div>
                            <div id="menu-bj-cost" style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">
                                Einsatz: ?</div>
                        </div>
                        <!-- Roulette -->
                        <div class="game-card" onclick="openRoulette()">
                            <div class="game-icon" style="color:#e91e63;"><i class="fas fa-dot-circle"></i></div>
                            <div class="game-title">Roulette</div>
                            <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">Einsatz: 1 Chip
                            </div>
                        </div>
                        <!-- Slots -->
                        <div class="game-card" onclick="openSlots()">
                            <div class="game-icon" style="color:#ff9800;"><i class="fas fa-lemon"></i></div>
                            <div class="game-title">Slots</div>
                            <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">Einsatz: 1 Chip
                            </div>
                        </div>
                        <!-- Coinflip -->
                        <div class="game-card" onclick="openCoinFlip()">
                            <div class="game-icon" style="color:#00bcd4;"><i class="fas fa-coins"></i></div>
                            <div class="game-title">Doppelt oder Nichts</div>
                            <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">Einsatz: Variabel
                            </div>
                        </div>
                        <!-- Sports Betting (TestUser only) / Coming Soon -->
                        <div class="game-card" id="sports-betting-card" onclick="openSportsBetting()"
                            style="display:none;">
                            <div class="game-icon" style="color:#4CAF50;"><i class="fas fa-futbol"></i></div>
                            <div class="game-title">Sportwetten</div>
                            <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">Live Fußball Wetten
                            </div>
                        </div>
                        <div class="game-card disabled" id="sports-betting-coming-soon" style="display:none;">
                            <div class="game-icon"><i class="fas fa-question"></i></div>
                            <div class="game-title">Coming Soon</div>
                            <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">Bald verfügbar
                            </div>
                        </div>
                        <!-- Coming Soon -->
                        <div class="game-card disabled">
                            <div class="game-icon"><i class="fas fa-question"></i></div>
                            <div class="game-title">Coming Soon</div>
                        </div>
                    </div>
                </div>

                <!-- NEU: Exchange Menu -->
                <div id="casino-exchange-menu" class="hidden">
                    <div style="display:flex; align-items:center; margin-bottom:20px;">
                        <button onclick="closeExchangeMenu()"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer; font-size:0.9rem; margin-right:10px;">
                            <i class="fas fa-arrow-left"></i> Zurück
                        </button>
                        <h3 style="margin:0;">Chip Wechselstube</h3>
                    </div>

                    <div class="settings-card"
                        style="margin-bottom:15px; background: linear-gradient(135deg, #1a1a1a, #252525); border: 1px solid #333;">
                        <div
                            style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                            <h4 style="margin:0;"><i class="fas fa-coins" style="color:gold;"></i> Chips kaufen</h4>
                            <div style="font-size:0.8rem; color:var(--text-muted);">1 Lob = <span
                                    id="ex-rate-display">10</span> Chips</div>
                        </div>
                        <div style="margin-bottom:10px; font-size:0.9rem; color:#ccc;">
                            Verfügbare Lobs: <span id="exchange-lob-balance"
                                style="color:white; font-weight:bold;">0</span>
                        </div>
                        <button class="btn-main" onclick="convertLobToChips()">
                            <i class="fas fa-plus-circle"></i> Tauschen
                        </button>
                    </div>

                    <div class="settings-card"
                        style="background: linear-gradient(135deg, #1a1a1a, #252525); border: 1px solid #333;">
                        <div
                            style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                            <h4 style="margin:0;"><i class="fas fa-star" style="color:var(--primary);"></i> Lobs
                                zurückkaufen</h4>
                            <div style="font-size:0.8rem; color:var(--text-muted);"><span
                                    id="ex-rate-back-display">10</span> Chips = 1 Lob</div>
                        </div>
                        <div style="margin-bottom:10px; font-size:0.9rem; color:#ccc;">
                            Verfügbare Chips: <span id="exchange-chip-balance"
                                style="color:gold; font-weight:bold;">0</span>
                        </div>
                        <button class="btn-main" style="background:#444;" onclick="convertChipsToLob()">
                            <i class="fas fa-minus-circle"></i> Tauschen
                        </button>
                    </div>
                </div>

                <!-- BLACKJACK GAME -->
                <div id="blackjack-game" class="hidden">
                    <div class="section-header"
                        style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span>Blackjack</span>
                            <div id="bj-account-info"
                                style="font-size:0.8rem; color:gold; background:rgba(255, 215, 0, 0.1); padding:4px 8px; border-radius:6px; border:1px solid rgba(255, 215, 0, 0.3);">
                                <!-- Wird per JS gefüllt -->
                            </div>
                        </div>
                        <button onclick="exitBlackjack()"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;">Beenden <i
                                class="fas fa-times"></i></button>
                    </div>

                    <div class="blackjack-table">
                        <div style="color:rgba(255,255,255,0.7); margin-bottom:5px; font-size:0.9rem;">Dealer: <span
                                id="bj-dealer-score">0</span></div>
                        <div id="bj-dealer-hand" class="card-hand"></div>

                        <div style="margin: 30px 0; border-top: 2px dashed rgba(255,255,255,0.1);"></div>

                        <div style="color:rgba(255,255,255,0.7); margin-bottom:5px; font-size:0.9rem;">Du: <span
                                id="bj-player-score">0</span></div>
                        <div id="bj-player-hand" class="card-hand"></div>

                        <div id="bj-controls" style="margin-top:30px;">
                            <button id="bj-btn-deal" class="btn-main" onclick="bjDeal()"
                                style="background:gold; color:black;">Austeilen</button>
                            <div id="bj-actions" class="hidden"
                                style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                <button class="btn-main" style="background:var(--primary);"
                                    onclick="bjHit()">Hit</button>
                                <button class="btn-main" style="background:#444;" onclick="bjStand()">Stand</button>
                            </div>
                        </div>
                        <div id="bj-message"
                            style="margin-top:15px; font-weight:bold; color:white; min-height:24px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                        </div>
                    </div>
                </div>

                <!-- ROULETTE GAME -->
                <div id="roulette-game" class="hidden">
                    <div class="section-header"
                        style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span>Roulette</span>
                            <div id="roulette-account-info"
                                style="font-size:0.8rem; color:gold; background:rgba(255, 215, 0, 0.1); padding:4px 8px; border-radius:6px; border:1px solid rgba(255, 215, 0, 0.3);">
                            </div>
                        </div>
                        <button onclick="exitRoulette()"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;">Beenden <i
                                class="fas fa-times"></i></button>
                    </div>

                    <div style="background:#052605; padding:15px; border-radius:10px; border:2px solid #333;">
                        <div id="roulette-wheel-display"
                            style="text-align:center; font-size:2rem; margin-bottom:20px; min-height:50px; display:flex; align-items:center; justify-content:center; gap:10px;">
                            <i class="fas fa-dot-circle"></i> <span id="roulette-result-text">Platziere deinen
                                Einsatz</span>
                        </div>

                        <!-- Controls -->
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;">
                            <div>
                                <label style="font-size:0.8rem; color:#aaa; display:block;">Chip-Wert:</label>
                                <select id="roulette-chip-val" class="swal2-select"
                                    style="margin:0; padding:5px; background:#333; color:white; border:1px solid #555;">
                                    <option value="1">1 Chip</option>
                                    <option value="5">5 Chips</option>
                                    <option value="10">10 Chips</option>
                                    <option value="25">25 Chips</option>
                                    <option value="100">100 Chips</option>
                                </select>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:0.8rem; color:#aaa;">Gesamteinsatz:</div>
                                <div id="roulette-total-bet" style="color:gold; font-weight:bold;">0</div>
                            </div>
                        </div>

                        <!-- Board -->
                        <div id="roulette-board" class="roulette-board">
                            <!-- Generated by JS -->
                        </div>

                        <!-- Actions -->
                        <div style="display:flex; gap:10px; margin-top:20px;">
                            <button class="btn-main" onclick="clearRouletteBets()"
                                style="background:#444; flex:1;">Löschen</button>
                            <button class="btn-main" onclick="spinRoulette()"
                                style="background:var(--accent); flex:2;">DREHEN</button>
                        </div>
                    </div>
                </div>

                <!-- SLOTS GAME -->
                <div id="slots-game" class="hidden">
                    <div class="section-header"
                        style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <span>Slots (5 Walzen)</span>
                            <div id="slots-account-info"
                                style="font-size:0.8rem; color:gold; background:rgba(255, 215, 0, 0.1); padding:4px 8px; border-radius:6px; border:1px solid rgba(255, 215, 0, 0.3);">
                            </div>
                        </div>
                        <button onclick="exitSlots()"
                            style="background:none; border:none; color:var(--text-muted); cursor:pointer;">Beenden <i
                                class="fas fa-times"></i></button>
                    </div>

                    <div class="slots-container">
                        <div class="slots-grid" id="slots-grid">
                            <!-- 15 Cells (5 cols x 3 rows) generated by JS -->
                        </div>

                        <div class="payline-control">
                            <div>
                                <label style="font-size:0.8rem; color:#aaa;">Linien:</label>
                                <select id="slots-lines" onchange="updateSlotsCost()"
                                    style="background:#333; color:white; border:1px solid #555; padding:5px; border-radius:4px;">
                                    <option value="1">1 Linie (Mitte)</option>
                                    <option value="3">3 Linien (Oben, Mitte, Unten)</option>
                                    <option value="5">5 Linien (+ Diagonalen)</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:0.8rem; color:#aaa;">Einsatz/Linie:</label>
                                <select id="slots-bet" onchange="updateSlotsCost()"
                                    style="background:#333; color:white; border:1px solid #555; padding:5px; border-radius:4px;">
                                    <option value="1">1 Chip</option>
                                    <option value="2">2 Chips</option>
                                    <option value="5">5 Chips</option>
                                    <option value="10">10 Chips</option>
                                </select>
                            </div>
                        </div>

                        <div style="text-align:center; margin-bottom:15px;">
                            <span style="color:#aaa;">Gesamteinsatz: </span>
                            <span id="slots-total-cost" style="color:gold; font-weight:bold;">1 Chip</span>
                        </div>

                        <div id="slots-result"
                            style="font-size:1.1rem; font-weight:bold; margin-bottom:15px; min-height:30px; text-align:center; color:white;">
                        </div>
                        <button class="btn-main" onclick="spinSlots()"
                            style="background:linear-gradient(to bottom, #ff9800, #f57c00); width:100%; font-size:1.2rem; text-shadow:0 1px 2px rgba(0,0,0,0.5);">SPIN
                            🎰</button>
                    </div>
                </div>


                <!-- COIN FLIP GAME (Double or Nothing) -->
                <div id="coin-flip-view" class="hidden"
                    style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.95); z-index:1000; overflow-y:auto;">
                    <div class="game-container" style="max-width:600px; margin:50px auto; padding:20px;">
                        <div class="section-header"
                            style="display:flex; justify-content:space-between; align-items:center;">
                            <span>Doppelt oder Nichts</span>
                            <button onclick="exitCoinFlip()"
                                style="background:none; border:none; color:var(--text-muted); cursor:pointer;">Beenden
                                <i class="fas fa-times"></i></button>
                        </div>

                        <div id="cf-setup" style="text-align:center; padding:20px;">
                            <i class="fas fa-coins" style="font-size:3rem; color:gold; margin-bottom:20px;"></i>
                            <p style="color:#ccc; margin-bottom:20px;">Setze einen Betrag. Wenn du gewinnst, verdoppelst
                                du ihn. Wenn du verlierst, ist er weg.</p>
                            <input type="number" id="cf-bet-input" placeholder="Einsatz"
                                style="padding:10px; border-radius:5px; border:1px solid #444; background:#222; color:white; width:150px; text-align:center; margin-bottom:15px;">
                            <br>
                            <button class="btn-main" onclick="startCoinFlip()"
                                style="background:var(--primary); width:150px;">Starten</button>
                        </div>

                        <div id="cf-game" class="hidden">
                            <div style="font-size:1.5rem; color:gold; margin-bottom:10px;">Pot: <span
                                    id="cf-current-pot">0</span> Chips</div>

                            <div class="coin-container" onclick="flipCoin('random')">
                                <!-- Click to flip for fun? No, logic needs choice -->
                                <div id="cf-coin" class="coin">
                                    <div class="coin-face coin-front"><i class="fas fa-user-astronaut"></i></div>
                                    <div class="coin-face coin-back">1</div>
                                </div>
                            </div>

                            <div id="cf-message" style="margin:20px 0; font-weight:bold; min-height:24px;">Kopf oder
                                Zahl?</div>

                            <div id="cf-options" style="display:flex; justify-content:center; gap:15px;">
                                <button class="btn-main" onclick="flipCoin('head')"
                                    style="background:var(--primary); width:100px;">Kopf</button>
                                <button class="btn-main" onclick="flipCoin('tail')"
                                    style="background:#444; width:100px;">Zahl</button>
                            </div>
                            <div id="cf-result-actions" class="hidden"
                                style="display:flex; justify-content:center; gap:15px;">
                                <button class="btn-main" onclick="cfContinue()"
                                    style="background:var(--accent);">Nochmal (x2)</button>
                                <button class="btn-main" onclick="cfCashOut()"
                                    style="background:#4CAF50;">Auszahlen</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SPORTS BETTING GAME -->
            <div id="sports-betting-view" class="hidden">
                <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span>Sportwetten</span>
                        <select id="sports-league-select" onchange="changeLeague(this.value)"
                            style="background:#333; color:#fff; border:1px solid #555; padding:5px; border-radius:5px; margin-left:10px; font-size: 0.8rem;">
                            <option value="4331">Bundesliga</option>
                            <option value="4328">Premier League</option>
                            <option value="4335">La Liga</option>
                            <option value="4346">2. Bundesliga</option>
                            <option value="4429">WM Qualifikation</option>
                        </select>
                        <div id="sports-account-info"
                            style="font-size:0.8rem; color:gold; background:rgba(255, 215, 0, 0.1); padding:4px 8px; border-radius:6px; border:1px solid rgba(255, 215, 0, 0.3);">
                        </div>
                    </div>
                    <button onclick="exitSportsBetting()"
                        style="background:none; border:none; color:var(--text-muted); cursor:pointer;">Beenden
                        <i class="fas fa-times"></i></button>
                </div>

                <div class="sports-container">
                    <!-- Tabs -->
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <button id="btn-sports-upcoming" class="btn-main" style="flex:1; background:var(--primary);"
                            onclick="showSportsTab('upcoming')">Spiele</button>
                        <button id="btn-sports-mybets" class="btn-main" style="flex:1; background:#444;"
                            onclick="showSportsTab('mybets')">Meine Wetten</button>
                    </div>

                    <!-- Upcoming Matches -->
                    <div id="sports-upcoming-list">
                        <div style="text-align:center; padding:20px; color:#aaa;">Lade Spiele...</div>
                    </div>

                    <!-- My Bets -->
                    <div id="sports-mybets-list" class="hidden">
                        <div style="text-align:center; padding:20px; color:#aaa;">Keine aktiven Wetten.
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEU: Admin Casino Settings View (Full Page) -->
            <div id="admin-casino-settings-view" class="hidden" style="padding-bottom:100px;">
                <div class="section-header" style="display:flex; align-items:center; gap:10px;">
                    <button onclick="closeCasinoSettingsPage()"
                        style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;"><i
                            class="fas fa-arrow-left"></i></button>
                    <span>Casino Einstellungen</span>
                </div>

                <div class="settings-card">
                    <h4 style="margin-top:0;">Allgemein</h4>
                    <label style="display:block; text-align:left; margin-bottom:5px; color:#aaa;">Wechselkurs (1 Lob = X
                        Chips)</label>
                    <input id="page-casino-rate" type="number" style="margin-bottom:15px;" placeholder="10">

                    <label style="display:block; text-align:left; margin-bottom:5px; color:#aaa;">Standard
                        Zeitzone</label>
                    <select id="page-casino-timezone"
                        style="width:100%; background:#333; color:white; border:1px solid #555; padding:8px; border-radius:5px;">
                        <option value="Europe/Berlin">Europe/Berlin (CET)</option>
                        <option value="Europe/London">Europe/London (GMT)</option>
                        <option value="America/New_York">America/New_York (EST)</option>
                        <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
                        <option value="UTC">UTC</option>
                    </select>
                </div>

                <div class="settings-card">
                    <h4 style="margin-top:0;">Blackjack</h4>
                    <label style="display:block; text-align:left; margin-bottom:5px; color:#aaa;">Min. Einsatz
                        (Chips)</label>
                    <input id="page-casino-bj-cost" type="number" style="margin-bottom:15px;" placeholder="1">
                    <label style="display:block; text-align:left; margin-bottom:5px; color:#aaa;">Payout Multiplier
                        (z.B. 1.5)</label>
                    <input id="page-casino-bj-payout" type="number" step="0.1" style="margin-bottom:15px;"
                        placeholder="1.5">
                </div>

                <div class="settings-card">
                    <h4 style="margin-top:0;">Roulette</h4>
                    <label style="display:block; text-align:left; margin-bottom:5px; color:#aaa;">Min. Einsatz
                        (Chips)</label>
                    <input id="page-casino-roulette-cost" type="number" style="margin-bottom:15px;" placeholder="1">
                </div>

                <div class="settings-card">
                    <h4 style="margin-top:0;">Slots</h4>
                    <label style="display:block; text-align:left; margin-bottom:5px; color:#aaa;">Min. Einsatz pro Linie
                        (Chips)</label>
                    <input id="page-casino-slots-cost" type="number" style="margin-bottom:15px;" placeholder="1">
                    <label style="display:block; text-align:left; margin-bottom:5px; color:#aaa;">Gewinnchance
                        (%)</label>
                    <input id="page-casino-slots-chance" type="number" style="margin-bottom:15px;" placeholder="30">

                    <label style="display:block; text-align:left; margin-bottom:5px; color:#aaa;">Symbole
                        (Komma-getrennt)</label>
                    <textarea id="page-casino-slots"
                        style="width:100%; height:80px; background:#111; color:white; border:1px solid #333; border-radius:8px; padding:10px;"></textarea>
                </div>

                <div class="settings-card">
                    <h4 style="margin-top:0;">Doppelt oder Nichts</h4>
                    <label style="display:block; text-align:left; margin-bottom:5px; color:#aaa;">Min. Einsatz
                        (Chips)</label>
                    <input id="page-casino-cf-cost" type="number" style="margin-bottom:15px;" placeholder="1">
                    <label style="display:block; text-align:left; margin-bottom:5px; color:#aaa;">Hausvorteil
                        (%)</label>
                    <input id="page-casino-cf-edge" type="number" style="margin-bottom:15px;" placeholder="5">
                </div>

                <button class="btn-main" onclick="saveCasinoSettingsPage()"
                    style="background:var(--primary); position:fixed; bottom:20px; left:20px; width:calc(100% - 40px); z-index:100;">
                    <i class="fas fa-save"></i> Speichern
                </button>
            </div>

    </div>
    </div>


    <div id="tab-shop" class="fade-in hidden">
        <div class="section-header">Deine Separaten Lob-Konten</div>
        <div class="score-container" id="shop-separate-scores">
        </div>

        <div class="section-header" style="margin-top: 40px;">Verfügbare Prämien</div>
        <div id="shop-reward-list" class="shop-grid">
        </div>
        <div style="text-align:center; margin-top:30px; color:var(--text-muted); font-size:0.9rem;">
            *Jede Prämie muss vollständig von **einem** Konto bezahlt werden.
        </div>
    </div>

    <div id="tab-admin" class="fade-in hidden"></div>

    <!-- NEU: Shop-Verwaltung Tab für Admin (statt User-Shop) -->
    <div id="tab-shop-admin" class="fade-in hidden">
        <div class="section-header">Prämien-Verwaltung</div>
        <div class="settings-card">
            <h4 style="margin-top:0;">Neue Prämie erstellen</h4>
            <input type="text" id="reward-name" placeholder="Prämien-Name">
            <input type="number" id="reward-cost" placeholder="Kosten (Lobs)">
            <input type="text" id="reward-icon" placeholder="Icon (z.B. fa-star)">
            <input type="text" id="reward-desc" placeholder="Beschreibung">
            <button class="btn-main" onclick="addRewardWithIcon()">Prämie erstellen</button>
        </div>
        <div id="admin-reward-list" style="margin-top:15px;"></div>
    </div>

    <!-- NEU: User-Verwaltung Tab für Admin -->
    <div id="tab-user-admin" class="fade-in hidden">
        <div class="section-header">Benutzerverwaltung</div>
        <div id="admin-user-management"></div>
    </div>

    <!-- ... (Badge & Log Tabs bleiben gleich) ... -->
    <!-- NEU: Badge-Verwaltung Tab für Admin -->
    <div id="tab-badge-admin" class="fade-in hidden">
        <div class="section-header">Badge-Verwaltung</div>
        <div class="settings-card">
            <h4 style="margin-top:0;">Neues Badge erstellen</h4>
            <input type="text" id="badge-name" placeholder="Badge Name">
            <input type="number" id="badge-threshold" placeholder="Benötigte Lobs">
            <input type="text" id="badge-icon" placeholder="Icon (z.B. fa-star) ODER leer lassen für Bild">
            <input type="text" id="badge-image" placeholder="Bild-URL (optional, statt Icon)">
            <input type="color" id="badge-color" value="#4CAF50" style="height: 50px;">
            <input type="text" id="badge-desc" placeholder="Beschreibung">
            <button class="btn-main" onclick="addBadge()">Badge erstellen</button>
        </div>
        <div id="badge-list" style="margin-top:20px;"></div>
    </div>

    <!-- NEU: Log-Protokoll Tab für Admin -->
    <div id="tab-log-admin" class="fade-in hidden">
        <div class="section-header">System Protokoll & Lob-Rückzug</div>
        <div class="admin-filter-bar" style="margin-bottom: 15px;">
            <button id="filter-all" class="active" onclick="setLogFilter('ALL')">Alle</button>
            <button id="filter-lob" onclick="setLogFilter('LOB')">Lob-Aktionen</button>
            <button id="filter-reward" onclick="setLogFilter('REWARD')">Shop-Aktionen</button>
        </div>
        <div id="log-list" style="max-height: 400px; overflow-y: auto;"></div>
    </div>
    </main>

    <nav class="nav-bar hidden">
        <button class="nav-item active" onclick="nav('home')">
            <i class="fas fa-bolt"></i> Home
        </button>
        <button id="nav-casino" class="nav-item" onclick="nav('casino')">
            <i class="fas fa-dice"></i> Casino
        </button>
        <button class="nav-item" onclick="nav('leaderboard')">
            <i class="fas fa-medal"></i> Rangliste
        </button>
        <button class="nav-item" onclick="nav('shop')">
            <i class="fas fa-shopping-bag"></i> Shop
        </button>
        <button class="nav-item" onclick="nav('profile')">
            <i class="fas fa-user-circle"></i> Profil
        </button>
        <!-- Admin Navigation - Admin und Shop zuerst -->
        <button id="nav-admin" class="nav-item hidden" onclick="nav('admin')">
            <i class="fas fa-shield-alt"></i> Admin
        </button>
        <button id="nav-shop-admin" class="nav-item hidden" onclick="nav('shop-admin')">
            <i class="fas fa-shopping-bag"></i> Shop
        </button>
        <button id="nav-user-admin" class="nav-item hidden" onclick="nav('user-admin')">
            <i class="fas fa-users"></i> User
        </button>
        <button id="nav-badge-admin" class="nav-item hidden" onclick="nav('badge-admin')">
            <i class="fas fa-award"></i> Badge
        </button>
        <button id="nav-log-admin" class="nav-item hidden" onclick="nav('log-admin')">
            <i class="fas fa-clipboard-list"></i> Log
        </button>
    </nav>
    </div>

    <script>
        // --- CONFIG & STATE ---
        // WICHTIG: Ersetzen Sie DIESE URL durch die URL Ihres Render-Dienstes, wenn Sie online sind.
        // Wenn Sie die App lokal laufen lassen, nutzen Sie: 'http://localhost:3000'
        const API_URL = 'http://localhost:3000';
        const MASKOTTCHEN_ICON = '<i class="fas fa-hiking"></i>';

        // Definition der Prämie Icons
        const REWARD_ICONS = {
            'Kaffeepause gespendet': '<i class="fas fa-mug-hot"></i>',
            'Pizza-Mittagessen': '<i class="fas fa-pizza-slice"></i>',
            'Extra Urlaubstag': '<i class="fas fa-plane-departure"></i>',
            'default': '<i class="fas fa-star"></i>'
        };

        // DEFINITION DER STANDARDDATEN
        const DEFAULT_DB = {
            users: {
                "Thomas": {
                    password: "nacke",
                    image: "https://api.dicebear.com/7.x/notionists/svg?seed=Thomas",
                    lastSeenScore: 0,
                    received: { "Emil": 0, "Marius": 0 },
                    chips: { "Emil": 0, "Marius": 0 },
                    badges: [],
                    goalRewardId: null,
                    settings: { mobileNotifications: false }
                },
                "Emil": {
                    password: "nacke",
                    image: "https://api.dicebear.com/7.x/notionists/svg?seed=Emil",
                    lastSeenScore: 0,
                    received: { "Thomas": 0, "Marius": 0 },
                    chips: { "Thomas": 0, "Marius": 0 },
                    badges: [],
                    goalRewardId: null,
                    settings: { mobileNotifications: false }
                },
                "Marius": {
                    password: "nacke",
                    image: "https://api.dicebear.com/7.x/notionists/svg?seed=Marius",
                    lastSeenScore: 0,
                    received: { "Thomas": 0, "Emil": 0 },
                    chips: { "Thomas": 0, "Emil": 0 },
                    badges: [],
                    goalRewardId: null,
                    settings: { mobileNotifications: false }
                },
                // NEU: Admin-Test-Konto, falls es nicht im Live-DB ist
                "Admin": {
                    password: "nacke",
                    image: "https://api.dicebear.com/7.x/micah/svg?seed=Admin",
                    lastSeenScore: 0,
                    received: {}, // Admin empfängt nichts von Usern
                    chips: {},
                    adminLobs: 0, // Speicherort für Admin-Lobs
                    badges: [],
                    settings: { mobileNotifications: false }
                }
            },
            logs: [],
            rewards: [
                { id: 1, name: 'Kaffeepause gespendet', cost: 20, desc: 'Ein leckerer Kaffee aufs Haus.' },
                { id: 2, name: 'Pizza-Mittagessen', cost: 50, desc: 'Pizza für das Team, bezahlt aus deinem Lob-Konto.' },
                { id: 3, name: 'Extra Urlaubstag', cost: 100, desc: 'Nimm dir einen Tag frei. Gönn es dir!' }
            ],
            badgeDefinitions: [
                { threshold: 10, name: "Starter-Rucksack", icon: 'fa-walking', color: '#4CAF50', desc: '10 Lobs sammeln' },
                { threshold: 50, name: "Erfahrener Backpacker", icon: 'fa-map-marked-alt', color: '#2196F3', desc: '50 Lobs sammeln' },
                { threshold: 100, name: "Gipfelstürmer", icon: 'fa-hiking', color: '#FF9800', desc: '100 Lobs sammeln' }
            ],
            appSettings: {
                favicon: ''
            }
        };

        let db = null;
        let currentUser = null;
        let isOnline = false;
        let unreadLobs = 0;
        let currentLogFilter = 'ALL';
        let lastLobAction = null; // Für Undo-Funktion

        // --- INIT ---
        async function init() {
            try {
                // Versuch, die Daten vom Server abzurufen
                const res = await fetch(API_URL + '/db');
                if (res.ok) {
                    db = await res.json();
                    isOnline = true;
                    document.getElementById('status-badge').classList.add('online');
                    document.getElementById('status-badge').innerText = 'Online';
                }
                else throw new Error();
            } catch (e) {
                // Wenn Server nicht erreichbar, nutze localStorage (Offline-Modus)
                db = JSON.parse(localStorage.getItem('lobAppDB')) || DEFAULT_DB;
                isOnline = false;
                document.getElementById('status-badge').innerText = 'Offline';
            }

            // Kompatibilität & Initialisierung
            // Stelle sicher, dass das Admin-Konto existiert und initialisiert ist
            if (!db.users['Admin']) {
                db.users['Admin'] = DEFAULT_DB.users['Admin'];
            }

            for (let u in db.users) {
                if (typeof db.users[u].lastSeenScore === 'undefined') db.users[u].lastSeenScore = 0;
                if (typeof db.users[u].autoLogin === 'undefined') db.users[u].autoLogin = false;
                if (typeof db.users[u].badges === 'undefined') db.users[u].badges = [];
                if (typeof db.users[u].settings === 'undefined') db.users[u].settings = { mobileNotifications: false };

                // Migrate old goalRewardId to new goals structure
                if (typeof db.users[u].goals === 'undefined') {
                    db.users[u].goals = {};
                    // Migrate old single goal if it exists
                    if (db.users[u].goalRewardId) {
                        const source = db.users[u].goalRewardSource || 'Emil'; // Default to first account
                        db.users[u].goals[source] = db.users[u].goalRewardId;
                        delete db.users[u].goalRewardId;
                        delete db.users[u].goalRewardSource;
                    }
                }


                if (typeof db.users[u].received === 'undefined') {
                    db.users[u].received = {};
                }
                if (typeof db.users[u].chips === 'undefined') {
                    db.users[u].chips = {};
                }
                // NEU: Admin-Lobs initialisieren
                if (u === 'Admin' && typeof db.users[u].adminLobs === 'undefined') {
                    db.users[u].adminLobs = 0;
                }
            }

            if (!db.rewards || !Array.isArray(db.rewards)) db.rewards = DEFAULT_DB.rewards;
            db.rewards.sort((a, b) => a.cost - b.cost);

            // Badge-Definitionen initialisieren
            if (!db.badgeDefinitions || !Array.isArray(db.badgeDefinitions)) {
                db.badgeDefinitions = DEFAULT_DB.badgeDefinitions;
            }

            // App Settings initialisieren
            if (!db.appSettings) {
                db.appSettings = DEFAULT_DB.appSettings;
            }
            if (db.appSettings.favicon) {
                updateFavicon(db.appSettings.favicon);
            }

            // Admin-Konto aus der Login-Grid entfernen, wenn es existiert
            let loginUsers = { ...db.users };
            if (loginUsers['Admin']) delete loginUsers['Admin'];
            renderLogin(loginUsers);


            const savedUser = localStorage.getItem('lobAutoUser');
            if (savedUser && db.users[savedUser] && db.users[savedUser].autoLogin) {
                login(savedUser);
            }

            document.querySelector('.login-mascot').innerHTML = MASKOTTCHEN_ICON;
        }

        // NEU: Login-Rendering anpassen, um Admin und TestUser auszuschließen
        function renderLogin(users) {
            const grid = document.getElementById('login-grid');
            grid.innerHTML = '';
            Object.keys(users)
                .filter(u => u !== 'TestUser') // Filter out TestUser from login screen
                .forEach(u => {
                    grid.innerHTML += `
                    <div class="user-card" onclick="attemptLogin('${u}')">
                        <div class="avatar" style="background-image:url('${db.users[u].image}')"></div>
                        <div style="font-weight:700;">${u}</div>
                    </div>
                `;
                });
        }

        async function save() {
            if (isOnline) {
                try {
                    // Sende den gesamten DB-Stand an den Server
                    const res = await fetch(API_URL + '/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(db)
                    });
                    if (!res.ok) {
                        console.error("Speichern fehlgeschlagen. Status:", res.status);
                    }
                } catch (e) {
                    console.error("Fehler beim Speichern auf dem Server.", e);
                }
            } else {
                // Speichern im Offline-Modus
                localStorage.setItem('lobAppDB', JSON.stringify(db));
            }
        }

        // KORRIGIERTE calculateTotalScore(user) in index.html
        function calculateTotalScore(user) {
            // NEU: Admin-Check - Admin bekommt seinen Score aus adminLobs
            if (user === 'Admin') return db.users['Admin'].adminLobs || 0;

            // Für normale User: Summe aller erhaltenen Lobs
            let total = 0;
            const myData = db.users[user];
            for (let sender in myData.received) total += myData.received[sender];
            return total;
        }

        // Helper function to calculate total Lobs for a user
        function calculateLobs(user) {
            return calculateTotalScore(user);
        }

        // Helper function to calculate total Chips for a user
        function calculateBalance(user) {
            let totalChips = 0;
            const myData = db.users[user];
            if (myData.chips) {
                for (let source in myData.chips) {
                    totalChips += myData.chips[source];
                }
            }
            return totalChips;
        }

        // NEUE, KORRIGIERTE getRelevantScores(user) in index.html
        function getRelevantScores(user) {
            if (!db.users[user]) return [];

            // NEU: Wenn es der Admin ist, gib nur das AdminLobs-Konto zurück
            if (user === 'Admin') {
                return [{
                    name: 'Admin',
                    score: db.users['Admin'].adminLobs || 0,
                    cssClass: 'admin-super-user' // Spezielle Klasse für Styling
                }];
            }

            // Für normale User: Verarbeite die "received"-Objekte
            if (!db.users[user].received) return [];

            const relevantScores = Object.entries(db.users[user].received)
                .filter(([senderName, score]) => senderName !== user)
                .map(([senderName, score]) => ({
                    name: senderName,
                    score: score,
                    cssClass: senderName === 'Thomas' ? 'thomas' : (senderName === 'Emil' ? 'emil' : '')
                }));

            return relevantScores.sort((a, b) => a.name.localeCompare(b.name));
        }

        function checkBadges(user, total) {
            if (user === 'Admin') return; // NEU: Admin ausschließen

            // Verwende badgeDefinitions aus der Datenbank
            if (!db.badgeDefinitions || db.badgeDefinitions.length === 0) return;

            const data = db.users[user];
            let newBadge = false;

            db.badgeDefinitions.forEach(badge => {
                if (total >= badge.threshold && !data.badges.includes(badge.name)) {
                    data.badges.push(badge.name);
                    newBadge = true;
                    Swal.fire({
                        title: 'Neues Abzeichen!',
                        html: `Du hast das Abzeichen <b>"${badge.name}"</b> freigeschaltet! <span style="color: ${badge.color};"><i class="fas ${badge.icon}"></i></span>`,
                        icon: 'success', background: '#1a1a1a', color: '#fff', confirmButtonColor: '#ff4d6d'
                    });
                }
            });
            if (newBadge) save();
        }

        function renderBadges(user) {
            if (user === 'Admin') return; // NEU: Admin ausschließen

            if (!db.badgeDefinitions || db.badgeDefinitions.length === 0) return;

            const data = db.users[user];
            const display = document.getElementById('badge-display');
            const profileDisplay = document.getElementById('profile-badge-display');

            // Simple display for home screen
            if (display) {
                display.innerHTML = '';

                // Erstelle ein Map für schnelleren Zugriff
                const badgeMap = {};
                db.badgeDefinitions.forEach(b => {
                    badgeMap[b.name] = b;
                });

                data.badges.forEach(name => {
                    const badge = badgeMap[name];
                    if (badge) {
                        display.innerHTML += `<span title="${name}" style="margin: 0 5px; color:${badge.color};"><i class="fas ${badge.icon}"></i></span>`;
                    }
                });
            }


            // Detailed display for profile screen with progress
            if (profileDisplay) {
                profileDisplay.innerHTML = '';

                const total = calculateTotalScore(user);

                profileDisplay.innerHTML = '<div class="section-header" style="margin-top: 20px;">Deine Abzeichen</div>';
                profileDisplay.innerHTML += '<div style="display: flex; flex-wrap: wrap; justify-content: center;">';

                db.badgeDefinitions.forEach(badge => {
                    const unlocked = data.badges.includes(badge.name);
                    const progress = Math.min(100, (total / badge.threshold) * 100);

                    profileDisplay.innerHTML += `
                        <div class="badge-item ${unlocked ? 'unlocked' : 'locked'}">
                            <div class="badge-tooltip">${badge.desc} ${unlocked ? '✓' : `(${total}/${badge.threshold})`}</div>
                            <div class="badge-icon" style="color: ${unlocked ? badge.color : '#666'};"><i class="fas ${badge.icon}"></i></div>
                            <div class="badge-name">${badge.name}</div>
                            ${!unlocked ? `
                                <div class="badge-progress-container">
                                    <div class="badge-progress-bar" style="width: ${progress}%; background: ${badge.color};"></div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                profileDisplay.innerHTML += '</div>';
            }
        }

        async function attemptLogin(user) {
            const { value: formValues } = await Swal.fire({
                title: `Hallo ${user}`,
                html: `
                <input id="swal-password" type="password" class="swal2-input" placeholder="Passwort (nacke)">
                <div style="text-align:left; margin-top:10px;">
                    <input type="checkbox" id="swal-remember" style="width:auto; margin:0 5px 0 0;">
                    <label for="swal-remember" style="font-size:0.9rem; color:#ccc;">Auto-Login merken</label>
                </div>
            `,
                focusConfirm: false, background: '#1a1a1a', color: '#fff', confirmButtonColor: '#ff4d6d',
                preConfirm: () => {
                    const pass = document.getElementById('swal-password').value;
                    const remember = document.getElementById('swal-remember').checked;
                    if (!pass) { Swal.showValidationMessage('Passwort fehlt'); return false; }
                    return { pass, remember };
                }
            });

            if (formValues) {
                if (db.users[user].password === formValues.pass) {
                    db.users[user].autoLogin = formValues.remember;
                    localStorage.setItem('lobAutoUser', user); save();
                    login(user);
                } else {
                    Swal.fire({ icon: 'error', title: 'Falsch', background: '#1a1a1a', color: '#fff', timer: 1500, showConfirmButton: false });
                }
            }
        }

        async function adminLogin() {
            const { value: pass } = await Swal.fire({
                title: 'Admin Zugang', input: 'password', background: '#000', color: '#fff'
            });
            if (pass === 'nacke') { currentUser = 'Admin'; startApp(); }
        }

        function login(user) {
            currentUser = user;
            startApp();
            checkNewLobs(user);
        }

        function startApp() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('header-username').innerText = currentUser;

            // Show navigation bar
            document.querySelector('.nav-bar').classList.remove('hidden');

            if (isOnline) {
                document.getElementById('status-badge').classList.add('online');
                document.getElementById('status-badge').innerText = 'Online';
            }

            // NEU: TestUser Back Button
            const header = document.querySelector('header');
            const existingBtn = document.getElementById('btn-back-admin');
            if (currentUser === 'TestUser') {
                if (!existingBtn) {
                    const btn = document.createElement('button');
                    btn.id = 'btn-back-admin';
                    btn.innerHTML = '<i class="fas fa-shield-alt"></i> Zurück zu Admin';
                    // Centered Position
                    btn.style.cssText = "background:var(--primary); border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.8rem; position:absolute; left:50%; transform:translateX(-50%); white-space:nowrap;";
                    btn.onclick = () => {
                        currentUser = 'Admin';
                        startApp();
                    };
                    header.appendChild(btn);
                }
            } else {
                if (existingBtn) existingBtn.remove();
            }

            if (currentUser === 'Admin') {
                // Admin Navigation anzeigen, normale Nav ausblenden
                document.getElementById('nav-admin').classList.remove('hidden');
                document.getElementById('nav-shop-admin').classList.remove('hidden');
                document.getElementById('nav-user-admin').classList.remove('hidden');
                document.getElementById('nav-badge-admin').classList.remove('hidden');
                document.getElementById('nav-log-admin').classList.remove('hidden');

                // Normale Navigation ausblenden
                if (document.getElementById('nav-casino')) document.getElementById('nav-casino').classList.add('hidden');

                const navHome = document.querySelector('.nav-bar button[onclick="nav(\'home\')"]');
                if (navHome) navHome.classList.add('hidden');

                const navLeaderboard = document.querySelector('.nav-bar button[onclick="nav(\'leaderboard\')"]');
                if (navLeaderboard) navLeaderboard.classList.add('hidden');

                const navShop = document.querySelector('.nav-bar button[onclick="nav(\'shop\')"]');
                if (navShop) navShop.classList.add('hidden');

                const navProfile = document.querySelector('.nav-bar button[onclick="nav(\'profile\')"]');
                if (navProfile) navProfile.classList.add('hidden');

                // Admin startet auf Admin-Seite
                nav('admin');
            } else {
                // Normale User-Navigation
                document.getElementById('nav-admin').classList.add('hidden');
                document.getElementById('nav-shop-admin').classList.add('hidden');
                document.getElementById('nav-user-admin').classList.add('hidden');
                document.getElementById('nav-badge-admin').classList.add('hidden');
                document.getElementById('nav-log-admin').classList.add('hidden');

                if (document.getElementById('nav-casino')) document.getElementById('nav-casino').classList.remove('hidden');

                const navHome = document.querySelector('.nav-bar button[onclick="nav(\'home\')"]');
                if (navHome) navHome.classList.remove('hidden');

                const navLeaderboard = document.querySelector('.nav-bar button[onclick="nav(\'leaderboard\')"]');
                if (navLeaderboard) navLeaderboard.classList.remove('hidden');

                const navShop = document.querySelector('.nav-bar button[onclick="nav(\'shop\')"]');
                if (navShop) navShop.classList.remove('hidden');

                const navProfile = document.querySelector('.nav-bar button[onclick="nav(\'profile\')"]');
                if (navProfile) navProfile.classList.remove('hidden');

                const total = calculateTotalScore(currentUser);
                unreadLobs = total - db.users[currentUser].lastSeenScore;
                updateActivityBadge();
                nav('home');
            }
        }

        function renderCasinoMainMenu() {
            if (!currentBetSource) return;

            const lobAmount = db.users[currentUser].received[currentBetSource] || 0;
            const chipsAmount = (db.users[currentUser].chips && db.users[currentUser].chips[currentBetSource]) || 0;
            const settings = getCasinoSettings().casino;

            // Update Balance Display
            document.getElementById('casino-balance-display').innerHTML = `
                <div style="font-size:1.1rem; color:gold;"><i class="fas fa-coins"></i> ${chipsAmount} Chips</div>
                <div style="font-size:0.8rem; color:var(--text-muted);">Konto: ${currentBetSource} (${lobAmount} Lobs)</div>
            `;

            // Update Converter Info
            const convInfo = document.getElementById('converter-lob-available');
            if (convInfo) convInfo.innerText = lobAmount;

            // Update Exchange Rates Display
            if (document.getElementById('ex-rate-display')) document.getElementById('ex-rate-display').innerText = settings.exchangeRate;
            if (document.getElementById('ex-rate-back-display')) document.getElementById('ex-rate-back-display').innerText = settings.exchangeRate;

            // Update Game Costs
            if (document.getElementById('menu-bj-cost')) document.getElementById('menu-bj-cost').innerText = `Einsatz: ${settings.blackjackCost} Chip(s)`;
        }

        function logout() {
            if (currentUser !== 'Admin' && currentUser !== 'TestUser' && db.users[currentUser]) {
                db.users[currentUser].autoLogin = false;
                save();
            }
            localStorage.removeItem('lobAutoUser');

            // Hide navigation bar before reload
            document.querySelector('.nav-bar').classList.add('hidden');

            location.reload();
        }

        function updateActivityBadge() {
            // Versuche Badge auf Home-Button zu setzen, da nav-activity nicht existiert
            const navHome = document.querySelector('.nav-bar button[onclick="nav(\'home\')"]');
            if (!navHome) return;

            let badge = navHome.querySelector('.notification-badge');

            if (unreadLobs > 0) {
                if (!badge) {
                    badge = document.createElement('div');
                    badge.className = 'notification-badge';
                    navHome.appendChild(badge);
                }
            } else {
                if (badge) {
                    navHome.removeChild(badge);
                }
            }
        }

        function checkNewLobs(user) {
            if (user === 'Admin' || user === 'TestUser') return;

            const currentTotal = calculateTotalScore(user);
            const data = db.users[user];
            const diff = currentTotal - data.lastSeenScore;
            unreadLobs = diff;

            if (diff > 0) {
                setTimeout(() => {
                    fireConfetti(diff * 50);
                    Swal.fire({
                        title: `Du hast ${diff} neue Lobs!`, text: 'Gut gemacht!', icon: 'success',
                        background: '#1a1a1a', color: '#fff', confirmButtonColor: '#ff4d6d', backdrop: `rgba(0,0,123,0.4)`
                    });

                    data.lastSeenScore = currentTotal;
                    save();
                }, 500);
            }
            updateActivityBadge();
            checkBadges(user, currentTotal);
        }

        // --- NAVIGATION ---
        function nav(tab) {
            // Smooth Transition: Fade out current
            const activeTabs = document.querySelectorAll('.fade-in:not(.hidden)');
            activeTabs.forEach(t => {
                t.style.opacity = '0';
                t.style.transform = 'scale(0.98)';
                setTimeout(() => {
                    t.classList.add('hidden');
                    t.style.opacity = '';
                    t.style.transform = '';
                }, 200);
            });

            // Wait for fade out (short delay) or immediate if first load
            setTimeout(() => {
                // Alle Tabs ausblenden (Safety)
                ['home', 'activity', 'leaderboard', 'shop', 'profile', 'admin', 'user-admin', 'badge-admin', 'log-admin', 'casino', 'shop-admin'].forEach(t => {
                    const el = document.getElementById('tab-' + t);
                    if (el) el.classList.add('hidden');
                });

                // Alle Nav-Items deaktivieren
                document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));

                // Explicitly hide Sports Betting View if open
                const sportsView = document.getElementById('sports-betting-view');
                if (sportsView && !sportsView.classList.contains('hidden')) {
                    sportsView.classList.add('hidden');
                }

                // Special handling for shop-admin nav button
                let activeButton;
                if (tab === 'shop-admin') {
                    activeButton = document.getElementById('nav-shop-admin');
                    const target = document.getElementById('tab-shop-admin');
                    target.classList.remove('hidden');
                    // Trigger reflow
                    void target.offsetWidth;
                    target.classList.add('visible'); // Add visible class for CSS transition if needed
                } else {
                    activeButton = document.querySelector(`.nav-bar button[onclick="nav('${tab}')"]`);
                    const tabEl = document.getElementById('tab-' + tab);
                    if (tabEl) {
                        tabEl.classList.remove('hidden');
                        // Trigger reflow
                        void tabEl.offsetWidth;
                        tabEl.classList.add('visible');
                    }
                }

                if (activeButton) activeButton.classList.add('active');

                if (currentUser !== 'Admin') {
                    let total = 0;
                    if (currentUser) {
                        try {
                            total = calculateTotalScore(currentUser);
                        } catch (e) {
                            console.error("Error calculating score:", e);
                        }
                    }

                    if (tab === 'activity') {
                        unreadLobs = 0;
                        updateActivityBadge();
                    }
                    if (tab === 'home') renderDashboard(total);
                    if (tab === 'activity') renderActivity();
                    if (tab === 'shop') renderShop();
                    if (tab === 'profile') renderProfile(); // Call renderProfile without total
                    if (tab === 'casino') renderCasino();

                    // Fallback für Admin-Tab wenn nicht eingeloggt
                    if (tab === 'admin') {
                        document.getElementById('tab-admin').innerHTML = `
                        <div class="section-header">Admin Bereich</div>
                        <div class="settings-card" style="text-align:center; padding: 40px 20px;">
                            <i class="fas fa-lock" style="font-size: 3rem; color: #666; margin-bottom: 20px;"></i>
                            <p>Bitte logge dich als Admin ein, um diesen Bereich zu sehen.</p>
                            <p style="font-size: 0.8rem; color: #888;">(Fingerabdruck-Icon auf dem Login-Screen)</p>
                        </div>
                    `;
                    }
                } else {
                    // Admin spezifische Navigations-Routinen
                    if (tab === 'shop-admin') renderAdminRewardList();
                    if (tab === 'user-admin') renderUserAdmin();
                    if (tab === 'badge-admin') renderBadgeAdmin();
                    if (tab === 'log-admin') renderLogList();
                    if (tab === 'admin') renderAdmin();
                }

                if (tab === 'leaderboard') renderLeaderboard();
            }, 50); // Short delay for transition
        }

        // NEU: Test Modus
        async function startTestMode() {
            // TestUser erstellen/resetten
            if (!db.users['TestUser']) {
                db.users['TestUser'] = {
                    password: "test",
                    image: "https://api.dicebear.com/7.x/bottts/svg?seed=Test",
                    lastSeenScore: 0,
                    received: {},
                    chips: {},
                    badges: [],
                    autoLogin: false,
                    settings: { mobileNotifications: false }
                };
            }

            // Unendlich Lobs/Chips geben
            const otherUsers = Object.keys(db.users).filter(u => u !== 'Admin' && u !== 'TestUser');
            otherUsers.forEach(u => {
                db.users['TestUser'].received[u] = 9999;
                db.users['TestUser'].chips[u] = 99999;
            });

            currentUser = 'TestUser';
            startApp();

            Swal.fire({
                icon: 'info',
                title: 'Test-Modus Aktiv',
                text: 'Du bist nun als "TestUser" mit unendlich Ressourcen eingeloggt.',
                background: '#1a1a1a', color: '#fff',
                timer: 2000, showConfirmButton: false
            });
        }

        // --- DASHBOARD (HOME) ---
        function renderDashboard(total) {
            document.getElementById('score-display').innerText = total;
            renderBadges(currentUser);

            const relevantScores = getRelevantScores(currentUser);
            const homeScoresDiv = document.getElementById('home-separate-scores');
            homeScoresDiv.innerHTML = '';

            let maxScore = total;

            if (relevantScores.length > 0) {
                relevantScores.forEach(s => {
                    if (s.score > maxScore) maxScore = s.score;

                    homeScoresDiv.innerHTML += `
                    <div class="score-display-small ${s.cssClass}">
                        <div><i class="fas fa-user${s.cssClass === 'thomas' ? '-circle' : ''}" style="color: ${s.cssClass === 'thomas' ? '#00bcd4' : (s.cssClass === 'emil' ? '#ff9900' : 'gold')};"></i> Konto ${s.name}</div>
                        <div>${s.score}</div>
                    </div>
                `;
                });
            } else {
                homeScoresDiv.innerHTML = `<div style="text-align: center; color: var(--text-muted); padding: 10px;">Noch keine individuellen Konten gefüllt.</div>`;
            }

            const list = document.getElementById('lob-list');
            list.innerHTML = '';
            Object.keys(db.users).forEach(u => {
                if (u !== currentUser && u !== 'Admin' && u !== 'TestUser') { // Admin und TestUser ausschließen
                    list.innerHTML += `
                    <div class="lob-target-btn" onclick="openLobMenu('${u}')">
                        <div class="avatar" style="background-image:url('${db.users[u].image}'); width:50px; height:50px; margin-right: 15px;"></div>
                        <div class="btn-info">
                            <div class="btn-name">${u}</div>
                            <div class="btn-action">Tippen zum Loben</div>
                        </div>
                        <i class="fas fa-chevron-right" style="color:#444; margin-left: auto;"></i>
                    </div>
                `;
                }
            });

            // Verstecke die "Nächste Prämie"-Box
            const rewardBox = document.getElementById('reward-tracking-box');
            rewardBox.classList.add('hidden');

            // NEU: Ziel-Prämie anzeigen
            renderGoalReward(maxScore);
        }

        // --- LOBEN FUNKTIONEN ---
        async function openLobMenu(targetUser) {
            let options = {};
            for (let i = 1; i <= 10; i++) {
                options[i] = `${i} Lob${i > 1 ? 's' : ''}`;
            }

            const { value: formValues } = await Swal.fire({
                title: `Lob für ${targetUser}`,
                html: `
                <p>Wähle die Anzahl der Lobs, die du geben möchtest:</p>
                <select id="swal-select-count" class="swal2-input">
                    ${Object.entries(options).map(([val, text]) => `<option value="${val}">${text}</option>`).join('')}
                </select>
                <input id="swal-reason" class="swal2-input" placeholder="Grund (optional)">
            `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Lob senden',
                confirmButtonColor: 'var(--primary)',
                background: '#1a1a1a', color: '#fff',
                preConfirm: () => {
                    return [
                        document.getElementById('swal-select-count').value,
                        document.getElementById('swal-reason').value
                    ]
                }
            });

            if (formValues) {
                sendLob(targetUser, parseInt(formValues[0]), formValues[1]);
            }
        }

        async function sendLob(targetUser, count, reason = '') {
            if (count <= 0 || !db.users[targetUser] || !db.users[targetUser].received) return;

            // Speichere die Aktion für Undo
            const senderKey = currentUser === 'Admin' ? 'Admin' : currentUser;
            const logId = Date.now();

            // NEU: Nur NICHT-Admin-User können Lob empfangen
            if (targetUser !== 'Admin') {
                db.users[targetUser].received[senderKey] = (db.users[targetUser].received[senderKey] || 0) + count;
            }

            const reasonText = reason ? ` Grund: ${reason}` : '';
            db.logs.unshift({
                id: logId,
                time: new Date().toLocaleString(),
                msg: `${currentUser} lobt ${targetUser} mit ${count} Punkten. (LOB)${reasonText}`,
                sender: currentUser,
                receiver: targetUser,
                amount: count,
                reason: reason
            });

            // Speichere für Undo
            lastLobAction = {
                logId: logId,
                sender: currentUser,
                receiver: targetUser,
                amount: count,
                senderKey: senderKey
            };

            await save();
            fireConfetti(100);

            // Update der lokalen Ansicht
            if (currentUser !== 'Admin') {
                nav('home');
            } else {
                nav('admin');
            }

            // Zeige Erfolg mit Undo-Button
            const undoHtml = `
                <div style="margin-top: 15px;">
                    <button id="undo-btn" class="btn-main" style="background: #ff9800; font-size: 0.9rem;">
                        <i class="fas fa-undo"></i> Rückgängig machen
                    </button>
                    <div id="undo-timer" style="margin-top: 8px; font-size: 0.8rem; color: var(--text-muted);">
                        Verfügbar für <span id="countdown">5</span> Sekunden
                    </div>
                </div>
            `;

            Swal.fire({
                title: 'Lob gesendet!',
                html: `
                    <p>Du hast ${targetUser} erfolgreich ${count} Lobs gegeben.</p>
                    ${undoHtml}
                `,
                icon: 'success',
                background: '#1a1a1a',
                color: '#fff',
                confirmButtonText: 'OK',
                confirmButtonColor: '#ff4d6d',
                showConfirmButton: true,
                allowOutsideClick: false,
                didOpen: () => {
                    let timeLeft = 5;
                    const undoBtn = document.getElementById('undo-btn');
                    const countdownEl = document.getElementById('countdown');

                    // Undo-Button Click-Handler
                    undoBtn.addEventListener('click', () => {
                        undoLastLob();
                        Swal.close();
                    });

                    // Countdown-Timer
                    const timer = setInterval(() => {
                        timeLeft--;
                        if (countdownEl) countdownEl.textContent = timeLeft;

                        if (timeLeft <= 0) {
                            clearInterval(timer);
                            lastLobAction = null;
                            if (undoBtn) {
                                undoBtn.disabled = true;
                                undoBtn.style.opacity = '0.5';
                                undoBtn.innerHTML = '<i class="fas fa-clock"></i> Abgelaufen';
                            }
                        }
                    }, 1000);
                }
            });
        }

        // Undo-Funktion
        async function undoLastLob() {
            if (!lastLobAction) {
                Swal.fire('Fehler', 'Keine rückgängig zu machende Aktion gefunden.', 'error');
                return;
            }

            const { logId, receiver, amount, senderKey } = lastLobAction;

            // Entferne Lob vom Empfänger
            if (db.users[receiver] && db.users[receiver].received[senderKey]) {
                db.users[receiver].received[senderKey] -= amount;
                if (db.users[receiver].received[senderKey] <= 0) {
                    delete db.users[receiver].received[senderKey];
                }
            }

            // Lösche Log-Eintrag
            db.logs = db.logs.filter(log => log.id !== logId);

            // Reset
            lastLobAction = null;

            await save();

            // Update UI
            if (currentUser !== 'Admin') {
                nav('home');
            } else {
                nav('admin');
            }

            Swal.fire({
                title: 'Rückgängig gemacht!',
                text: 'Die Lob-Aktion wurde erfolgreich rückgängig gemacht.',
                icon: 'info',
                background: '#1a1a1a',
                color: '#fff',
                confirmButtonColor: '#ff4d6d',
                timer: 2000,
                showConfirmButton: false
            });
        }

        // --- AKTIVITÄT ---
        function renderActivity() {
            const logDiv = document.getElementById('activity-log');
            logDiv.innerHTML = '';

            if (currentUser === 'Admin') {
                logDiv.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding: 20px;">Admin nutzt das Protokoll im Admin-Tab.</div>`;
                return;
            }

            const filteredLogs = db.logs.filter(log => log.sender === currentUser || log.receiver === currentUser);

            if (filteredLogs.length === 0) {
                logDiv.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding: 20px;">Noch keine Aktivitäten.</div>`;
                return;
            }

            filteredLogs.forEach(log => {
                const isSent = log.sender === currentUser;
                const style = isSent ? 'color: var(--danger);' : 'color: var(--accent);';
                const icon = isSent ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';
                const actionText = isSent ? `An ${log.receiver}` : `Von ${log.sender}`;
                const amount = log.amount || (log.msg.includes('Kosten') ? '-' + log.msg.match(/Kosten: (\d+)/)[1] : '');

                logDiv.innerHTML += `
                <div class="log-entry">
                    <div class="log-content">
                        <div style="font-weight: 600;">
                            <span style="${style}">${icon} ${isSent ? 'GESENDET' : 'ERHALTEN'}</span>
                            <span style="font-size: 0.8rem; color: var(--text-muted); margin-left: 10px;">${log.time.split(',')[0]}</span>
                        </div>
                        <div style="font-size: 0.9rem;">
                            ${log.msg.includes('(REWARD)') ? log.msg.split('gelöst')[0] + ' eingelöst' : log.msg.split('lobt')[0] + ' Lob gegeben'}
                            ${log.reason ? `<br><span style="font-size:0.8rem; color:#aaa; font-style:italic;">"${log.reason}"</span>` : ''}
                        </div>
                    </div>
                    <div style="font-size: 1.2rem; font-weight: 700; ${style}">${amount}</div>
                </div>
            `;
            });

            // WICHTIG: Setze lastSeenScore auf den aktuellen Gesamtscore nach dem Anschauen der Aktivität
            if (currentUser && currentUser !== 'Admin') {
                db.users[currentUser].lastSeenScore = calculateTotalScore(currentUser);
                save();
            }
        }

        // --- ZIEL-PRÄMIE (SPARFUNKTION) ---
        function renderGoalReward(maxScore) {
            const goalDisplay = document.getElementById('goal-display');
            const userData = db.users[currentUser];

            if (!userData || !userData.goals || Object.keys(userData.goals).length === 0) {
                goalDisplay.classList.add('hidden');
                return;
            }

            goalDisplay.classList.remove('hidden');
            const relevantScores = getRelevantScores(currentUser);

            let goalsHtml = '';
            for (const [sourceName, rewardId] of Object.entries(userData.goals)) {
                const goalReward = db.rewards.find(r => r.id === rewardId);
                if (!goalReward) continue;

                const accountData = relevantScores.find(s => s.name === sourceName);
                const currentScore = accountData ? accountData.score : 0;
                const progress = Math.min(100, (currentScore / goalReward.cost) * 100);
                const missing = Math.max(0, goalReward.cost - currentScore);
                const icon = REWARD_ICONS[goalReward.name] || REWARD_ICONS['default'];

                // Filling icon effect using linear gradient
                const fillColor = accountData?.cssClass === 'thomas' ? '#00bcd4' : (accountData?.cssClass === 'emil' ? '#ff9900' : 'gold');
                const fillingIcon = `<div style="font-size: 3rem; background: linear-gradient(to top, ${fillColor} ${progress}%, #444 ${progress}%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 10px;">${icon}</div>`;

                goalsHtml += `
                    <div class="goal-card" style="margin-bottom: 15px;">
                        <div style="text-align: center;">
                            ${fillingIcon}
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent); margin-top: 10px;">${goalReward.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 10px;">Konto: ${sourceName}</div>
                            
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem;">
                                <span style="color: var(--text-muted);">Fortschritt</span>
                                <span style="color: #fff; font-weight: 600;">${currentScore} / ${goalReward.cost}</span>
                            </div>
                            
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                            
                            ${missing > 0 ? `<div style="margin-top: 8px; color: var(--accent); font-size: 0.85rem;">Noch ${missing} Lobs!</div>` : `<div style="margin-top: 8px; color: #4CAF50; font-size: 0.85rem;"><i class="fas fa-check-circle"></i> Erreicht!</div>`}
                            
                            <button class="btn-main" onclick="removeGoalForSource('${sourceName}')" style="background: #444; margin-top: 10px; font-size: 0.8rem; padding: 8px;">
                                <i class="fas fa-times"></i> Entfernen
                            </button>
                        </div>
                    </div>
                `;
            }

            goalDisplay.innerHTML = `
                <div class="section-header" style="margin-top: 25px;"><i class="fas fa-bullseye"></i> Deine Sparziele</div>
                ${goalsHtml}
            `;
        }

        async function setGoalReward(rewardId) {
            if (currentUser === 'Admin') return;

            // If no shop account is selected, check if we can auto-select
            if (!selectedShopAccount) {
                const relevantScores = getRelevantScores(currentUser);
                const filteredScores = relevantScores.filter(s => s.name !== 'Admin');

                if (filteredScores.length === 0) {
                    Swal.fire('Info', 'Keine Konten verfügbar.', 'info');
                    return;
                }

                // If only one account, auto-select it
                if (filteredScores.length === 1) {
                    selectedShopAccount = filteredScores[0].name;
                } else {
                    Swal.fire('Info', 'Bitte wähle zuerst oben ein Konto aus.', 'info');
                    return;
                }
            }

            // Store goal for this specific source
            if (!db.users[currentUser].goals) db.users[currentUser].goals = {};
            db.users[currentUser].goals[selectedShopAccount] = rewardId;
            await save();

            const reward = db.rewards.find(r => r.id === rewardId);
            Swal.fire({
                icon: 'success',
                title: 'Ziel gesetzt!',
                text: `"${reward.name}" ist jetzt dein Sparziel auf Konto ${selectedShopAccount}.`,
                background: '#1a1a1a',
                color: '#fff',
                confirmButtonColor: '#ff4d6d'
            });

            // Refresh shop to show updated state
            renderShop();
        }

        async function removeGoalForSource(sourceName) {
            if (currentUser === 'Admin') return;

            const { isConfirmed } = await Swal.fire({
                title: 'Ziel entfernen?',
                text: `Möchtest du das Sparziel für Konto ${sourceName} wirklich entfernen?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ja, entfernen',
                cancelButtonText: 'Abbrechen',
                background: '#1a1a1a',
                color: '#fff',
                confirmButtonColor: '#ff4d6d'
            });

            if (isConfirmed) {
                if (db.users[currentUser].goals && db.users[currentUser].goals[sourceName]) {
                    delete db.users[currentUser].goals[sourceName];
                    await save();
                    nav('home');
                }
            }
        }

        // Legacy function for compatibility
        async function removeGoalReward() {
            // Remove all goals
            if (currentUser === 'Admin') return;
            db.users[currentUser].goals = {};
            await save();
            nav('home');
        }

        // KORRIGIERTE renderShop() - MIT ACCOUNT SELECTION
        function renderShop() {
            const shopScoresDiv = document.getElementById('shop-separate-scores');
            shopScoresDiv.innerHTML = '';

            // 1. KONTO-AUSWAHL (Toggle)
            const relevantScores = getRelevantScores(currentUser);
            // Filtere Admin-Konto aus
            const filteredScores = relevantScores.filter(s => s.name !== 'Admin');

            if (filteredScores.length === 0) {
                shopScoresDiv.innerHTML = `<div style="text-align: center; color: var(--text-muted); padding: 10px;">Keine Shop-Konten vorhanden.</div>`;
                return;
            }

            filteredScores.forEach(s => {
                const isSelected = selectedShopAccount === s.name;
                shopScoresDiv.innerHTML += `
                    <div class="score-display-small ${s.cssClass}" 
                         style="cursor:pointer; border: 2px solid ${isSelected ? 'var(--accent)' : 'transparent'}; opacity: ${selectedShopAccount && !isSelected ? '0.5' : '1'}; transform: ${isSelected ? 'scale(1.05)' : 'scale(1)'}; transition: all 0.2s;"
                         onclick="selectShopAccountToggle('${s.name}')">
                        <div>
                            <i class="fas fa-user" style="color: ${s.cssClass === 'thomas' ? '#00bcd4' : (s.cssClass === 'emil' ? '#ff9900' : 'gold')};"></i>
                            Konto ${s.name}
                        </div>
                        <div>${s.score}</div>
                    </div>
                `;
            });

            // 2. PRÄMIEN ANZEIGEN (Nur wenn Konto ausgewählt)
            const shopDiv = document.getElementById('shop-reward-list');
            shopDiv.innerHTML = '';

            if (!selectedShopAccount) {
                shopDiv.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-arrow-up" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Bitte wähle oben ein Konto aus, um einzukaufen oder Ziele zu setzen.</p>
                    </div>
                `;
                return;
            }

            // Hole Score des ausgewählten Kontos
            const selectedAccountData = filteredScores.find(s => s.name === selectedShopAccount);
            const currentScore = selectedAccountData ? selectedAccountData.score : 0;

            db.rewards.forEach(r => {
                const canAfford = currentScore >= r.cost;
                const icon = REWARD_ICONS[r.name] || REWARD_ICONS['default'];

                let missingText = '';
                if (!canAfford) {
                    const missingAmount = r.cost - currentScore;
                    missingText = `<div class="shop-missing-info">(fehlen ${missingAmount} Lobs)</div>`;
                }

                // NEU: Ziel-Button
                // Check if this reward is the current goal for the SELECTED account
                const userData = db.users[currentUser];
                const isCurrentGoal = (currentUser !== 'Admin' && userData.goals && userData.goals[selectedShopAccount] === r.id);

                const goalButton = currentUser !== 'Admin' ? `
                    <button class="btn-main" onclick="event.stopPropagation(); ${isCurrentGoal ? `removeGoalForSource('${selectedShopAccount}')` : `setGoalReward(${r.id})`}" 
                        style="background: ${isCurrentGoal ? 'var(--accent)' : '#00bcd4'}; font-size: 0.8rem; padding: 8px; margin-top: 8px; width: 100%;">
                        <i class="fas ${isCurrentGoal ? 'fa-check' : 'fa-bullseye'}"></i> ${isCurrentGoal ? 'Aktuelles Ziel' : 'Als Ziel setzen'}
                    </button>
                ` : '';

                shopDiv.innerHTML += `
                <div class="shop-item-card ${canAfford ? '' : 'disabled'}" onclick="${canAfford ? `openShopItem(${r.id})` : ''}" style="${!canAfford ? 'cursor:not-allowed; opacity:0.7;' : ''}">
                    <div class="shop-icon">${icon}</div>
                    <div style="font-weight:700;">${r.name}</div>
                    <div class="shop-cost">${r.cost} Lobs</div>
                    ${missingText}
                    ${goalButton}
                </div>
            `;
            });
        }

        function selectShopAccountToggle(name) {
            if (selectedShopAccount === name) {
                selectedShopAccount = null; // Deselect
            } else {
                selectedShopAccount = name;
            }
            renderShop();
        }

        // NEUE openShopItem(id) - Nutzt selectedShopAccount
        async function setGoal(itemId) {
            let targetAccount = selectedShopAccount;

            if (!targetAccount) {
                // Prompt user to select an account
                const accounts = Object.keys(db.users).filter(u => u !== 'Admin' && u !== 'TestUser');
                const { value: selectedAccount } = await Swal.fire({
                    title: 'Konto auswählen',
                    text: 'Für wen möchtest du dieses Ziel setzen?',
                    input: 'select',
                    inputOptions: accounts.reduce((acc, curr) => ({ ...acc, [curr]: curr }), {}),
                    inputPlaceholder: 'Wähle ein Konto',
                    showCancelButton: true,
                    inputValidator: (value) => {
                        return new Promise((resolve) => {
                            if (value) {
                                resolve();
                            } else {
                                resolve('Du musst ein Konto auswählen');
                            }
                        });
                    }
                });

                if (selectedAccount) {
                    targetAccount = selectedAccount;
                } else {
                    return; // Cancelled
                }
            }

            const item = db.rewards.find(r => r.id === itemId);
            if (!item) return;

            db.users[targetAccount].goal = itemId;
            await save();
            renderShop(); // Refresh to show active goal
            Swal.fire('Ziel gesetzt', `Du sparst nun auf: ${item.name}`, 'success');
        }
        async function openShopItem(id) {
            if (!selectedShopAccount) {
                Swal.fire('Info', 'Bitte wähle zuerst ein Konto aus.', 'info');
                return;
            }

            const reward = db.rewards.find(r => r.id === id);

            const { isConfirmed } = await Swal.fire({
                title: 'Prämie kaufen?',
                text: `Möchtest du "${reward.name}" für ${reward.cost} Lobs kaufen? (Konto: ${selectedShopAccount})`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ja, kaufen',
                background: '#1a1a1a', color: '#fff',
                confirmButtonColor: 'var(--primary)'
            });

            if (isConfirmed) {
                redeemReward(id, selectedShopAccount);
            }
        }

        async function redeemReward(id, scoreSource) {
            const reward = db.rewards.find(r => r.id === id);

            let currentScore = 0;
            let success = false;
            // Assuming this logic is handled elsewhere or needs to be added
            // For now, let's simulate success if enough Lobs
            if (db.users[currentUser].received[scoreSource] >= reward.cost) {
                db.users[currentUser].received[scoreSource] -= reward.cost;
                success = true;
            }

            if (success) {
                db.logs.unshift({
                    id: Date.now(),
                    time: new Date().toLocaleString(),
                    msg: `${currentUser} löst Prämie '${reward.name}' ein. Belastet: Konto ${scoreSource}. Kosten: ${reward.cost} (REWARD)`
                });

                await save();

                renderShop();
                if (currentUser !== 'Admin') renderDashboard(calculateTotalScore(currentUser));

                Swal.fire('Erfolgreich eingelöst!', `Der Lob-Stand von Konto ${scoreSource} wurde um ${reward.cost} reduziert.`, 'success');
            } else {
                Swal.fire('Fehlgeschlagen', 'Der Kontostand ist nicht ausreichend für diese Prämie.', 'error');
            }
        }


        // --- CASINO & BLACKJACK ---
        let bjDeck = [];
        let bjDealerHand = [];
        let bjPlayerHand = [];
        let bjGameOver = true;
        let currentBetSource = null;
        let selectedShopAccount = null; // NEU: Für Shop-Auswahl

        // Coin Flip State
        let cfStake = 0;
        let cfActive = false;

        // NEU: Full Page Casino Settings Logic
        function openCasinoSettingsPage() {
            if (!db.appSettings) db.appSettings = {};
            if (!db.appSettings.casino) db.appSettings.casino = { exchangeRate: 10, blackjackCost: 1 };
            if (!db.appSettings.slots) db.appSettings.slots = [];
            if (!db.appSettings.timezone) db.appSettings.timezone = 'Europe/Berlin'; // Default

            const settings = getCasinoSettings();
            document.getElementById('page-casino-rate').value = settings.casino.exchangeRate;
            document.getElementById('page-casino-bj-cost').value = settings.casino.blackjackCost;
            document.getElementById('page-casino-bj-payout').value = settings.casino.blackjackPayout;
            document.getElementById('page-casino-roulette-cost').value = settings.casino.rouletteCost;
            document.getElementById('page-casino-slots-cost').value = settings.casino.slotsCost;
            document.getElementById('page-casino-slots-chance').value = settings.casino.slotWinChance;
            document.getElementById('page-casino-cf-cost').value = settings.casino.coinFlipCost;
            document.getElementById('page-casino-cf-edge').value = settings.casino.coinFlipHouseEdge;

            document.getElementById('page-casino-slots').value = settings.slots.join(',');
            document.getElementById('page-casino-timezone').value = settings.timezone;

            nav('admin'); // Ensure we are in admin context visually if needed, but we are overlaying
            document.getElementById('admin-casino-settings-view').classList.remove('hidden');
            document.getElementById('tab-admin').classList.add('hidden'); // Hide main admin tab
        }

        function closeCasinoSettingsPage() {
            document.getElementById('admin-casino-settings-view').classList.add('hidden');
            document.getElementById('tab-admin').classList.remove('hidden');
        }

        async function saveCasinoSettingsPage() {
            const rate = parseInt(document.getElementById('page-casino-rate').value);
            const bjCost = parseInt(document.getElementById('page-casino-bj-cost').value);
            const bjPayout = parseFloat(document.getElementById('page-casino-bj-payout').value);
            const rouletteCost = parseInt(document.getElementById('page-casino-roulette-cost').value);
            const slotsCost = parseInt(document.getElementById('page-casino-slots-cost').value);
            const slotChance = parseInt(document.getElementById('page-casino-slots-chance').value);
            const cfCost = parseInt(document.getElementById('page-casino-cf-cost').value);
            const cfEdge = parseInt(document.getElementById('page-casino-cf-edge').value);

            const slotsStr = document.getElementById('page-casino-slots').value;
            const timezone = document.getElementById('page-casino-timezone').value;

            if (isNaN(rate) || isNaN(bjCost) || isNaN(rouletteCost) || isNaN(slotsCost) || isNaN(cfCost)) {
                Swal.fire('Fehler', 'Bitte gültige Zahlen eingeben.', 'error');
                return;
            }

            db.appSettings.casino.exchangeRate = rate;
            db.appSettings.casino.blackjackCost = bjCost;
            db.appSettings.casino.blackjackPayout = bjPayout || 1.5;
            db.appSettings.casino.rouletteCost = rouletteCost;
            db.appSettings.casino.slotsCost = slotsCost;
            db.appSettings.casino.slotWinChance = slotChance || 30;
            db.appSettings.casino.coinFlipCost = cfCost;
            db.appSettings.casino.coinFlipHouseEdge = cfEdge || 5;

            db.appSettings.slots = slotsStr.split(',').map(s => s.trim()).filter(s => s);
            db.appSettings.timezone = timezone;

            await save();
            Swal.fire({
                icon: 'success',
                title: 'Gespeichert',
                text: 'Einstellungen wurden übernommen.',
                background: '#1a1a1a', color: '#fff',
                timer: 1500, showConfirmButton: false
            });
            closeCasinoSettingsPage();
        }

        // Slots State
        let slotSpinning = false;

        function getCasinoSettings() {
            if (!db.appSettings) db.appSettings = {};
            if (!db.appSettings.casino) db.appSettings.casino = {
                exchangeRate: 10,
                blackjackCost: 1,
                blackjackPayout: 1.5,
                rouletteCost: 1,
                slotsCost: 1,
                slotWinChance: 30,
                coinFlipCost: 1,
                coinFlipHouseEdge: 5
            };
            // Ensure new properties exist if old structure is present
            if (typeof db.appSettings.casino.blackjackPayout === 'undefined') db.appSettings.casino.blackjackPayout = 1.5;
            if (typeof db.appSettings.casino.rouletteCost === 'undefined') db.appSettings.casino.rouletteCost = 1;
            if (typeof db.appSettings.casino.slotsCost === 'undefined') db.appSettings.casino.slotsCost = 1;
            if (typeof db.appSettings.casino.slotWinChance === 'undefined') db.appSettings.casino.slotWinChance = 30;
            if (typeof db.appSettings.casino.coinFlipCost === 'undefined') db.appSettings.casino.coinFlipCost = 1;
            if (typeof db.appSettings.casino.coinFlipHouseEdge === 'undefined') db.appSettings.casino.coinFlipHouseEdge = 5;

            if (!db.appSettings.slots) db.appSettings.slots = ['🍒', '🍋', '🍉', '⭐', '💎', '7️⃣']; // Default Emojis
            if (!db.appSettings.timezone) db.appSettings.timezone = 'Europe/Berlin';
            return db.appSettings;
        }

        function renderCasino() {
            // Reset View State
            document.getElementById('casino-account-selection').classList.remove('hidden');
            document.getElementById('casino-main-menu').classList.add('hidden');
            document.getElementById('casino-exchange-menu').classList.add('hidden');

            // Hide all game views with correct IDs
            const gameViews = ['blackjack-game', 'roulette-game', 'slots-game', 'coin-flip-view', 'sports-betting-view'];
            gameViews.forEach(viewId => {
                const view = document.getElementById(viewId);
                if (view) view.classList.add('hidden');
            });

            const grid = document.getElementById('casino-accounts-list');
            grid.innerHTML = '';

            const received = db.users[currentUser].received;

            // 1. Alle anderen User (immer anzeigen)
            const otherUsers = Object.keys(db.users).filter(u => u !== 'Admin' && u !== 'TestUser' && u !== currentUser);

            // 2. Admin/Casino (nur wenn > 0)
            const specialSources = ['Admin', 'Casino'].filter(s => received[s] > 0);

            // Kombinierte Liste
            const displaySources = [...otherUsers, ...specialSources];

            displaySources.forEach(source => {
                const amount = received[source] || 0;
                const chips = (db.users[currentUser].chips && db.users[currentUser].chips[source]) || 0;

                let iconHtml = '<i class="fas fa-user"></i>';
                if (db.users[source] && db.users[source].image) {
                    iconHtml = `<img src="${db.users[source].image}" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border: 2px solid #333;">`;
                } else if (source === 'Casino') {
                    iconHtml = '<i class="fas fa-dice" style="font-size: 2rem;"></i>';
                }

                grid.innerHTML += `
                    <div class="shop-item-card account-select-card" onclick="selectCasinoAccount('${source}')">
                        <div class="shop-icon" style="margin-bottom:10px; display:flex; justify-content:center; align-items:center; height: 60px;">${iconHtml}</div>
                        <div style="font-weight:bold; font-size:0.9rem;">${source}</div>
                        <div class="shop-cost" style="color:var(--primary); font-size:0.9rem;">${amount} Lobs</div>
                        <div style="font-size:0.8rem; color:gold; margin-top:5px;">${chips} Chips</div>
                    </div>
                `;
            });
        }

        function selectCasinoAccount(source) {
            currentBetSource = source;

            // Hide all game views
            const gameViews = ['blackjack-game', 'roulette-game', 'slots-game', 'coin-flip-view', 'sports-betting-view'];
            gameViews.forEach(viewId => {
                const view = document.getElementById(viewId);
                if (view && !view.classList.contains('hidden')) {
                    view.classList.add('hidden');
                }
            });

            document.getElementById('casino-account-selection').classList.add('hidden');
            document.getElementById('casino-main-menu').classList.remove('hidden');
            renderCasinoMainMenu();
        }

        function backToAccountSelection() {
            currentBetSource = null;

            // Hide all game views
            const gameViews = ['blackjack-game', 'roulette-game', 'slots-game', 'coin-flip-view', 'sports-betting-view'];
            gameViews.forEach(viewId => {
                const view = document.getElementById(viewId);
                if (view && !view.classList.contains('hidden')) {
                    view.classList.add('hidden');
                }
            });

            renderCasino();
        }

        function renderCasinoMainMenu() {
            if (!currentBetSource) return;

            const lobAmount = db.users[currentUser].received[currentBetSource] || 0;
            const chipsAmount = (db.users[currentUser].chips && db.users[currentUser].chips[currentBetSource]) || 0;
            const settings = getCasinoSettings().casino;

            // Update Balance Display
            document.getElementById('casino-balance-display').innerHTML = `
                <div style="font-size:1.1rem; color:gold;"><i class="fas fa-coins"></i> ${chipsAmount} Chips</div>
                <div style="font-size:0.8rem; color:var(--text-muted);">Konto: ${currentBetSource} (${lobAmount} Lobs)</div>
            `;

            // Update Converter Info
            const convInfo = document.getElementById('converter-lob-available');
            if (convInfo) convInfo.innerText = lobAmount;

            // Update Exchange Rates Display
            if (document.getElementById('ex-rate-display')) document.getElementById('ex-rate-display').innerText = settings.exchangeRate;
            if (document.getElementById('ex-rate-back-display')) document.getElementById('ex-rate-back-display').innerText = settings.exchangeRate;

            // Update Game Costs
            if (document.getElementById('menu-bj-cost')) document.getElementById('menu-bj-cost').innerText = `Einsatz: ${settings.blackjackCost} Chip(s)`;

            // Sports Betting Visibility (TestUser only)
            const sportsBettingCard = document.getElementById('sports-betting-card');
            const sportsBettingComingSoon = document.getElementById('sports-betting-coming-soon');
            if (currentUser === 'TestUser') {
                if (sportsBettingCard) sportsBettingCard.style.display = 'flex';
                if (sportsBettingComingSoon) sportsBettingComingSoon.style.display = 'none';
            } else {
                if (sportsBettingCard) sportsBettingCard.style.display = 'none';
                if (sportsBettingComingSoon) sportsBettingComingSoon.style.display = 'flex';
            }
        }

        function openExchangeMenu() {
            document.getElementById('casino-main-menu').classList.add('hidden');
            document.getElementById('casino-exchange-menu').classList.remove('hidden');
            renderExchangeMenu();
        }

        function closeExchangeMenu() {
            document.getElementById('casino-exchange-menu').classList.add('hidden');
            document.getElementById('casino-main-menu').classList.remove('hidden');
            renderCasinoMainMenu();
        }

        function renderExchangeMenu() {
            if (!currentBetSource) return;
            const lobAmount = db.users[currentUser].received[currentBetSource] || 0;
            const chipsAmount = (db.users[currentUser].chips && db.users[currentUser].chips[currentBetSource]) || 0;

            document.getElementById('exchange-lob-balance').innerText = lobAmount;
            document.getElementById('exchange-chip-balance').innerText = chipsAmount;
        }

        async function convertLobToChips() {
            if (!currentBetSource) return;

            const lobAmount = db.users[currentUser].received[currentBetSource] || 0;

            if (lobAmount < 1) {
                Swal.fire('Fehler', 'Nicht genügend Lobs zum Umwandeln.', 'error');
                return;
            }

            const settings = getCasinoSettings().casino;

            // Deduct 1 Lob
            db.users[currentUser].received[currentBetSource] -= 1;
            if (db.users[currentUser].received[currentBetSource] === 0) delete db.users[currentUser].received[currentBetSource];

            // Add Chips based on rate
            if (!db.users[currentUser].chips) db.users[currentUser].chips = {};
            if (!db.users[currentUser].chips[currentBetSource]) db.users[currentUser].chips[currentBetSource] = 0;
            db.users[currentUser].chips[currentBetSource] += settings.exchangeRate;

            await save();
            renderExchangeMenu();

            Swal.fire({
                title: `+${settings.exchangeRate} Chips`,
                text: 'Erfolgreich umgewandelt!',
                icon: 'success',
                timer: 1000,
                showConfirmButton: false,
                background: '#1a1a1a', color: '#fff'
            });
        }

        async function convertChipsToLob() {
            if (!currentBetSource) return;

            const chipsAmount = (db.users[currentUser].chips && db.users[currentUser].chips[currentBetSource]) || 0;
            const settings = getCasinoSettings().casino;

            if (chipsAmount < settings.exchangeRate) {
                Swal.fire('Fehler', `Nicht genügend Chips (min. ${settings.exchangeRate}).`, 'error');
                return;
            }

            // Deduct Chips
            db.users[currentUser].chips[currentBetSource] -= settings.exchangeRate;

            // Add 1 Lob
            if (!db.users[currentUser].received[currentBetSource]) db.users[currentUser].received[currentBetSource] = 0;
            db.users[currentUser].received[currentBetSource] += 1;

            await save();
            renderExchangeMenu();

            Swal.fire({
                title: '+1 Lob',
                text: 'Erfolgreich zurückgetauscht!',
                icon: 'success',
                timer: 1000,
                showConfirmButton: false,
                background: '#1a1a1a', color: '#fff'
            });
        }

        function updateGameAccountDisplay(elementId) {
            if (!currentBetSource) return;
            const chips = (db.users[currentUser].chips && db.users[currentUser].chips[currentBetSource]) || 0;
            const el = document.getElementById(elementId);
            if (el) {
                el.innerHTML = `<i class="fas fa-coins"></i> ${currentBetSource}: ${chips} Chips`;
            }
        }

        // --- BLACKJACK ---
        function openBlackjack() {
            if (!currentBetSource) {
                Swal.fire('Fehler', 'Bitte wähle zuerst ein Konto aus.', 'error');
                return;
            }

            const settings = getCasinoSettings().casino;

            document.getElementById('casino-main-menu').classList.add('hidden');
            document.getElementById('blackjack-game').classList.remove('hidden');

            updateGameAccountDisplay('bj-account-info');

            document.getElementById('bj-message').innerText = `Einsatz: ${settings.blackjackCost} Chip(s)`;
            document.getElementById('bj-controls').classList.remove('hidden');
            document.getElementById('bj-actions').classList.add('hidden');
            document.getElementById('bj-btn-deal').classList.remove('hidden');
            document.getElementById('bj-btn-deal').innerText = `Austeilen (${settings.blackjackCost} Chip(s))`;

            // Reset table visual
            document.getElementById('bj-dealer-hand').innerHTML = '';
            document.getElementById('bj-player-hand').innerHTML = '';
            document.getElementById('bj-dealer-score').innerText = '0';
            document.getElementById('bj-player-score').innerText = '0';
        }

        function exitBlackjack() {
            document.getElementById('blackjack-game').classList.add('hidden');
            document.getElementById('casino-main-menu').classList.remove('hidden');
            renderCasinoMainMenu();
        }

        function createDeck() {
            const suits = ['♠', '♥', '♦', '♣'];
            const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            let deck = [];
            for (let suit of suits) {
                for (let value of values) {
                    deck.push({ suit, value });
                }
            }
            return deck;
        }

        function shuffleDeck(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }

        function getCardValue(card) {
            if (['J', 'Q', 'K'].includes(card.value)) return 10;
            if (card.value === 'A') return 11;
            return parseInt(card.value);
        }

        function calculateHandScore(hand) {
            let score = 0;
            let aces = 0;
            for (let card of hand) {
                score += getCardValue(card);
                if (card.value === 'A') aces++;
            }
            while (score > 21 && aces > 0) {
                score -= 10;
                aces--;
            }
            return score;
        }

        function renderHand(hand, elementId, hideFirst = false) {
            const el = document.getElementById(elementId);
            el.innerHTML = '';
            hand.forEach((card, index) => {
                if (hideFirst && index === 0) {
                    el.innerHTML += `<div class="playing-card playing-card-back"></div>`;
                } else {
                    const colorClass = (card.suit === '♥' || card.suit === '♦') ? 'red' : 'black';
                    el.innerHTML += `
                        <div class="playing-card ${colorClass} fade-in">
                            <div>${card.value}</div>
                            <div style="font-size:1.5rem;">${card.suit}</div>
                        </div>
                    `;
                }
            });
        }

        async function bjDeal() {
            if (!currentBetSource) {
                renderCasino();
                return;
            }

            const settings = getCasinoSettings().casino;

            // Deduct Chips
            if (!deductChipsFromSource(currentUser, currentBetSource, settings.blackjackCost)) {
                Swal.fire('Fehler', 'Nicht genügend Chips! Bitte tausche Lobs um.', 'error');
                return;
            }

            await save();
            updateGameAccountDisplay('bj-account-info');

            // Start Game
            bjDeck = createDeck();
            shuffleDeck(bjDeck);
            bjDealerHand = [bjDeck.pop(), bjDeck.pop()];
            bjPlayerHand = [bjDeck.pop(), bjDeck.pop()];
            bjGameOver = false;

            updateBjTable(true); // Hide dealer's first card

            document.getElementById('bj-btn-deal').classList.add('hidden');
            document.getElementById('bj-actions').classList.remove('hidden');
            document.getElementById('bj-message').innerText = "Deine Runde...";

            // Check for instant Blackjack
            const pScore = calculateHandScore(bjPlayerHand);
            if (pScore === 21) {
                setTimeout(bjStand, 500);
            }
        }

        function updateBjTable(hideDealer = false) {
            renderHand(bjDealerHand, 'bj-dealer-hand', hideDealer);
            renderHand(bjPlayerHand, 'bj-player-hand');

            document.getElementById('bj-player-score').innerText = calculateHandScore(bjPlayerHand);
            if (hideDealer) {
                document.getElementById('bj-dealer-score').innerText = "?";
            } else {
                document.getElementById('bj-dealer-score').innerText = calculateHandScore(bjDealerHand);
            }
        }

        function bjHit() {
            if (bjGameOver) return;
            bjPlayerHand.push(bjDeck.pop());
            updateBjTable(true);

            const score = calculateHandScore(bjPlayerHand);
            if (score > 21) {
                bjEndGame('bust');
            }
        }

        async function bjStand() {
            if (bjGameOver) return;

            // Dealer plays
            updateBjTable(false);

            const dealerPlay = async () => {
                while (calculateHandScore(bjDealerHand) < 17) {
                    await new Promise(r => setTimeout(r, 800));
                    bjDealerHand.push(bjDeck.pop());
                    updateBjTable(false);
                }

                const pScore = calculateHandScore(bjPlayerHand);
                const dScore = calculateHandScore(bjDealerHand);

                if (dScore > 21) {
                    bjEndGame('dealer_bust');
                } else if (pScore > dScore) {
                    bjEndGame('win');
                } else if (pScore < dScore) {
                    bjEndGame('lose');
                } else {
                    bjEndGame('push');
                }
            };

            dealerPlay();
        }

        async function bjEndGame(result) {
            bjGameOver = true;
            document.getElementById('bj-actions').classList.add('hidden');

            const msgEl = document.getElementById('bj-message');
            const settings = getCasinoSettings().casino;
            const bet = settings.blackjackCost;

            if (result === 'bust') {
                msgEl.innerText = "Überkauft! Du verlierst.";
                msgEl.style.color = "var(--danger)";
            } else if (result === 'lose') {
                msgEl.innerText = "Dealer gewinnt.";
                msgEl.style.color = "var(--danger)";
            } else if (result === 'dealer_bust') {
                msgEl.innerText = "Dealer überkauft! Du gewinnst!";
                msgEl.style.color = "gold";
                addChips(currentUser, bet * 2, currentBetSource);
                fireConfetti(50);
            } else if (result === 'win') {
                const pScore = calculateHandScore(bjPlayerHand);
                if (pScore === 21 && bjPlayerHand.length === 2) {
                    msgEl.innerText = "BLACKJACK! Du gewinnst fett!";
                    // Use configurable payout (default 1.5)
                    const payoutMult = settings.blackjackPayout || 1.5;
                    addChips(currentUser, Math.floor(bet * (1 + payoutMult)), currentBetSource);
                } else {
                    msgEl.innerText = "Gewonnen!";
                    msgEl.style.color = "gold";
                    addChips(currentUser, bet * 2, currentBetSource);
                }
                fireConfetti(50);
            } else if (result === 'push') {
                msgEl.innerText = "Unentschieden. Einsatz zurück.";
                msgEl.style.color = "#ccc";
                addChips(currentUser, bet, currentBetSource);
            }

            await save();
            updateGameAccountDisplay('bj-account-info');
            document.getElementById('bj-btn-deal').classList.remove('hidden');
        }

        // --- ROULETTE ---
        let rouletteBets = []; // Array of { type: 'number'|'color', value: 0-36|'red'|'black', amount: 10 }

        function openRoulette() {
            if (!currentBetSource) return;
            document.getElementById('casino-main-menu').classList.add('hidden');
            document.getElementById('roulette-game').classList.remove('hidden');
            updateGameAccountDisplay('roulette-account-info');

            renderRouletteBoard();
            clearRouletteBets();
        }

        function renderRouletteBoard() {
            const board = document.getElementById('roulette-board');
            board.innerHTML = '';

            // 0
            board.innerHTML += `<div class="roulette-cell green zero" onclick="placeRouletteBet('number', 0)" id="roulette-cell-0">0</div>`;

            // 1-36
            const reds = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];
            for (let i = 1; i <= 36; i++) {
                const color = reds.includes(i) ? 'red' : 'black';
                board.innerHTML += `<div class="roulette-cell ${color}" onclick="placeRouletteBet('number', ${i})" id="roulette-cell-${i}">${i}</div>`;
            }

            // Extra Betting Options (Red/Black)
            // Adding them below the grid for simplicity in grid layout
            // Or append to board if grid supports it. The CSS is 3 cols.
            // Let's add a separate row for colors below the board in HTML or just append here spanning cols
            board.innerHTML += `<div class="roulette-cell red" style="grid-column: span 1.5;" onclick="placeRouletteBet('color', 'red')" id="roulette-cell-red">ROT</div>`;
            board.innerHTML += `<div class="roulette-cell black" style="grid-column: span 1.5;" onclick="placeRouletteBet('color', 'black')" id="roulette-cell-black">SCHWARZ</div>`;
        }

        function placeRouletteBet(type, value) {
            const chipVal = parseInt(document.getElementById('roulette-chip-val').value);

            // Check balance locally first (visual only, real check on spin)
            // But we accumulate bets.

            rouletteBets.push({ type, value, amount: chipVal });
            updateRouletteTotal();

            // Visual Chip
            const cellId = type === 'number' ? `roulette-cell-${value}` : `roulette-cell-${value}`;
            const cell = document.getElementById(cellId);
            if (cell) {
                const chip = document.createElement('div');
                chip.className = 'roulette-chip';
                chip.innerText = chipVal;
                // Random offset for stacking effect
                const x = Math.floor(Math.random() * 20) - 10;
                const y = Math.floor(Math.random() * 10) - 5;
                chip.style.transform = `translate(${x}px, ${y}px)`;
                cell.appendChild(chip);
            }
        }

        function clearRouletteBets() {
            rouletteBets = [];
            updateRouletteTotal();
            renderRouletteBoard(); // Re-render cleans chips
            document.getElementById('roulette-result-text').innerText = "Platziere deinen Einsatz";
            document.getElementById('roulette-wheel-display').style.color = "white";
        }

        function updateRouletteTotal() {
            const total = rouletteBets.reduce((sum, b) => sum + b.amount, 0);
            document.getElementById('roulette-total-bet').innerText = total;
        }

        function exitRoulette() {
            document.getElementById('roulette-game').classList.add('hidden');
            document.getElementById('casino-main-menu').classList.remove('hidden');
            renderCasinoMainMenu();
        }

        async function spinRoulette() {
            const totalBet = rouletteBets.reduce((sum, b) => sum + b.amount, 0);
            const settings = getCasinoSettings().casino;
            const minBet = settings.rouletteCost || 1;

            if (totalBet === 0) {
                Swal.fire('Info', 'Bitte platziere erst einen Einsatz.', 'info');
                return;
            }
            if (totalBet < minBet) {
                Swal.fire('Info', `Der Mindesteinsatz beträgt ${minBet} Chips.`, 'info');
                return;
            }

            if (!deductChipsFromSource(currentUser, currentBetSource, totalBet)) {
                Swal.fire('Fehler', 'Nicht genügend Chips!', 'error');
                return;
            }
            await save();
            updateGameAccountDisplay('roulette-account-info');

            const resultText = document.getElementById('roulette-result-text');
            resultText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rien ne va plus...';

            // Simulate Spin Time
            await new Promise(r => setTimeout(r, 2000));

            const num = Math.floor(Math.random() * 37); // 0-36
            const reds = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];
            let color = 'green';
            if (num !== 0) color = reds.includes(num) ? 'red' : 'black';

            // Calculate Win
            let totalWin = 0;
            rouletteBets.forEach(bet => {
                if (bet.type === 'number' && bet.value === num) {
                    totalWin += bet.amount * 36; // 35:1 payout + stake = 36x
                }
                if (bet.type === 'color' && bet.value === color) {
                    totalWin += bet.amount * 2; // 1:1 payout + stake = 2x
                }
            });

            // Display Result
            const colorHex = color === 'red' ? '#ff4d6d' : (color === 'black' ? '#aaa' : '#4CAF50');
            resultText.innerHTML = `<span style="color:${colorHex}; font-size:2.5rem;">${num}</span>`;

            if (totalWin > 0) {
                addChips(currentUser, totalWin, currentBetSource);
                Swal.fire({
                    title: `Gewonnen!`,
                    text: `Du erhältst ${totalWin} Chips!`,
                    icon: 'success',
                    background: '#1a1a1a', color: '#fff',
                    timer: 2000, showConfirmButton: false
                });
                fireConfetti(50);
            } else {
                Swal.fire({
                    title: `Verloren`,
                    text: `Die Kugel fiel auf ${num} (${color}).`,
                    icon: 'error',
                    background: '#1a1a1a', color: '#fff',
                    timer: 1500, showConfirmButton: false
                });
            }

            await save();
            updateGameAccountDisplay('roulette-account-info');
            clearRouletteBets();
        }

        // --- SLOTS (5 Reels) ---
        function openSlots() {
            if (!currentBetSource) return;
            document.getElementById('casino-main-menu').classList.add('hidden');
            document.getElementById('slots-game').classList.remove('hidden');
            updateGameAccountDisplay('slots-account-info');
            document.getElementById('slots-result').innerText = "";

            renderSlotsGrid();
            updateSlotsCost();
        }

        function renderSlotsGrid(symbolsMatrix = null) {
            const grid = document.getElementById('slots-grid');
            grid.innerHTML = '';

            const settings = getCasinoSettings();
            const symbols = settings.slots;

            // If no matrix provided, random initial
            if (!symbolsMatrix) {
                for (let i = 0; i < 15; i++) {
                    const sym = symbols[Math.floor(Math.random() * symbols.length)];
                    renderSlotCell(grid, sym);
                }
            } else {
                // Render provided matrix (3 rows x 5 cols)
                // Grid CSS is 5 cols. So we iterate row by row.
                for (let r = 0; r < 3; r++) {
                    for (let c = 0; c < 5; c++) {
                        renderSlotCell(grid, symbolsMatrix[r][c]);
                    }
                }
            }
        }

        function renderSlotCell(container, sym) {
            const div = document.createElement('div');
            div.className = 'slot-cell';
            if (sym.startsWith('http')) {
                div.innerHTML = `<div style="width:100%; height:100%; background-image:url('${sym}'); background-size:contain; background-repeat:no-repeat; background-position:center;"></div>`;
            } else {
                div.innerText = sym;
            }
            container.appendChild(div);
        }

        function updateSlotsCost() {
            const lines = parseInt(document.getElementById('slots-lines').value);
            const betPerLine = parseInt(document.getElementById('slots-bet').value);
            document.getElementById('slots-total-cost').innerText = `${lines * betPerLine} Chip(s)`;
        }

        function exitSlots() {
            document.getElementById('slots-game').classList.add('hidden');
            document.getElementById('casino-main-menu').classList.remove('hidden');
            renderCasinoMainMenu();
        }

        async function spinSlots() {
            if (slotSpinning) return;

            const lines = parseInt(document.getElementById('slots-lines').value);
            const betPerLine = parseInt(document.getElementById('slots-bet').value);
            const totalBet = lines * betPerLine;

            if (!deductChipsFromSource(currentUser, currentBetSource, totalBet)) {
                Swal.fire('Fehler', 'Nicht genügend Chips!', 'error');
                return;
            }
            await save();
            updateGameAccountDisplay('slots-account-info');

            slotSpinning = true;
            document.getElementById('slots-result').innerText = "";

            // Animation: Blur effect
            const cells = document.querySelectorAll('.slot-cell');
            cells.forEach(c => c.classList.add('blur'));

            // Simulate delay
            await new Promise(r => setTimeout(r, 1000));

            // Generate Result Matrix (3 rows, 5 cols)
            const settings = getCasinoSettings();
            const symbols = settings.slots;
            const matrix = [];

            // Win Chance Logic
            const winChance = (settings.casino && settings.casino.slotWinChance) ? settings.casino.slotWinChance : 30;
            const forceWin = Math.random() * 100 < winChance;
            const winSym = symbols[Math.floor(Math.random() * symbols.length)];

            for (let r = 0; r < 3; r++) {
                const row = [];
                for (let c = 0; c < 5; c++) {
                    if (forceWin && r === 1) {
                        // Force win on middle row (Line 1)
                        row.push(winSym);
                    } else {
                        row.push(symbols[Math.floor(Math.random() * symbols.length)]);
                    }
                }
                matrix.push(row);
            }

            renderSlotsGrid(matrix); // Removes blur by re-rendering

            // Calculate Wins
            let totalWin = 0;
            let winDetails = [];

            // Define Lines (coordinates [row, col])
            // Define Lines (coordinates [row, col])
            // Added more lines for better win rate
            const paylines = {
                1: [[1, 0], [1, 1], [1, 2], [1, 3], [1, 4]], // Middle
                2: [[0, 0], [0, 1], [0, 2], [0, 3], [0, 4]], // Top
                3: [[2, 0], [2, 1], [2, 2], [2, 3], [2, 4]], // Bottom
                4: [[0, 0], [1, 1], [2, 2], [1, 3], [0, 4]], // V-Shape (Diagonal down-up)
                5: [[2, 0], [1, 1], [0, 2], [1, 3], [2, 4]], // ^-Shape (Diagonal up-down)
                6: [[0, 0], [1, 1], [0, 2], [1, 3], [0, 4]], // W-Shape
                7: [[2, 0], [1, 1], [2, 2], [1, 3], [2, 4]], // M-Shape
                8: [[0, 0], [1, 0], [2, 0], [1, 1], [0, 2]]  // ZigZag start (just example, keeping it simple to 8 lines)
            };

            // Check active lines
            // Logic: 3+ consecutive symbols from left
            // REBALANCED: Higher Multipliers
            for (let l = 1; l <= 8; l++) { // Check up to 8 lines (or however many defined)
                if (!paylines[l]) continue;
                const coords = paylines[l];
                const lineSymbols = coords.map(c => matrix[c[0]][c[1]]);

                const firstSym = lineSymbols[0];
                let count = 1;
                for (let i = 1; i < 5; i++) {
                    if (lineSymbols[i] === firstSym) count++;
                    else break;
                }

                if (count >= 3) {
                    // Win!
                    let multiplier = 0;
                    if (count === 3) multiplier = 10; // Was 5
                    if (count === 4) multiplier = 50; // Was 20
                    if (count === 5) multiplier = 200; // Was 100

                    const win = betPerLine * multiplier;
                    totalWin += win;
                    winDetails.push(`Linie ${l}: ${count}x ${firstSym.startsWith('http') ? 'Bild' : firstSym} (${win})`);
                }
            }

            if (totalWin > 0) {
                addChips(currentUser, totalWin, currentBetSource);
                document.getElementById('slots-result').innerText = `GEWONNEN! ${totalWin} Chips`;
                document.getElementById('slots-result').style.color = "gold";
                fireConfetti(100);
                if (winDetails.length > 0) {
                    // Optional: Show details
                    console.log(winDetails.join(', '));
                }
            } else {
                document.getElementById('slots-result').innerText = "Leider nichts.";
                document.getElementById('slots-result').style.color = "#ccc";
            }

            await save();
            updateGameAccountDisplay('slots-account-info');
            slotSpinning = false;
        }

        // --- DOUBLE OR NOTHING (COIN FLIP 3D) ---
        function openCoinFlip() {
            if (!currentBetSource) return;
            document.getElementById('casino-main-menu').classList.add('hidden');
            document.getElementById('coin-flip-view').classList.remove('hidden'); // Corrected ID
            updateGameAccountDisplay('cf-account-info');
            resetCoinFlip();
        }

        function exitCoinFlip() {
            if (cfActive && cfStake > 0) {
                addChips(currentUser, cfStake, currentBetSource);
                save();
            }
            document.getElementById('coin-flip-view').classList.add('hidden'); // Corrected ID
            document.getElementById('casino-main-menu').classList.remove('hidden');
            renderCasinoMainMenu();
        }

        function resetCoinFlip() {
            cfStake = 0;
            cfActive = false;
            document.getElementById('cf-setup').classList.remove('hidden');
            document.getElementById('cf-game').classList.add('hidden');
            document.getElementById('cf-result-actions').classList.add('hidden');
            document.getElementById('cf-message').innerText = "Verdopple deinen Einsatz oder verliere alles.";

            // Reset Coin Visual
            const coin = document.getElementById('cf-coin');
            coin.style.transform = "rotateY(0deg)";
        }

        async function startCoinFlip() {
            const input = document.getElementById('cf-bet-input').value;
            const bet = parseInt(input);
            const settings = getCasinoSettings().casino;
            const minBet = settings.coinFlipCost || 1;

            if (isNaN(bet) || bet <= 0) {
                Swal.fire('Fehler', 'Ungültiger Einsatz', 'error');
                return;
            }
            if (bet < minBet) {
                Swal.fire('Fehler', `Mindesteinsatz ist ${minBet} Chips.`, 'error');
                return;
            }
            if (!deductChipsFromSource(currentUser, currentBetSource, bet)) {
                Swal.fire('Fehler', 'Nicht genügend Chips!', 'error');
                return;
            }
            await save();
            updateGameAccountDisplay('cf-account-info');

            cfStake = bet;
            cfActive = true;

            document.getElementById('cf-setup').classList.add('hidden');
            document.getElementById('cf-game').classList.remove('hidden');
            document.getElementById('cf-current-pot').innerText = cfStake;
            document.getElementById('cf-message').innerText = "Kopf oder Zahl?";
            document.getElementById('cf-options').classList.remove('hidden');
        }

        async function flipCoin(choice) {
            if (!cfActive) return;

            // Disable buttons
            document.querySelectorAll('#cf-game button').forEach(b => b.disabled = true);
            document.getElementById('cf-message').innerText = "Die Münze fliegt...";

            const coin = document.getElementById('cf-coin');

            // Determine Result with House Edge
            const settings = getCasinoSettings().casino;
            const edge = (settings.coinFlipHouseEdge || 5) / 100; // e.g. 0.05

            // Win chance = 0.5 - (edge / 2) ? Or just simple: House wins if random < edge
            // Let's say: 50/50 fair, but we skew it.
            // If edge is 5%, then win chance is 47.5%.
            // Let's implement: House wins immediately with probability 'edge'.
            // Otherwise fair flip.

            let isHead;
            if (Math.random() < edge) {
                // House wins (force result opposite to choice)
                isHead = (choice === 'tail'); // If user chose tail, make it head
            } else {
                // Fair flip
                isHead = Math.random() < 0.5;
            }

            const result = isHead ? 'head' : 'tail';

            // Animation
            // We want to end up at 0deg (Head) or 180deg (Tail) + multiple rotations
            const spins = 5;
            const baseRot = spins * 360;
            const targetRot = isHead ? baseRot : (baseRot + 180);

            // Reset transition to allow re-spin if needed (hacky but works for simple CSS)
            coin.style.transition = "none";
            coin.style.transform = "rotateY(0deg)";

            // Force reflow
            void coin.offsetWidth;

            // Start Animation
            coin.style.transition = "transform 3s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
            coin.style.transform = `rotateY(${targetRot}deg)`;

            // Wait for animation
            await new Promise(r => setTimeout(r, 3000));

            if (choice === result) {
                // Win
                cfStake *= 2;
                document.getElementById('cf-current-pot').innerText = cfStake;
                document.getElementById('cf-message').innerText = "GEWONNEN! Verdoppelt!";
                document.getElementById('cf-message').style.color = "gold";
                fireConfetti(30);

                document.getElementById('cf-options').classList.add('hidden');
                document.getElementById('cf-result-actions').classList.remove('hidden');
            } else {
                // Lose
                cfStake = 0;
                cfActive = false;
                document.getElementById('cf-message').innerText = "Verloren! Alles weg.";
                document.getElementById('cf-message').style.color = "var(--danger)";
                document.getElementById('cf-current-pot').innerText = 0;

                setTimeout(() => {
                    resetCoinFlip();
                }, 2000);
            }
            document.querySelectorAll('#cf-game button').forEach(b => b.disabled = false);
        }

        function cfCashOut() {
            if (cfStake > 0) {
                addChips(currentUser, cfStake, currentBetSource);
                save();
                updateGameAccountDisplay('cf-account-info');
                Swal.fire('Ausgezahlt!', `Du hast ${cfStake} Chips gewonnen.`, 'success');
            }
            resetCoinFlip();
        }

        // --- SPORTS BETTING ---
        let sportsMatches = [];
        const API_KEY = '3'; // Free key for TheSportsDB
        let currentLeagueId = '4331'; // Bundesliga

        function changeLeague(id) {
            currentLeagueId = id;
            fetchUpcomingMatches();
        }

        function openSportsBetting() {
            if (!currentBetSource) return;
            document.getElementById('casino-main-menu').classList.add('hidden');
            document.getElementById('sports-betting-view').classList.remove('hidden');
            updateGameAccountDisplay('sports-account-info');

            showSportsTab('upcoming');
        }

        function exitSportsBetting() {
            document.getElementById('sports-betting-view').classList.add('hidden');
            document.getElementById('casino-main-menu').classList.remove('hidden');
            renderCasinoMainMenu();
        }

        function showSportsTab(tab) {
            document.getElementById('btn-sports-upcoming').style.background = tab === 'upcoming' ? 'var(--primary)' : '#444';
            document.getElementById('btn-sports-mybets').style.background = tab === 'mybets' ? 'var(--primary)' : '#444';

            if (tab === 'upcoming') {
                document.getElementById('sports-upcoming-list').classList.remove('hidden');
                document.getElementById('sports-mybets-list').classList.add('hidden');
                fetchUpcomingMatches();
            } else {
                document.getElementById('sports-upcoming-list').classList.add('hidden');
                document.getElementById('sports-mybets-list').classList.remove('hidden');
                renderMyBets();
            }
        }

        async function fetchUpcomingMatches() {
            const container = document.getElementById('sports-upcoming-list');
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;"><i class="fas fa-spinner fa-spin"></i> Lade Spiele...</div>';

            // Use mock data directly (API is unreliable with free key)
            sportsMatches = getMockMatches(currentLeagueId);

            // Small delay for UX (shows loading state)
            await new Promise(r => setTimeout(r, 300));

            renderMatches(sportsMatches);
        }

        function getMockMatches(leagueId) {
            const mockData = {
                '4331': { // Bundesliga
                    league: 'Bundesliga',
                    teams: [
                        { name: 'Bayern München', logo: 'https://crests.football-data.org/5.svg' },
                        { name: 'Borussia Dortmund', logo: 'https://crests.football-data.org/4.svg' },
                        { name: 'RB Leipzig', logo: 'https://crests.football-data.org/721.svg' },
                        { name: 'Bayer Leverkusen', logo: 'https://crests.football-data.org/3.svg' },
                        { name: 'VfB Stuttgart', logo: 'https://crests.football-data.org/10.svg' },
                        { name: 'Eintracht Frankfurt', logo: 'https://crests.football-data.org/19.svg' },
                        { name: 'SC Freiburg', logo: 'https://crests.football-data.org/17.svg' },
                        { name: 'VfL Wolfsburg', logo: 'https://crests.football-data.org/11.svg' },
                        { name: 'Union Berlin', logo: 'https://crests.football-data.org/28.svg' },
                        { name: 'Borussia M\'gladbach', logo: 'https://crests.football-data.org/18.svg' },
                        { name: 'FSV Mainz 05', logo: 'https://crests.football-data.org/15.svg' },
                        { name: 'Werder Bremen', logo: 'https://crests.football-data.org/12.svg' },
                        { name: 'FC Augsburg', logo: 'https://crests.football-data.org/16.svg' },
                        { name: 'TSG Hoffenheim', logo: 'https://crests.football-data.org/2.svg' },
                        { name: 'VfL Bochum', logo: 'https://crests.football-data.org/36.svg' },
                        { name: '1. FC Heidenheim', logo: 'https://crests.football-data.org/44.svg' },
                        { name: 'SV Darmstadt 98', logo: 'https://crests.football-data.org/55.svg' },
                        { name: '1. FC Köln', logo: 'https://crests.football-data.org/1.svg' }
                    ],
                    schedule: [
                        { dayOffset: 0, time: '20:30:00' },
                        { dayOffset: 1, time: '15:30:00' },
                        { dayOffset: 1, time: '15:30:00' },
                        { dayOffset: 1, time: '15:30:00' },
                        { dayOffset: 1, time: '15:30:00' },
                        { dayOffset: 1, time: '15:30:00' },
                        { dayOffset: 1, time: '18:30:00' },
                        { dayOffset: 2, time: '15:30:00' },
                        { dayOffset: 2, time: '17:30:00' }
                    ]
                },
                '4328': { // Premier League
                    league: 'Premier League',
                    teams: [
                        { name: 'Manchester City', logo: 'https://crests.football-data.org/65.svg' },
                        { name: 'Arsenal', logo: 'https://crests.football-data.org/57.svg' },
                        { name: 'Liverpool', logo: 'https://crests.football-data.org/64.svg' },
                        { name: 'Chelsea', logo: 'https://crests.football-data.org/61.svg' },
                        { name: 'Manchester United', logo: 'https://crests.football-data.org/66.svg' },
                        { name: 'Tottenham', logo: 'https://crests.football-data.org/73.svg' },
                        { name: 'Newcastle United', logo: 'https://crests.football-data.org/67.svg' },
                        { name: 'Aston Villa', logo: 'https://crests.football-data.org/58.svg' },
                        { name: 'Brighton', logo: 'https://crests.football-data.org/397.svg' },
                        { name: 'West Ham', logo: 'https://crests.football-data.org/563.svg' },
                        { name: 'Crystal Palace', logo: 'https://crests.football-data.org/354.svg' },
                        { name: 'Fulham', logo: 'https://crests.football-data.org/63.svg' },
                        { name: 'Brentford', logo: 'https://crests.football-data.org/402.svg' },
                        { name: 'Nottingham Forest', logo: 'https://crests.football-data.org/351.svg' },
                        { name: 'Everton', logo: 'https://crests.football-data.org/62.svg' },
                        { name: 'Wolves', logo: 'https://crests.football-data.org/76.svg' },
                        { name: 'Bournemouth', logo: 'https://crests.football-data.org/1044.svg' },
                        { name: 'Burnley', logo: 'https://crests.football-data.org/328.svg' },
                        { name: 'Sheffield United', logo: 'https://crests.football-data.org/356.svg' },
                        { name: 'Luton Town', logo: 'https://crests.football-data.org/389.svg' }
                    ],
                    schedule: [
                        { dayOffset: 1, time: '13:30:00' },
                        { dayOffset: 1, time: '16:00:00' },
                        { dayOffset: 1, time: '16:00:00' },
                        { dayOffset: 1, time: '16:00:00' },
                        { dayOffset: 1, time: '16:00:00' },
                        { dayOffset: 1, time: '18:30:00' },
                        { dayOffset: 2, time: '15:00:00' },
                        { dayOffset: 2, time: '15:00:00' },
                        { dayOffset: 2, time: '17:30:00' },
                        { dayOffset: 3, time: '21:00:00' }
                    ]
                },
                '4335': { // La Liga
                    league: 'La Liga',
                    teams: [
                        { name: 'Real Madrid', logo: 'https://crests.football-data.org/86.svg' },
                        { name: 'Barcelona', logo: 'https://crests.football-data.org/81.svg' },
                        { name: 'Atlético Madrid', logo: 'https://crests.football-data.org/78.svg' },
                        { name: 'Sevilla', logo: 'https://crests.football-data.org/559.svg' },
                        { name: 'Real Sociedad', logo: 'https://crests.football-data.org/92.svg' },
                        { name: 'Villarreal', logo: 'https://crests.football-data.org/94.svg' },
                        { name: 'Real Betis', logo: 'https://crests.football-data.org/90.svg' },
                        { name: 'Athletic Bilbao', logo: 'https://crests.football-data.org/77.svg' },
                        { name: 'Valencia', logo: 'https://crests.football-data.org/95.svg' },
                        { name: 'Celta Vigo', logo: 'https://crests.football-data.org/558.svg' },
                        { name: 'Osasuna', logo: 'https://crests.football-data.org/79.svg' },
                        { name: 'Girona', logo: 'https://crests.football-data.org/298.svg' },
                        { name: 'Rayo Vallecano', logo: 'https://crests.football-data.org/87.svg' },
                        { name: 'Getafe', logo: 'https://crests.football-data.org/82.svg' },
                        { name: 'Mallorca', logo: 'https://crests.football-data.org/89.svg' },
                        { name: 'Las Palmas', logo: 'https://crests.football-data.org/275.svg' },
                        { name: 'Alavés', logo: 'https://crests.football-data.org/263.svg' },
                        { name: 'Granada', logo: 'https://crests.football-data.org/925.svg' },
                        { name: 'Cádiz', logo: 'https://crests.football-data.org/264.svg' },
                        { name: 'Almería', logo: 'https://crests.football-data.org/267.svg' }
                    ],
                    schedule: [
                        { dayOffset: 0, time: '21:00:00' },
                        { dayOffset: 1, time: '14:00:00' },
                        { dayOffset: 1, time: '16:15:00' },
                        { dayOffset: 1, time: '18:30:00' },
                        { dayOffset: 1, time: '21:00:00' },
                        { dayOffset: 2, time: '14:00:00' },
                        { dayOffset: 2, time: '16:15:00' },
                        { dayOffset: 2, time: '18:30:00' },
                        { dayOffset: 2, time: '21:00:00' },
                        { dayOffset: 3, time: '21:00:00' }
                    ]
                },
                '4346': { // 2. Bundesliga
                    league: '2. Bundesliga',
                    teams: [
                        { name: 'Hamburger SV', logo: 'https://crests.football-data.org/57.svg' },
                        { name: 'FC Schalke 04', logo: 'https://crests.football-data.org/6.svg' },
                        { name: 'Hertha BSC', logo: 'https://crests.football-data.org/9.svg' },
                        { name: 'Fortuna Düsseldorf', logo: 'https://crests.football-data.org/24.svg' },
                        { name: 'FC St. Pauli', logo: 'https://crests.football-data.org/20.svg' },
                        { name: 'Hannover 96', logo: 'https://crests.football-data.org/8.svg' },
                        { name: '1. FC Nürnberg', logo: 'https://crests.football-data.org/14.svg' },
                        { name: '1. FC Kaiserslautern', logo: 'https://crests.football-data.org/21.svg' },
                        { name: 'Karlsruher SC', logo: 'https://crests.football-data.org/23.svg' },
                        { name: 'SV Darmstadt 98', logo: 'https://crests.football-data.org/55.svg' },
                        { name: 'FC Hansa Rostock', logo: 'https://crests.football-data.org/26.svg' },
                        { name: 'Holstein Kiel', logo: 'https://crests.football-data.org/29.svg' },
                        { name: 'SpVgg Greuther Fürth', logo: 'https://crests.football-data.org/25.svg' },
                        { name: 'SV Sandhausen', logo: 'https://crests.football-data.org/254.svg' }, // Guess/Fallback
                        { name: 'SC Paderborn', logo: 'https://crests.football-data.org/31.svg' },
                        { name: 'Eintracht Braunschweig', logo: 'https://crests.football-data.org/45.svg' },
                        { name: 'Dynamo Dresden', logo: 'https://crests.football-data.org/27.svg' },
                        { name: '1. FC Magdeburg', logo: 'https://crests.football-data.org/42.svg' }
                    ],
                    schedule: [
                        { dayOffset: 0, time: '18:30:00' },
                        { dayOffset: 0, time: '18:30:00' },
                        { dayOffset: 1, time: '13:00:00' },
                        { dayOffset: 1, time: '13:00:00' },
                        { dayOffset: 1, time: '13:00:00' },
                        { dayOffset: 1, time: '20:30:00' },
                        { dayOffset: 2, time: '13:30:00' },
                        { dayOffset: 2, time: '13:30:00' },
                        { dayOffset: 2, time: '13:30:00' }
                    ]
                },
                '4429': { // WM Quali (Example)
                    league: 'WM Qualifikation',
                    teams: [
                        { name: 'Deutschland', logo: 'https://crests.football-data.org/759.svg' },
                        { name: 'Frankreich', logo: 'https://crests.football-data.org/773.svg' },
                        { name: 'Brasilien', logo: 'https://crests.football-data.org/764.svg' },
                        { name: 'Argentinien', logo: 'https://crests.football-data.org/762.svg' },
                        { name: 'Spanien', logo: 'https://crests.football-data.org/760.svg' },
                        { name: 'Italien', logo: 'https://crests.football-data.org/784.svg' },
                        { name: 'England', logo: 'https://crests.football-data.org/770.svg' },
                        { name: 'Niederlande', logo: 'https://crests.football-data.org/8601.svg' },
                        { name: 'Portugal', logo: 'https://crests.football-data.org/765.svg' },
                        { name: 'Belgien', logo: 'https://crests.football-data.org/805.svg' },
                        { name: 'Kroatien', logo: 'https://crests.football-data.org/799.svg' },
                        { name: 'Dänemark', logo: 'https://crests.football-data.org/782.svg' },
                        { name: 'Uruguay', logo: 'https://crests.football-data.org/758.svg' },
                        { name: 'Schweiz', logo: 'https://crests.football-data.org/788.svg' },
                        { name: 'Polen', logo: 'https://crests.football-data.org/794.svg' },
                        { name: 'Österreich', logo: 'https://crests.football-data.org/816.svg' }
                    ],
                    schedule: [
                        { dayOffset: 0, time: '20:45:00' },
                        { dayOffset: 0, time: '20:45:00' },
                        { dayOffset: 1, time: '18:00:00' },
                        { dayOffset: 1, time: '20:45:00' },
                        { dayOffset: 1, time: '20:45:00' },
                        { dayOffset: 2, time: '15:00:00' },
                        { dayOffset: 2, time: '18:00:00' },
                        { dayOffset: 2, time: '20:45:00' }
                    ]
                }
            };

            const leagueData = mockData[leagueId] || mockData['4331'];
            const matches = [];
            const teams = [...leagueData.teams];
            const schedule = leagueData.schedule || [];

            // --- DETERMINISTIC GENERATION ---
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0=Sun, 1=Mon, ..., 5=Fri, 6=Sat

            // FIX: Always start schedule from TODAY so we have upcoming matches
            const anchorDate = new Date(today);
            anchorDate.setHours(0, 0, 0, 0);

            const seedString = anchorDate.toISOString().split('T')[0] + '_' + leagueId;
            let seed = 0;
            for (let i = 0; i < seedString.length; i++) {
                seed = ((seed << 5) - seed) + seedString.charCodeAt(i);
                seed |= 0;
            }

            const seededRandom = () => {
                seed = (seed * 9301 + 49297) % 233280;
                return seed / 233280;
            };

            const shuffle = (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(seededRandom() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            };

            const shuffledTeams = shuffle([...teams]);
            const numMatches = Math.floor(shuffledTeams.length / 2);

            for (let i = 0; i < numMatches; i++) {
                const homeTeam = shuffledTeams[i * 2];
                const awayTeam = shuffledTeams[i * 2 + 1];
                const slot = schedule[i % schedule.length];

                const matchDate = new Date(anchorDate);
                matchDate.setDate(anchorDate.getDate() + slot.dayOffset);

                matches.push({
                    idEvent: 'mock_' + leagueId + '_' + matchDate.toISOString().split('T')[0] + '_' + i,
                    strLeague: leagueData.league,
                    dateEvent: matchDate.toISOString().split('T')[0],
                    strTime: slot.time,
                    strHomeTeam: homeTeam.name,
                    strHomeTeamLogo: homeTeam.logo,
                    strAwayTeam: awayTeam.name,
                    strAwayTeamLogo: awayTeam.logo
                });
            }

            matches.sort((a, b) => {
                const dateA = new Date(a.dateEvent + 'T' + a.strTime);
                const dateB = new Date(b.dateEvent + 'T' + b.strTime);
                return dateA - dateB;
            });

            return matches;
        }

        function renderMatches(matches) {
            const container = document.getElementById('sports-upcoming-list');
            container.innerHTML = '';

            matches.forEach(match => {
                // Check if match has already started
                const matchDateTime = new Date(match.dateEvent + 'T' + match.strTime);
                const now = new Date();
                const hasStarted = matchDateTime < now;
                const matchStatus = hasStarted ? 'disabled' : '';

                // Timezone adjustment
                const localTime = matchDateTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const localDate = matchDateTime.toLocaleDateString();

                // Generate Fake Odds based on match ID
                let seed = 0;
                if (match.idEvent && match.idEvent.toString().startsWith('mock_')) {
                    for (let i = 0; i < match.idEvent.length; i++) {
                        seed += match.idEvent.charCodeAt(i);
                    }
                } else {
                    seed = parseInt(match.idEvent) || Date.now();
                }
                const rand = (seed % 100) / 100; // 0.00 - 0.99

                let odd1 = (1.5 + (rand * 2)).toFixed(2); // 1.5 - 3.5
                let oddX = (2.5 + (rand)).toFixed(2); // 2.5 - 3.5
                let odd2 = (1.5 + ((1 - rand) * 2)).toFixed(2); // 1.5 - 3.5

                // Status badge and styling for started matches
                const statusBadge = hasStarted ? '<div style="background:#ff4444; color:white; padding:2px 8px; border-radius:4px; font-size:0.7rem; margin-left:10px;">ANGEPFIFFEN</div>' : '';
                const disabledStyle = hasStarted ? 'opacity:0.5; pointer-events:none;' : '';
                const disabledCursor = hasStarted ? 'cursor:not-allowed;' : 'cursor:pointer;';

                // Team Logos (Prioritize explicit logo, fallback to ui-avatars)
                const getLogo = (name, logoUrl) => {
                    if (logoUrl) return logoUrl;
                    return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&color=fff&size=40&rounded=true`;
                };

                // Simulation Button for TestUser
                const simBtn = currentUser === 'TestUser' ? `
                    <button onclick="event.stopPropagation(); simulateMatchResult('${match.idEvent}', '${match.strHomeTeam}', '${match.strAwayTeam}')" 
                    style="margin-left:10px; padding:2px 5px; font-size:0.7rem; background:var(--accent); border:none; border-radius:4px; color:white; cursor:pointer;">
                    Simulieren
                    </button>
                ` : '';

                container.innerHTML += `
                    <div class="match-card" style="${hasStarted ? 'background:#1a1a1a; border-color:#333;' : ''}">
                        <div class="match-header">
                            <span>${match.strLeague}</span>
                            <div style="display:flex; align-items:center;">
                                <span>${localDate} ${localTime}</span>
                                ${statusBadge}
                                ${simBtn}
                            </div>
                        </div>
                        <div class="match-teams">
                            <div class="team-info">
                                <img src="${getLogo(match.strHomeTeam, match.strHomeTeamLogo)}" style="width:30px; height:30px; margin-right:10px; object-fit:contain;">
                                <span>${match.strHomeTeam}</span>
                            </div>
                            <div style="font-size:0.9rem; color:#888;">vs</div>
                            <div class="team-info away">
                                <span>${match.strAwayTeam}</span>
                                <img src="${getLogo(match.strAwayTeam, match.strAwayTeamLogo)}" style="width:30px; height:30px; margin-left:10px; object-fit:contain;">
                            </div>
                        </div>
                        <div class="match-odds" style="${disabledStyle}">
                            <div class="odd-btn" onclick="${hasStarted ? 'event.stopPropagation(); Swal.fire(\"Spiel läuft\", \"Wetten sind nach Anpfiff nicht mehr möglich.\", \"warning\");' : `placeSportsBet('${match.idEvent}', '1', ${odd1}, '${match.strHomeTeam} vs ${match.strAwayTeam}')`}" style="${disabledCursor}">
                                <span class="odd-val">${odd1}</span>
                                <span class="odd-label">1 (Heim)</span>
                            </div>
                            <div class="odd-btn" onclick="${hasStarted ? 'event.stopPropagation(); Swal.fire(\"Spiel läuft\", \"Wetten sind nach Anpfiff nicht mehr möglich.\", \"warning\");' : `placeSportsBet('${match.idEvent}', 'X', ${oddX}, '${match.strHomeTeam} vs ${match.strAwayTeam}')`}" style="${disabledCursor}">
                                <span class="odd-val">${oddX}</span>
                                <span class="odd-label">X (Remis)</span>
                            </div>
                            <div class="odd-btn" onclick="${hasStarted ? 'event.stopPropagation(); Swal.fire(\"Spiel läuft\", \"Wetten sind nach Anpfiff nicht mehr möglich.\", \"warning\");' : `placeSportsBet('${match.idEvent}', '2', ${odd2}, '${match.strHomeTeam} vs ${match.strAwayTeam}')`}" style="${disabledCursor}">
                                <span class="odd-val">${odd2}</span>
                                <span class="odd-label">2 (Gast)</span>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        async function placeSportsBet(eventId, selection, odds, matchTitle) {
            const { value: betAmount } = await Swal.fire({
                title: 'Wette platzieren',
                text: `${matchTitle} - Tipp: ${selection} (Quote: ${odds})`,
                input: 'number',
                inputLabel: 'Einsatz (Chips)',
                inputPlaceholder: '10',
                showCancelButton: true,
                background: '#1a1a1a', color: '#fff'
            });

            if (betAmount) {
                const amount = parseInt(betAmount);
                if (amount <= 0) return;

                if (!deductChipsFromSource(currentUser, currentBetSource, amount)) {
                    Swal.fire('Fehler', 'Nicht genügend Chips!', 'error');
                    return;
                }

                if (!db.users[currentUser].sportsBets) db.users[currentUser].sportsBets = [];

                db.users[currentUser].sportsBets.push({
                    id: Date.now(),
                    eventId,
                    matchTitle,
                    selection,
                    odds,
                    amount,
                    status: 'open', // open, won, lost
                    source: currentBetSource,
                    timestamp: Date.now()
                });

                await save();
                updateGameAccountDisplay('sports-account-info');
                Swal.fire('Wette platziert!', 'Viel Glück!', 'success');
            }
        }

        function renderMyBets() {
            const container = document.getElementById('sports-mybets-list');
            container.innerHTML = '';

            const bets = db.users[currentUser].sportsBets || [];
            if (bets.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">Keine Wetten.</div>';
                return;
            }

            // Sort by newest
            bets.sort((a, b) => b.timestamp - a.timestamp).forEach(bet => {
                let statusColor = '#ccc';
                let statusText = 'Offen';
                let scoreText = '';

                // Check for result in mockResults
                if (db.appSettings && db.appSettings.mockResults && db.appSettings.mockResults[bet.eventId]) {
                    const res = db.appSettings.mockResults[bet.eventId];
                    scoreText = ` (${res.home}:${res.away})`;
                }

                if (bet.status === 'won') { statusColor = '#4CAF50'; statusText = 'GEWONNEN'; }
                if (bet.status === 'lost') { statusColor = 'var(--danger)'; statusText = 'VERLOREN'; }

                container.innerHTML += `
                    <div class="match-card" style="border-left: 5px solid ${statusColor};">
                        <div class="match-header">
                            <span>${bet.matchTitle}</span>
                            <span>${new Date(bet.timestamp).toLocaleDateString()}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                            <div>
                                <div style="font-weight:bold;">Tipp: ${bet.selection} @ ${bet.odds}</div>
                                <div style="font-size:0.9rem; color:#aaa;">Einsatz: ${bet.amount} Chips</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:bold; color:${statusColor};">${statusText}${scoreText}</div>
                                ${bet.status === 'open' ? `<button class="btn-main" style="padding:5px 10px; font-size:0.7rem; margin-top:5px;" onclick="checkBetResult(${bet.id})">Prüfen</button>` : ''}
                            </div>
                        </div>
                        ${bet.status === 'open' ? `<div style="margin-top:5px; font-size:0.7rem; color:#666;">(Simulieren für Demo: <a href="#" onclick="simulateBetResult(${bet.id}); return false;">Win</a> / <a href="#" onclick="simulateBetResult(${bet.id}, false); return false;">Lose</a>)</div>` : ''}
                    </div>
                `;
            });
        }

        async function checkBetResult(betId) {
            // In a real app, fetch result from API
            // For now, we simulate or check if event is past
            Swal.fire({
                title: 'Ergebnis prüfen',
                text: 'Verbinde mit Live-Daten...',
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Fetch Event Status
            const bets = db.users[currentUser].sportsBets;
            const bet = bets.find(b => b.id === betId);

            // CHECK FOR SIMULATED RESULT FIRST
            if (db.appSettings && db.appSettings.mockResults && db.appSettings.mockResults[bet.eventId]) {
                const simResult = db.appSettings.mockResults[bet.eventId];
                const home = simResult.home;
                const away = simResult.away;

                let result = 'X';
                if (home > away) result = '1';
                if (away > home) result = '2';

                if (bet.selection === result) {
                    bet.status = 'won';
                    const winAmount = Math.floor(bet.amount * bet.odds);
                    addChips(currentUser, winAmount, bet.source);
                    Swal.fire('Gewonnen!', `Das Spiel endete ${home}:${away}. Du gewinnst ${winAmount} Chips!`, 'success');
                } else {
                    bet.status = 'lost';
                    Swal.fire('Verloren', `Das Spiel endete ${home}:${away}.`, 'error');
                }
                await save();
                renderMyBets();
                updateGameAccountDisplay('sports-account-info');
                return;
            }

            try {
                const response = await fetch(`https://www.thesportsdb.com/api/v1/json/${API_KEY}/lookupevent.php?id=${bet.eventId}`);
                const data = await response.json();

                if (data.events && data.events[0]) {
                    const event = data.events[0];
                    // Check if finished
                    // intHomeScore, intAwayScore
                    if (event.intHomeScore !== null && event.intAwayScore !== null && event.intHomeScore !== "" && event.intAwayScore !== "") {
                        const home = parseInt(event.intHomeScore);
                        const away = parseInt(event.intAwayScore);

                        let result = 'X';
                        if (home > away) result = '1';
                        if (away > home) result = '2';

                        if (bet.selection === result) {
                            bet.status = 'won';
                            const winAmount = Math.floor(bet.amount * bet.odds);
                            addChips(currentUser, winAmount, bet.source);
                            Swal.fire('Gewonnen!', `Das Spiel endete ${home}:${away}. Du gewinnst ${winAmount} Chips!`, 'success');
                        } else {
                            bet.status = 'lost';
                            Swal.fire('Verloren', `Das Spiel endete ${home}:${away}.`, 'error');
                        }
                        await save();
                        renderMyBets();
                        updateGameAccountDisplay('sports-account-info');
                    } else {
                        Swal.fire('Noch offen', 'Das Spiel hat noch nicht stattgefunden oder Ergebnisse sind noch nicht verfügbar.', 'info');
                    }
                } else {
                    // Fallback for mock events that are not in API and not simulated
                    if (bet.eventId.startsWith('mock_')) {
                        Swal.fire('Simulation nötig', 'Dies ist ein Test-Spiel. Bitte nutze den "Simulieren"-Button (als TestUser) um ein Ergebnis festzulegen.', 'info');
                    } else {
                        Swal.fire('Fehler', 'Event Daten nicht gefunden.', 'error');
                    }
                }
            } catch (e) {
                console.error(e);
                Swal.fire('Fehler', 'Verbindung fehlgeschlagen.', 'error');
            }
        }

        async function simulateMatchResult(eventId, homeTeam, awayTeam) {
            const { value: formValues } = await Swal.fire({
                title: 'Ergebnis simulieren',
                html: `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label>${homeTeam}</label>
                        <input id="sim-home" type="number" class="swal2-input" style="width:60px;" value="0">
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                        <label>${awayTeam}</label>
                        <input id="sim-away" type="number" class="swal2-input" style="width:60px;" value="0">
                    </div>
                `,
                focusConfirm: false,
                background: '#1a1a1a', color: '#fff',
                preConfirm: () => {
                    return [
                        document.getElementById('sim-home').value,
                        document.getElementById('sim-away').value
                    ]
                }
            });

            if (formValues) {
                if (!db.appSettings) db.appSettings = {};
                if (!db.appSettings.mockResults) db.appSettings.mockResults = {};

                db.appSettings.mockResults[eventId] = {
                    home: parseInt(formValues[0]),
                    away: parseInt(formValues[1])
                };
                await save();
                Swal.fire('Simuliert', 'Ergebnis gespeichert. Wetten können nun geprüft werden.', 'success');
            }
        }

        async function simulateBetResult(betId, win = true) {
            const bets = db.users[currentUser].sportsBets;
            const bet = bets.find(b => b.id === betId);
            if (!bet) return;

            if (win) {
                bet.status = 'won';
                const winAmount = Math.floor(bet.amount * bet.odds);
                addChips(currentUser, winAmount, bet.source);
                Swal.fire('Gewonnen! (Simuliert)', `Du gewinnst ${winAmount} Chips!`, 'success');
            } else {
                bet.status = 'lost';
                Swal.fire('Verloren (Simuliert)', `Leider verloren.`, 'error');
            }
            await save();
            renderMyBets();
            updateGameAccountDisplay('sports-account-info');
        }


        function cfContinue() {
            document.getElementById('cf-result-actions').classList.add('hidden');
            document.getElementById('cf-options').classList.remove('hidden');
            document.getElementById('cf-message').innerText = "Nächster Wurf: Kopf oder Zahl?";
            document.getElementById('cf-message').style.color = "white";

            // Reset coin visually without animation
            const coin = document.getElementById('cf-coin');
            coin.style.transition = "none";
            coin.style.transform = "rotateY(0deg)";
        }


        function deductChipsFromSource(user, source, amount) {
            if (!db.users[user].chips) db.users[user].chips = {};
            const chips = db.users[user].chips[source] || 0;

            if (chips >= amount) {
                db.users[user].chips[source] -= amount;
                return true;
            }
            return false;
        }

        function addChips(user, amount, source) {
            if (!db.users[user].chips) db.users[user].chips = {};
            if (!db.users[user].chips[source]) db.users[user].chips[source] = 0;
            db.users[user].chips[source] += amount;
        }

        // Helper for Lobs (kept for compatibility if needed elsewhere)
        function deductLobFromSource(user, source, amount) {
            const received = db.users[user].received;
            if (received[source] && received[source] >= amount) {
                received[source] -= amount;
                if (received[source] === 0) delete received[source];
                return true;
            }
            return false;
        }

        function addLob(user, amount, source) {
            const target = source || 'Casino';
            if (!db.users[user].received[target]) {
                db.users[user].received[target] = 0;
            }
            db.users[user].received[target] += amount;
        }

        // --- RANGLISTE ---
        function renderLeaderboard() {
            const leaderboardDiv = document.getElementById('leaderboard-list');
            leaderboardDiv.innerHTML = '';

            // Filtere Admin und TestUser aus der Rangliste
            const rankedUsers = Object.keys(db.users)
                .filter(user => user !== 'Admin' && user !== 'TestUser') // Admin und TestUser ausschließen
                .map(user => {
                    return {
                        name: user,
                        score: calculateTotalScore(user),
                        image: db.users[user].image
                    };
                }).sort((a, b) => b.score - a.score);

            rankedUsers.forEach((u, index) => {
                const rank = index + 1;
                let rankClass = '';
                let rankIcon = rank;

                if (rank === 1) { rankClass = 'rank-1'; rankIcon = '<i class="fas fa-trophy"></i>'; }
                else if (rank === 2) { rankClass = 'rank-2'; rankIcon = '<i class="fas fa-medal"></i>'; }
                else if (rank === 3) { rankClass = 'rank-3'; rankIcon = '<i class="fas fa-medal"></i>'; }

                leaderboardDiv.innerHTML += `
                <div class="leaderboard-item fade-in ${rankClass}" style="animation-delay: ${index * 0.1}s;">
                    <div class="rank-badge">${rankIcon}</div>
                    <div class="avatar" style="background-image:url('${u.image}'); width: 50px; height: 50px; margin-right: 15px; border: 2px solid rgba(255,255,255,0.1);"></div>
                    <div style="flex-grow: 1;">
                        <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 2px;">${u.name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${u.name === currentUser ? '(Das bist du)' : ''}</div>
                    </div>
                    <div class="leaderboard-score">
                        ${u.score} <span style="font-size:0.8rem; opacity:0.8;">Lobs</span>
                    </div>
                </div>
            `;
            });

            if (rankedUsers.length === 0) {
                leaderboardDiv.innerHTML = '<div style="text-align:center; padding: 40px; color: var(--text-muted);">Noch keine Daten vorhanden.</div>';
            }
        }

        // --- PROFILE ---
        function renderProfile() {
            if (currentUser === 'Admin') return;
            const user = db.users[currentUser];
            const container = document.getElementById('profile-content');

            // Ensure settings object exists
            if (!user.settings) user.settings = { mobileNotifications: false };

            container.innerHTML = `
                <div class="profile-header">
                    <img src="${user.image}" class="profile-avatar">
                    <h2 class="profile-name">${currentUser}</h2>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value">${calculateLobs(currentUser)}</div>
                            <div class="stat-label">Lobs</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${calculateBalance(currentUser)}</div>
                            <div class="stat-label">Chips</div>
                        </div>
                    </div>
                </div>

                <div class="profile-section">
                    <h3>Einstellungen</h3>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <span>Auto-Login</span>
                        <label class="switch">
                            <input type="checkbox" ${user.autoLogin ? 'checked' : ''} onchange="toggleAutoLogin(this.checked)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <span>Mobile Benachrichtigungen</span>
                        <label class="switch">
                            <input type="checkbox" ${user.settings.mobileNotifications ? 'checked' : ''} onchange="toggleMobileNotifications(this.checked)">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <button class="btn-secondary" onclick="logout()" style="width:100%; margin-top:10px;">Abmelden</button>
                </div>
                
                <div class="settings-card" style="text-align: center;">
                    <div id="profile-avatar-preview" class="avatar" style="background-image:url('${db.users[currentUser].image}');"></div>

                    <input type="file" id="inp-avatar-file" accept="image/*" style="display:none;"
                        onchange="handleFileUpload(this)">
                    <button class="btn-main" onclick="document.getElementById('inp-avatar-file').click()"
                        style="background: #444; margin-bottom: 10px;"><i class="fas fa-upload"></i> Bild aus
                        Galerie
                        wählen</button>
                    <hr style="border: 1px solid #333; margin: 20px 0;">
                    <input type="text" id="inp-avatar-url" placeholder="Oder Bild-URL einfügen">
                    <button class="btn-main" onclick="saveAvatarFromURL()">URL speichern</button>

                    <div id="profile-badge-display" style="margin-top:20px; font-size:2rem; color:white;"></div>
                </div>

                <div class="settings-card">
                    <h4 style="margin-top:0;">Sicherheit</h4>
                    <input type="password" id="inp-pass" placeholder="Neues Passwort">
                    <button class="btn-main" style="background: #444;" onclick="savePass()">Passwort
                        speichern</button>
                </div>
            `;

            renderBadges(currentUser);
        }

        async function toggleAutoLogin(enabled) {
            db.users[currentUser].autoLogin = enabled;
            await save();
            if (enabled) {
                localStorage.setItem('lobAutoUser', currentUser);
            } else {
                localStorage.removeItem('lobAutoUser');
            }
            showToast('Auto-Login', enabled ? 'Auto-Login aktiviert.' : 'Auto-Login deaktiviert.', 'info');
        }

        async function toggleMobileNotifications(enabled) {
            db.users[currentUser].settings.mobileNotifications = enabled;
            await save();

            if (enabled) {
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    icon: 'success',
                    title: 'Benachrichtigungen aktiviert',
                    showConfirmButton: false,
                    timer: 1500
                });
            } else {
                showToast('Benachrichtigungen', 'Mobile Benachrichtigungen deaktiviert.', 'info');
            }
        }

        async function handleFileUpload(input) {
            if (currentUser === 'Admin') return;
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    db.users[currentUser].image = e.target.result;
                    document.getElementById('profile-avatar-preview').style.backgroundImage = `url('${e.target.result}')`;
                    await save();
                    Swal.fire('Bild gespeichert!', 'Dein Profilbild wurde aktualisiert.', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveAvatarFromURL() {
            if (currentUser === 'Admin') return;
            const url = document.getElementById('inp-avatar-url').value;
            if (url.startsWith('http')) {
                db.users[currentUser].image = url;
                document.getElementById('profile-avatar-preview').style.backgroundImage = `url('${url}')`;
                await save();
                Swal.fire('Bild gespeichert!', 'Dein Profilbild wurde aktualisiert.', 'success');
            } else {
                Swal.fire('Fehler', 'Bitte gib eine gültige URL ein (muss mit http beginnen).', 'error');
            }
        }

        async function savePass() {
            if (currentUser === 'Admin') return;
            const newPass = document.getElementById('inp-pass').value;
            if (newPass.length >= 4) {
                db.users[currentUser].password = newPass;
                document.getElementById('inp-pass').value = '';
                await save();
                Swal.fire('Erfolg', 'Passwort wurde aktualisiert.', 'success');
            } else {
                Swal.fire('Fehler', 'Passwort muss mindestens 4 Zeichen lang sein.', 'error');
            }
        }


        // Favicon Funktionen
        function updateFavicon(url) {
            let link = document.querySelector("link[rel~='icon']");
            if (!link) {
                link = document.createElement('link');
                link.rel = 'icon';
                document.getElementsByTagName('head')[0].appendChild(link);
            }
            link.href = url;
        }

        async function changeFavicon(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = async function (e) {
                    const base64 = e.target.result;

                    // Initialisiere appSettings falls nicht vorhanden
                    if (!db.appSettings) db.appSettings = {};

                    db.appSettings.favicon = base64;
                    await save();
                    updateFavicon(base64);
                    Swal.fire('Erfolg', 'App Icon wurde aktualisiert.', 'success');
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function resetFavicon() {
            if (db.appSettings) {
                db.appSettings.favicon = '';
                await save();
                // Standard Favicon oder leer
                updateFavicon('');
                Swal.fire('Zurückgesetzt', 'App Icon wurde zurückgesetzt.', 'success');
            }
        }

        // --- ADMIN FUNKTIONEN ---
        function renderAdmin() {
            const adminTab = document.getElementById('tab-admin');
            if (!adminTab) return;

            adminTab.innerHTML = '';

            adminTab.innerHTML = `
                <div class="section-header">Admin Einstellungen</div>

                <!-- Test-Umgebung -->
                <div class="settings-card admin-super-user" style="border-color: #00bcd4;">
                    <p style="font-size:0.9rem; color: #00bcd4; font-weight: bold;"><i class="fas fa-vial"></i>
                        Test-Modus</p>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;">
                        Startet die App als "TestUser" mit unendlich vielen Lobs und Chips.
                    </p>
                    <button class="btn-main" onclick="startTestMode()" style="background: #00bcd4;">
                        <i class="fas fa-play"></i> Test-Modus starten
                    </button>
                </div>

                <div class="settings-card">
                    <h4 style="margin-top:0;"><i class="fas fa-dice"></i> Casino Verwaltung</h4>
                    <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:10px;">Einstellungen für
                        Wechselkurse und Spieleinsätze.</p>
                    <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:10px;">Einstellungen für
                        Wechselkurse und Spieleinsätze.</p>
                    <button class="btn-main" style="background: var(--accent);" onclick="openCasinoSettingsPage()">
                        <i class="fas fa-cogs"></i> Casino bearbeiten
                    </button>
                </div>

                <div class="settings-card">
                    <h4 style="margin-top:0;"><i class="fas fa-key"></i> Passwort ändern</h4>
                    <input type="password" id="admin-pass" placeholder="Neues Admin-Passwort" style="margin-bottom: 10px;">
                    <input type="password" id="admin-pass-confirm" placeholder="Passwort bestätigen" style="margin-bottom: 10px;">
                    <button class="btn-main" style="background: #444;" onclick="saveAdminPass()">Passwort
                        speichern</button>
                </div>

                <div class="settings-card">
                    <h4 style="margin-top:0;"><i class="fas fa-image"></i> App Icon (Favicon)</h4>
                    <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:10px;">Bild aus Galerie
                        wählen
                        (wird oben im Browser-Tab angezeigt)</p>
                    <input type="file" id="favicon-upload" accept="image/*" style="display:none;"
                        onchange="changeFavicon(this)">
                    <button class="btn-main" style="background: #444;"
                        onclick="document.getElementById('favicon-upload').click()">Bild auswählen</button>
                    <button class="btn-main" style="background: var(--danger); margin-top:5px;"
                        onclick="resetFavicon()">Zurücksetzen</button>
                </div>

                <!-- Lob-Simulation removed from here -->
            `;
        }

        // Prämien-Verwaltung mit Icon-Unterstützung
        function renderAdminRewardList() {
            const container = document.getElementById('admin-reward-list');
            container.innerHTML = '';

            db.rewards.forEach(reward => {
                const icon = reward.icon || REWARD_ICONS[reward.name] || REWARD_ICONS['default'];
                container.innerHTML += `
                    <div class="settings-card" style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <div style="font-size: 2rem;">${icon}</div>
                            <div style="flex-grow:1;">
                                <h4 style="margin:0;">${reward.name}</h4>
                                <div style="color: gold; font-weight: 600;">${reward.cost} Lobs</div>
                                <div style="color: var(--text-muted); font-size: 0.9rem;">${reward.desc || ''}</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="btn-main" style="background: #555;" onclick="editReward(${reward.id})">
                                <i class="fas fa-edit"></i> Bearbeiten
                            </button>
                            <button class="btn-main" style="background: var(--danger);" onclick="deleteReward(${reward.id})">
                                <i class="fas fa-trash"></i> Löschen
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        async function addRewardWithIcon() {
            const name = document.getElementById('reward-name').value;
            const cost = parseInt(document.getElementById('reward-cost').value);
            const iconInput = document.getElementById('reward-icon').value;
            const desc = document.getElementById('reward-desc').value;

            if (!name || isNaN(cost) || cost <= 0) {
                Swal.fire('Fehler', 'Bitte alle Pflichtfelder ausfüllen!', 'error');
                return;
            }

            // Icon formatieren
            const icon = iconInput ? `<i class="fas ${iconInput.startsWith('fa-') ? iconInput : 'fa-' + iconInput}"></i>` : REWARD_ICONS['default'];

            const newId = db.rewards.length > 0 ? Math.max(...db.rewards.map(r => r.id)) + 1 : 1;
            db.rewards.push({ id: newId, name, cost, desc: desc || 'Prämie', icon });
            db.rewards.sort((a, b) => a.cost - b.cost);

            // Clear inputs
            document.getElementById('reward-name').value = '';
            document.getElementById('reward-cost').value = '';
            document.getElementById('reward-icon').value = '';
            document.getElementById('reward-desc').value = '';

            await save();
            renderAdminRewardList();
            Swal.fire('Erfolg!', `Prämie "${name}" erstellt.`, 'success');
        }

        async function editReward(id) {
            const reward = db.rewards.find(r => r.id === id);
            if (!reward) return;

            // Extract icon class from HTML if present
            const iconMatch = reward.icon ? reward.icon.match(/fa-[\w-]+/) : null;
            const iconClass = iconMatch ? iconMatch[0] : '';

            const { value: formValues } = await Swal.fire({
                title: 'Prämie bearbeiten',
                html: `
                    <input id="edit-name" type="text" class="swal2-input" value="${reward.name}" placeholder="Name">
                    <input id="edit-cost" type="number" class="swal2-input" value="${reward.cost}" placeholder="Kosten">
                    <input id="edit-icon" type="text" class="swal2-input" value="${iconClass}" placeholder="Icon (z.B. fa-star)">
                    <input id="edit-desc" type="text" class="swal2-input" value="${reward.desc || ''}" placeholder="Beschreibung">
                `,
                showCancelButton: true,
                background: '#1a1a1a',
                color: '#fff',
                preConfirm: () => ({
                    name: document.getElementById('edit-name').value,
                    cost: parseInt(document.getElementById('edit-cost').value),
                    icon: document.getElementById('edit-icon').value,
                    desc: document.getElementById('edit-desc').value
                })
            });

            if (formValues) {
                const iconFormatted = formValues.icon ? `<i class="fas ${formValues.icon.startsWith('fa-') ? formValues.icon : 'fa-' + formValues.icon}"></i>` : REWARD_ICONS['default'];
                const rewardIndex = db.rewards.findIndex(r => r.id === id);
                db.rewards[rewardIndex] = {
                    id: id,
                    name: formValues.name,
                    cost: formValues.cost,
                    desc: formValues.desc,
                    icon: iconFormatted
                };
                db.rewards.sort((a, b) => a.cost - b.cost);
                await save();
                renderAdminRewardList();
                Swal.fire('Gespeichert!', 'Prämie aktualisiert.', 'success');
            }
        }

        async function deleteReward(id) {
            const reward = db.rewards.find(r => r.id === id);
            if (!reward) return;

            const { isConfirmed } = await Swal.fire({
                title: `"${reward.name}" löschen?`,
                text: 'Diese Aktion kann nicht rückgängig gemacht werden!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ja, löschen',
                confirmButtonColor: 'var(--danger)',
                background: '#1a1a1a',
                color: '#fff'
            });

            if (isConfirmed) {
                db.rewards = db.rewards.filter(r => r.id !== id);
                await save();
                renderAdminRewardList();
                Swal.fire('Gelöscht!', 'Prämie entfernt.', 'success');
            }
        }

        // OLD rendering functions - kept for compatibility
        function renderRewardList() {
            renderAdminRewardList();
        }

        function addReward() {
            addRewardWithIcon();
        }

        // Admin Passwort speichern
        async function saveAdminPass() {
            const newPass = document.getElementById('admin-pass').value;
            const confirmPass = document.getElementById('admin-pass-confirm').value;

            if (newPass !== confirmPass) {
                Swal.fire('Fehler', 'Die Passwörter stimmen nicht überein.', 'error');
                return;
            }

            if (newPass.length >= 4) {
                db.users['Admin'].password = newPass;
                document.getElementById('admin-pass').value = '';
                document.getElementById('admin-pass-confirm').value = '';
                await save();
                Swal.fire('Erfolg', 'Admin-Passwort wurde aktualisiert.', 'success');
            } else {
                Swal.fire('Fehler', 'Passwort muss mindestens 4 Zeichen lang sein.', 'error');
            }
        }

        // NEU: Super-Lob setzen
        async function setAdminSuperLobs() {
            const SUPER_LOBS = 999999;
            db.users['Admin'].adminLobs = SUPER_LOBS;
            await save();
            renderAdmin();
            Swal.fire({ icon: 'success', title: 'Unendlich Lobs gesetzt', text: `Admin hat nun ${SUPER_LOBS.toLocaleString()} Lobs zum Testen (wird nicht im Leaderboard angezeigt).`, background: '#1a1a1a', color: '#fff', timer: 2500, showConfirmButton: false });
        }

        // NEU: Admin-Funktion um User-zu-User Lob zu simulieren
        async function adminSendUserLob() {
            const normalUsers = Object.keys(db.users).filter(u => u !== 'Admin');

            const { value: formValues } = await Swal.fire({
                title: 'User Lob simulieren',
                html: `
                <select id="swal-sender" class="swal2-input">
                    <option value="">-- Wähle Sender --</option>
                    ${normalUsers.map(u => `<option value="${u}">${u}</option>`).join('')}
                </select>
                <select id="swal-receiver" class="swal2-input">
                    <option value="">-- Wähle Empfänger --</option>
                    ${normalUsers.map(u => `<option value="${u}">${u}</option>`).join('')}
                </select>
                <input id="swal-amount" type="number" class="swal2-input" placeholder="Anzahl Lobs" min="1" value="1">
            `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Lob senden',
                background: '#1a1a1a', color: '#fff',
                preConfirm: () => {
                    const sender = document.getElementById('swal-sender').value;
                    const receiver = document.getElementById('swal-receiver').value;
                    const amount = parseInt(document.getElementById('swal-amount').value);

                    if (!sender || !receiver) {
                        Swal.showValidationMessage('Sender und Empfänger müssen ausgewählt werden');
                        return false;
                    }
                    if (sender === receiver) {
                        Swal.showValidationMessage('Sender und Empfänger dürfen nicht gleich sein');
                        return false;
                    }
                    if (isNaN(amount) || amount <= 0) {
                        Swal.showValidationMessage('Anzahl muss eine positive Zahl sein');
                        return false;
                    }
                    return { sender, receiver, amount };
                }
            });

            if (formValues) {
                const { sender, receiver, amount } = formValues;

                // Lob hinzufügen
                db.users[receiver].received[sender] = (db.users[receiver].received[sender] || 0) + amount;

                // Log erstellen
                db.logs.unshift({
                    id: Date.now(),
                    time: new Date().toLocaleString(),
                    msg: `${sender} lobt ${receiver} mit ${amount} Punkten. (ADMIN-SIMULIERT) (LOB)`,
                    sender: sender,
                    receiver: receiver,
                    amount: amount
                });

                await save();
                renderAdmin();

                Swal.fire({
                    title: 'Erfolgreich',
                    text: `${sender} hat ${receiver} ${amount} Lobs gegeben.`,
                    icon: 'success',
                    background: '#1a1a1a', color: '#fff',
                    confirmButtonColor: '#ff4d6d'
                });
            }
        }

        // --- USER-VERWALTUNG (Admin Tab) ---
        function renderUserAdmin() {
            const container = document.getElementById('admin-user-management');

            let userListHtml = '';
            for (const [name, user] of Object.entries(db.users)) {
                if (name === 'Admin' || name === 'TestUser') continue;
                userListHtml += `
                    <div class="admin-user-card" style="background:var(--bg); padding:15px; border-radius:8px; margin-bottom:10px; border:1px solid var(--border);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="display:flex; align-items:center;">
                                <img src="${user.image}" style="width:40px; height:40px; border-radius:50%; margin-right:10px;">
                                <div>
                                    <strong>${name}</strong><br>
                                    <span style="font-size:0.8rem; color:#888;">Passwort: ${user.password}</span>
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:bold; color:var(--accent);">${calculateBalance(name)} Chips</div>
                                <div style="font-size:0.8rem;">${calculateLobs(name)} Lobs</div>
                            </div>
                        </div>
                        <div style="margin-top:10px; display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
                            <button onclick="editUserImage('${name}')" style="padding:8px; background:var(--card-bg); border:1px solid var(--border); border-radius:4px; color:var(--text); cursor:pointer; font-size:0.8rem;"><i class="fas fa-image"></i> Bild</button>
                            <button onclick="editUsername('${name}')" style="padding:8px; background:var(--card-bg); border:1px solid var(--border); border-radius:4px; color:var(--text); cursor:pointer; font-size:0.8rem;"><i class="fas fa-signature"></i> Name</button>
                            <button onclick="adminChangePassword('${name}')" style="padding:8px; background:var(--card-bg); border:1px solid var(--border); border-radius:4px; color:var(--text); cursor:pointer; font-size:0.8rem;"><i class="fas fa-key"></i> PW</button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = `
                <div style="display:flex; align-items:center; margin-bottom:20px;">
                    <h3>Benutzerverwaltung</h3>
                </div>
                
                <button onclick="adminSendUserLob()" style="width:100%; padding:12px; background:var(--accent); color:white; border:none; border-radius:8px; cursor:pointer; margin-bottom: 20px; font-weight:bold;">
                    <i class="fas fa-exchange-alt"></i> Lob Simulieren
                </button>

                <div id="user-list">
                    ${userListHtml}
                </div>
            `;
        }

        // Placeholder functions for admin user management
        async function adminEditUser(username) {
            // This function would open a detailed edit modal/view for the user
            // For now, let's just show a placeholder alert
            Swal.fire({
                title: `Benutzer ${username} bearbeiten`,
                text: 'Hier würden detaillierte Bearbeitungsoptionen für den Benutzer erscheinen.',
                icon: 'info',
                background: '#1a1a1a', color: '#fff'
            });
        }

        async function adminChangePassword(username) {
            const { value: newPass } = await Swal.fire({
                title: `Passwort für ${username} ändern`,
                input: 'text',
                inputPlaceholder: 'Neues Passwort eingeben',
                showCancelButton: true,
                background: '#1a1a1a', color: '#fff'
            });

            if (newPass) {
                if (newPass.length < 4) {
                    Swal.fire('Fehler', 'Passwort muss mindestens 4 Zeichen lang sein.', 'error');
                    return;
                }
                db.users[username].password = newPass;
                await save();
                renderUserAdmin();
                Swal.fire('Erfolg', `Passwort für ${username} wurde geändert.`, 'success');
            }
        }

        async function simulateLob() {
            // This function is similar to adminSendUserLob but might have different options
            // For now, let's reuse adminSendUserLob
            adminSendUserLob();
        }

        async function editUserImage(username) {
            const { value: url } = await Swal.fire({
                title: `Profilbild für ${username}`,
                input: 'text',
                inputValue: db.users[username].image,
                inputPlaceholder: 'Bild-URL eingeben',
                showCancelButton: true,
                background: '#1a1a1a',
                color: '#fff'
            });

            if (url) {
                db.users[username].image = url;
                await save();
                renderUserAdmin();
                Swal.fire('Gespeichert!', 'Profilbild aktualisiert.', 'success');
            }
        }

        async function editUsername(oldName) {
            const { value: newName } = await Swal.fire({
                title: `Name ändern für ${oldName}`,
                input: 'text',
                inputValue: oldName,
                inputPlaceholder: 'Neuer Name',
                showCancelButton: true,
                background: '#1a1a1a',
                color: '#fff'
            });

            if (newName && newName !== oldName) {
                if (db.users[newName]) {
                    Swal.fire('Fehler', 'Name bereits vergeben.', 'error');
                    return;
                }

                // Copy user data to new key
                db.users[newName] = db.users[oldName];
                delete db.users[oldName];

                // Update logs
                db.logs.forEach(log => {
                    if (log.sender === oldName) log.sender = newName;
                    if (log.receiver === oldName) log.receiver = newName;
                    log.msg = log.msg.replace(oldName, newName);
                });

                // Update received references in other users
                Object.values(db.users).forEach(u => {
                    if (u.received && u.received[oldName]) {
                        u.received[newName] = u.received[oldName];
                        delete u.received[oldName];
                    }
                });

                await save();
                renderUserAdmin();
                Swal.fire('Gespeichert!', `User umbenannt in ${newName}.`, 'success');
            }
        }

        async function editUserLobs(username) {
            const user = db.users[username];
            const sources = Object.keys(user.received);

            // Add potential sources
            const allUsers = Object.keys(db.users).filter(u => u !== 'Admin' && u !== 'TestUser' && u !== username);
            allUsers.push('Admin');
            allUsers.push('Casino');

            const uniqueSources = [...new Set([...sources, ...allUsers])];

            // Generate Options
            let options = uniqueSources.map(s => `<option value="${s}">${s} (Aktuell: ${user.received[s] || 0})</option>`).join('');

            const { value: formValues } = await Swal.fire({
                title: `Lobs für ${username} bearbeiten`,
                html: `
                    <p style="font-size:0.9rem; color:#ccc; margin-bottom:15px;">Wähle das Konto aus, von dem die Lobs kommen sollen.</p>
                    <select id="swal-lob-source" class="swal2-input" style="margin-bottom:15px; background:#333; color:white; border:1px solid #555;">
                        ${options}
                    </select>
                    <input id="swal-lob-amount" type="number" class="swal2-input" placeholder="Neue Anzahl" style="background:#333; color:white; border:1px solid #555;">
                `,
                focusConfirm: false,
                background: '#1a1a1a', color: '#fff',
                preConfirm: () => {
                    return [
                        document.getElementById('swal-lob-source').value,
                        document.getElementById('swal-lob-amount').value
                    ]
                }
            });

            if (formValues) {
                const [source, amount] = formValues;
                if (source && amount !== '') {
                    const val = parseInt(amount);
                    if (val <= 0) {
                        delete db.users[username].received[source];
                    } else {
                        db.users[username].received[source] = val;
                    }
                    await save();
                    renderUserAdmin();
                    Swal.fire('Gespeichert', `${username} hat nun ${val} Lobs von ${source}.`, 'success');
                }
            }
        }

        function renderAdminDashboard() {
            const container = document.getElementById('admin-content');
            container.innerHTML = `
                <h3>Admin Dashboard</h3>
                <div class="admin-grid">
                    <div class="admin-card" onclick="renderUserAdmin()">
                        <h4>Benutzer verwalten</h4>
                        <p>Passwörter, Guthaben, Badges</p>
                    </div>
                    <div class="admin-card" onclick="renderAdminCasinoSettings()">
                        <h4>Casino Einstellungen</h4>
                        <p>Wechselkurse, Kosten, Limits</p>
                    </div>
                    <div class="admin-card" onclick="renderLogAdmin()">
                        <h4>Logs einsehen</h4>
                        <p>Transaktionen und Aktivitäten</p>
                    </div>
                </div>
            `;
        }

        function renderAdminCasinoSettings() {
            const container = document.getElementById('admin-content');

            // Ensure settings exist
            if (!db.appSettings) db.appSettings = {};
            if (!db.appSettings.exchangeRate) db.appSettings.exchangeRate = 10;
            if (!db.appSettings.blackjackCost) db.appSettings.blackjackCost = 10;
            if (!db.appSettings.rouletteCost) db.appSettings.rouletteCost = 10;
            if (!db.appSettings.slotsCost) db.appSettings.slotsCost = 10;
            if (!db.appSettings.coinFlipCost) db.appSettings.coinFlipCost = 10;

            container.innerHTML = `
                <div style="display:flex; align-items:center; margin-bottom:20px;">
                    <button onclick="renderAdminDashboard()" style="background:none; border:none; color:var(--text); font-size:1.5rem; cursor:pointer; margin-right:10px;">←</button>
                    <h3>Casino Einstellungen</h3>
                </div>
                
                <div class="settings-form" style="background:var(--card-bg); padding:20px; border-radius:12px; border:1px solid var(--border);">
                    <div style="margin-bottom:15px;">
                        <label style="display:block; margin-bottom:5px;">Wechselkurs (Chips pro 1 Lob)</label>
                        <input type="number" id="setting-exchange" value="${db.appSettings.exchangeRate}" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                    </div>
                    
                    <h4 style="margin-top:20px; margin-bottom:10px; border-bottom:1px solid var(--border); padding-bottom:5px;">Spielkosten (Mindesteinsatz)</h4>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                        <div>
                            <label style="display:block; margin-bottom:5px;">Blackjack</label>
                            <input type="number" id="setting-bj" value="${db.appSettings.blackjackCost}" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                        </div>
                        <div>
                            <label style="display:block; margin-bottom:5px;">Roulette</label>
                            <input type="number" id="setting-roulette" value="${db.appSettings.rouletteCost}" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                        </div>
                        <div>
                            <label style="display:block; margin-bottom:5px;">Slots</label>
                            <input type="number" id="setting-slots" value="${db.appSettings.slotsCost}" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                        </div>
                        <div>
                            <label style="display:block; margin-bottom:5px;">Coin Flip</label>
                            <input type="number" id="setting-coin" value="${db.appSettings.coinFlipCost}" style="width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); background:var(--bg); color:var(--text);">
                        </div>
                    </div>

                    <button onclick="saveCasinoSettings()" style="margin-top:20px; width:100%; padding:12px; background:var(--accent); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Speichern</button>
                </div>
            `;
        }

        async function saveCasinoSettings() {
            const newExchange = parseInt(document.getElementById('setting-exchange').value);
            const newBj = parseInt(document.getElementById('setting-bj').value);
            const newRoulette = parseInt(document.getElementById('setting-roulette').value);
            const newSlots = parseInt(document.getElementById('setting-slots').value);
            const newCoin = parseInt(document.getElementById('setting-coin').value);

            if (isNaN(newExchange) || isNaN(newBj) || isNaN(newRoulette) || isNaN(newSlots) || isNaN(newCoin)) {
                Swal.fire('Fehler', 'Bitte gültige Zahlen eingeben.', 'error');
                return;
            }

            db.appSettings.exchangeRate = newExchange;
            db.appSettings.blackjackCost = newBj;
            db.appSettings.rouletteCost = newRoulette;
            db.appSettings.slotsCost = newSlots;
            db.appSettings.coinFlipCost = newCoin;

            await save();
            Swal.fire('Gespeichert', 'Einstellungen wurden aktualisiert.', 'success');
        }

        // NEU: Casino Settings
        async function openCasinoSettings() {
            if (!db.appSettings) db.appSettings = {};
            if (!db.appSettings.casino) db.appSettings.casino = { exchangeRate: 10, blackjackCost: 1 };

            const { value: formValues } = await Swal.fire({
                title: 'Casino Einstellungen',
                html: `
                    <label style="display:block; text-align:left; margin-bottom:5px;">Wechselkurs (1 Lob = X Chips)</label>
                    <input id="swal-casino-rate" type="number" class="swal2-input" value="${db.appSettings.casino.exchangeRate}" style="margin-bottom:15px; background:#333; color:white; border:1px solid #555;">
                    <label style="display:block; text-align:left; margin-bottom:5px;">Blackjack Einsatz (Chips)</label>
                    <input id="swal-casino-bj-cost" type="number" class="swal2-input" value="${db.appSettings.casino.blackjackCost}" style="background:#333; color:white; border:1px solid #555;">
                `,
                focusConfirm: false,
                background: '#1a1a1a', color: '#fff',
                preConfirm: () => {
                    return [
                        document.getElementById('swal-casino-rate').value,
                        document.getElementById('swal-casino-bj-cost').value
                    ]
                }
            });

            if (formValues) {
                db.appSettings.casino.exchangeRate = parseInt(formValues[0]);
                db.appSettings.casino.blackjackCost = parseInt(formValues[1]);
                await save();
                Swal.fire('Gespeichert', 'Casino Einstellungen aktualisiert.', 'success');
            }
        }

        async function deleteUser(username) {
            const { isConfirmed } = await Swal.fire({
                title: `${username} wirklich löschen?`,
                text: 'Diese Aktion kann nicht rückgängig gemacht werden!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ja, löschen',
                cancelButtonText: 'Abbrechen',
                confirmButtonColor: 'var(--danger)',
                background: '#1a1a1a',
                color: '#fff'
            });

            if (isConfirmed) {
                delete db.users[username];
                await save();
                renderUserAdmin();
                Swal.fire('Gelöscht!', `${username} wurde entfernt.`, 'success');
            }
        }

        // --- BADGE-VERWALTUNG (Admin Tab) ---
        function renderBadgeAdmin() {
            const container = document.getElementById('badge-list');
            container.innerHTML = '';

            if (!db.badgeDefinitions || db.badgeDefinitions.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">Keine Badges definiert.</div>';
                return;
            }

            db.badgeDefinitions.forEach((badge, index) => {
                // Badge-Icon oder Bild
                let badgeVisual;
                if (badge.image) {
                    badgeVisual = `<img src="${badge.image}" style="width:60px; height:60px; border-radius:50%; object-fit:cover;">`;
                } else {
                    badgeVisual = `<i class="fas ${badge.icon}"></i>`;
                }

                container.innerHTML += `
                    <div class="settings-card" style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                            <div style="font-size: 2.5rem; color: ${badge.color};">${badgeVisual}</div>
                            <div style="flex-grow:1;">
                                <h4 style="margin:0; color: ${badge.color};">${badge.name}</h4>
                                <div style="color: var(--text-muted); font-size: 0.9rem;">${badge.threshold} Lobs - ${badge.desc}</div>
                                ${badge.image ? '<div style="font-size:0.8rem; color:#888;">🖼️ Bild-Badge</div>' : '<div style="font-size:0.8rem; color:#888;">🎯 Icon-Badge</div>'}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button class="btn-main" style="background: #555;" onclick="editBadge(${index})">
                                <i class="fas fa-edit"></i> Bearbeiten
                            </button>
                            <button class="btn-main" style="background: var(--danger);" onclick="deleteBadge(${index})">
                                <i class="fas fa-trash"></i> Löschen
                            </button>
                        </div>
                    </div>
                `;
            });
        }

        async function addBadge() {
            const name = document.getElementById('badge-name').value;
            const threshold = parseInt(document.getElementById('badge-threshold').value);
            const iconInput = document.getElementById('badge-icon').value;
            const imageInput = document.getElementById('badge-image').value;
            const color = document.getElementById('badge-color').value;
            const desc = document.getElementById('badge-desc').value;

            if (!name || isNaN(threshold) || !desc) {
                Swal.fire('Fehler', 'Bitte Name, Schwelle und Beschreibung ausfüllen!', 'error');
                return;
            }

            if (!iconInput && !imageInput) {
                Swal.fire('Fehler', 'Bitte entweder ein Icon oder eine Bild-URL angeben!', 'error');
                return;
            }

            const newBadge = { name, threshold, color, desc };

            // Entscheide zwischen Icon und Bild
            if (imageInput) {
                newBadge.image = imageInput;
                newBadge.icon = 'fa-award'; // Fallback-Icon
            } else {
                newBadge.icon = iconInput.startsWith('fa-') ? iconInput : `fa-${iconInput}`;
            }

            db.badgeDefinitions.push(newBadge);
            db.badgeDefinitions.sort((a, b) => a.threshold - b.threshold);

            // Clear inputs
            document.getElementById('badge-name').value = '';
            document.getElementById('badge-threshold').value = '';
            document.getElementById('badge-icon').value = '';
            document.getElementById('badge-image').value = '';
            document.getElementById('badge-desc').value = '';

            await save();
            renderBadgeAdmin();
            Swal.fire('Erfolg!', `Badge "${name}" erstellt.`, 'success');
        }

        async function editBadge(index) {
            const badge = db.badgeDefinitions[index];

            const { value: formValues } = await Swal.fire({
                title: 'Badge bearbeiten',
                html: `
                    <input id="edit-name" type="text" class="swal2-input" value="${badge.name}" placeholder="Name">
                    <input id="edit-threshold" type="number" class="swal2-input" value="${badge.threshold}" placeholder="Lobs">
                    <input id="edit-icon" type="text" class="swal2-input" value="${badge.icon || ''}" placeholder="Icon (z.B. fa-star)">
                    <input id="edit-image" type="text" class="swal2-input" value="${badge.image || ''}" placeholder="Bild-URL (statt Icon)">
                    <input id="edit-color" type="color" class="swal2-input" value="${badge.color}" style="height:50px;">
                    <input id="edit-desc" type="text" class="swal2-input" value="${badge.desc}" placeholder="Beschreibung">
                `,
                showCancelButton: true,
                background: '#1a1a1a',
                color: '#fff',
                preConfirm: () => ({
                    name: document.getElementById('edit-name').value,
                    threshold: parseInt(document.getElementById('edit-threshold').value),
                    icon: document.getElementById('edit-icon').value,
                    image: document.getElementById('edit-image').value,
                    color: document.getElementById('edit-color').value,
                    desc: document.getElementById('edit-desc').value
                })
            });

            if (formValues) {
                const updatedBadge = {
                    name: formValues.name,
                    threshold: formValues.threshold,
                    color: formValues.color,
                    desc: formValues.desc
                };

                // Entscheide zwischen Icon und Bild
                if (formValues.image) {
                    updatedBadge.image = formValues.image;
                    updatedBadge.icon = formValues.icon || 'fa-award'; // Fallback
                } else {
                    updatedBadge.icon = formValues.icon.startsWith('fa-') ? formValues.icon : `fa-${formValues.icon}`;
                }

                db.badgeDefinitions[index] = updatedBadge;
                db.badgeDefinitions.sort((a, b) => a.threshold - b.threshold);
                await save();
                renderBadgeAdmin();
                Swal.fire('Gespeichert!', 'Badge aktualisiert.', 'success');
            }
        }

        async function deleteBadge(index) {
            const badge = db.badgeDefinitions[index];
            const { isConfirmed } = await Swal.fire({
                title: `"${badge.name}" löschen?`,
                text: 'Diese Aktion kann nicht rückgängig gemacht werden!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ja, löschen',
                confirmButtonColor: 'var(--danger)',
                background: '#1a1a1a',
                color: '#fff'
            });

            if (isConfirmed) {
                db.badgeDefinitions.splice(index, 1);
                await save();
                renderBadgeAdmin();
                Swal.fire('Gelöscht!', `Badge entfernt.`, 'success');
            }
        }

        // Admin Logik für das Protokoll
        function setLogFilter(filter) {
            currentLogFilter = filter;
            document.querySelectorAll('.admin-filter-bar button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${filter.toLowerCase()}`).classList.add('active');
            renderLogList();
        }

        function renderLogList() {
            const logDiv = document.getElementById('log-list');
            logDiv.innerHTML = '';

            const filteredLogs = db.logs.filter(log => {
                if (currentLogFilter === 'ALL') return true;
                if (currentLogFilter === 'CASINO') return log.msg.includes('(CASINO)'); // Explicit check
                return log.msg.includes(`(${currentLogFilter})`);
            });

            if (filteredLogs.length === 0) {
                logDiv.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding: 20px;">Keine Logs für diesen Filter.</div>`;
                return;
            }

            filteredLogs.forEach(log => {
                const isLob = log.msg.includes('(LOB)');
                const logId = log.id;

                logDiv.innerHTML += `
                <div class="log-entry">
                    <div class="log-content">
                        <span style="color:var(--text-muted); font-size: 0.7rem;">${log.time}</span><br>
                        ${log.msg.replace(/\(LOB\)/g, '').replace(/\(REWARD\)/g, '').replace(/\(ADMIN\)/g, '').trim()}
                    </div>
                    ${isLob ? `<button class="btn-delete-log" onclick="adminWithdrawLob(${logId})">Rückzug</button>` : ''}
                </div>
            `;
            });
        }

        // NEU: Funktion zum Rückziehen des Lobs
        async function adminWithdrawLob(logId) {
            const logEntry = db.logs.find(l => l.id == logId);

            if (!logEntry || !logEntry.sender || !logEntry.receiver || typeof logEntry.amount === 'undefined') {
                Swal.fire('Fehler', 'Log-Eintrag kann nicht zurückgezogen werden (fehlende Daten).', 'error');
                return;
            }

            const { isConfirmed } = await Swal.fire({
                title: 'Lob Rückzug bestätigen',
                text: `Soll Lob von ${logEntry.sender} an ${logEntry.receiver} in Höhe von ${logEntry.amount} Punkten wirklich zurückgezogen werden?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'JA, zurückziehen',
                confirmButtonColor: 'var(--danger)',
                cancelButtonText: 'Abbrechen'
            });

            if (isConfirmed) {

                // 1. Punkte zurückbuchen 
                // Wichtig: Der Empfänger hat Lob von "Admin" oder vom eigentlichen "currentUser" erhalten.
                const senderKey = logEntry.sender === 'Admin' ? 'Admin' : logEntry.sender;

                if (logEntry.receiver !== 'Admin' && db.users[logEntry.receiver].received[senderKey]) {
                    const currentScore = db.users[logEntry.receiver].received[senderKey] || 0;
                    const newScore = Math.max(0, currentScore - logEntry.amount);
                    db.users[logEntry.receiver].received[senderKey] = newScore;
                }

                // 2. Log löschen
                db.logs = db.logs.filter(l => l.id !== logId);

                // 3. Neuen Log-Eintrag hinzufügen
                db.logs.unshift({
                    id: Date.now(),
                    time: new Date().toLocaleString(),
                    msg: `ADMIN zog ${logEntry.amount} Lobs von ${logEntry.sender} an ${logEntry.receiver} zurück. (ADMIN)`
                });

                await save();
                renderAdmin(); // Admin Ansicht aktualisieren

                Swal.fire('Erfolgreich', 'Lob wurde zurückgezogen und Log gelöscht.', 'success');
            }
        }


        function fireConfetti(count) {
            confetti({
                particleCount: count,
                startVelocity: 30,
                spread: 360,
                angle: 90,
                zIndex: 100,
                origin: { x: 0.5, y: 0.6 }
            });
        }

        // Activity Notification Logic
        let lastLogCount = 0;
        let lastUserDataSnapshot = null;

        let lastLogId = 0;

        function startActivityPolling() {
            // Initial count and ID
            if (db.logs && db.logs.length > 0) {
                lastLogCount = db.logs.length;
                lastLogId = db.logs[0].id;
            }

            if (currentUser && db.users[currentUser]) {
                lastUserDataSnapshot = JSON.parse(JSON.stringify(db.users[currentUser]));
            }

            setInterval(async () => {
                try {
                    // Silent fetch to check for updates
                    const response = await fetch('/db');
                    const data = await response.json();

                    // 1. Check for general log updates (for the bottom notification)
                    if (data.logs && data.logs.length > lastLogCount) {
                        lastLogCount = data.logs.length;
                        showActivityNotification();
                    }

                    // 2. Check for User Specific Notifications (if logged in and enabled)
                    if (currentUser && data.users[currentUser] && data.users[currentUser].settings && data.users[currentUser].settings.mobileNotifications) {
                        const newUser = data.users[currentUser];
                        const oldUser = lastUserDataSnapshot || newUser; // Fallback if first run

                        // Check for new Lobs (Received count increased)
                        const oldReceived = Object.values(oldUser.received || {}).reduce((a, b) => a + b, 0);
                        const newReceived = Object.values(newUser.received || {}).reduce((a, b) => a + b, 0);

                        if (newReceived > oldReceived) {
                            // Find out who sent it?
                            // We can check the diff in received object
                            let sender = 'Jemand';
                            for (const [s, amount] of Object.entries(newUser.received)) {
                                if (amount > (oldUser.received[s] || 0)) {
                                    sender = s;
                                    break;
                                }
                            }
                            showToast('Du wurdest gelobt!', `${sender} hat dir ein Lob gegeben!`, 'success');
                        }

                        // Check for Sports Bet Results (Status changed to won/lost)
                        if (newUser.sportsBets && oldUser.sportsBets) {
                            newUser.sportsBets.forEach(newBet => {
                                const oldBet = oldUser.sportsBets.find(b => b.id === newBet.id);
                                if (oldBet && oldBet.status === 'open' && newBet.status !== 'open') {
                                    if (newBet.status === 'won') {
                                        showToast('Wette Gewonnen!', `Du hast ${Math.floor(newBet.amount * newBet.odds)} Chips gewonnen!`, 'success');
                                    } else if (newBet.status === 'lost') {
                                        showToast('Wette Verloren', 'Leider kein Glück gehabt.', 'info');
                                    }
                                }
                            });
                        }

                        // Check for Rewards/Premiums via Logs (using lastLogId)
                        if (data.logs && data.logs.length > 0) {
                            // Filter for new logs
                            const newLogs = data.logs.filter(l => l.id > lastLogId);

                            if (newLogs.length > 0) {
                                // Update max ID seen
                                const maxId = Math.max(...newLogs.map(l => l.id));
                                if (maxId > lastLogId) lastLogId = maxId;

                                newLogs.forEach(log => {
                                    // Check if this log is relevant for rewards/premiums for THIS user
                                    if (log.msg.includes(currentUser)) {
                                        if (log.msg.includes('kauft') || log.msg.includes('löst')) {
                                            showToast('Prämie eingelöst', log.msg, 'info');
                                        }
                                    }
                                });
                            }
                        }

                        // Update snapshot
                        lastUserDataSnapshot = JSON.parse(JSON.stringify(newUser));
                    } else {
                        // Even if notifications are off, we must update snapshot and log ID to avoid stale alerts when turned on
                        if (data.users && data.users[currentUser]) {
                            lastUserDataSnapshot = JSON.parse(JSON.stringify(data.users[currentUser]));
                        }
                        if (data.logs && data.logs.length > 0) {
                            if (data.logs[0].id > lastLogId) lastLogId = data.logs[0].id;
                        }
                    }

                    // Update local db silently to keep state fresh? 
                    // No, that might cause UI jumps. We only notify.
                    // But for the snapshot comparison to work next time, we need the *new* data to be the *old* data.
                    // We did that with lastUserDataSnapshot = newUser.

                } catch (e) {
                    // Ignore errors in background polling
                }
            }, 5000);
        }

        async function toggleMobileNotifications(enabled) {
            if (!db.users[currentUser].settings) db.users[currentUser].settings = {};
            db.users[currentUser].settings.mobileNotifications = enabled;
            await save();
            if (enabled) {
                Swal.fire({
                    toast: true, position: 'top', icon: 'success', title: 'Benachrichtigungen aktiviert', showConfirmButton: false, timer: 2000
                });
            }
        }

        function showToast(title, text, icon = 'info') {
            Swal.fire({
                toast: true,
                position: 'top',
                icon: icon,
                title: title,
                text: text,
                showConfirmButton: false,
                timer: 4000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer)
                    toast.addEventListener('mouseleave', Swal.resumeTimer)
                }
            });
        }

        function showActivityNotification() {
            // Create notification element if not exists
            let notif = document.getElementById('activity-notification');
            if (!notif) {
                notif = document.createElement('div');
                notif.id = 'activity-notification';
                notif.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: var(--accent);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 20px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    cursor: pointer;
                    z-index: 10000;
                    font-size: 0.9rem;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    animation: slideUp 0.3s ease-out;
                `;
                notif.innerHTML = `
                    <span>Neue Aktivität verfügbar</span>
                    <span style="background:rgba(255,255,255,0.2); padding:2px 6px; border-radius:10px; font-size:0.8rem;">↻</span>
                `;
                notif.onclick = () => {
                    location.reload();
                };
                document.body.appendChild(notif);

                // Add keyframes for animation
                const style = document.createElement('style');
                style.innerHTML = `
                    @keyframes slideUp {
                        from { transform: translate(-50%, 100%); opacity: 0; }
                        to { transform: translate(-50%, 0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            } else {
                notif.style.display = 'flex';
            }
        }

        // Start
        init();
        startActivityPolling();

    </script>
</body>

</html>
